//----------------------------------------------------
// Copyright (c) 2014, SHENZHEN PENGRUI SOFT CO LTD. All rights reserved.

// Redistribution and use in source and binary forms, with or without
// modification, are permitted provided that the following conditions are met:

// 1. Redistributions of source code must retain the above copyright notice,
//    this list of conditions and the following disclaimer.
// 2. Redistributions in binary form must reproduce the above copyright notice,
//    this list of conditions and the following disclaimer in the documentation
//    and/or other materials provided with the distribution.

// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
// AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
// ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
// LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
// CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
// SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
// INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
// CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
// ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
// POSSIBILITY OF SUCH DAMAGE.
//-----------------------------------------------------------------------------
// Copyright (c) 2014 闂傚倸鍊搁崐鐑芥倿閿曞倸鍨傛繝闈涱儐閸婂潡鏌ㄩ弴鐐测偓鍛婎攰闂備胶绮崝妤呭极閸濄儳鐭嗗┑鐘叉处閻撴盯鏌涢幇鈺佸濠⒀勬礈缁辨帡鎮▎蹇斿闁绘挻娲熼弻鐔煎级閸喗鍊庣紓浣靛妼閵堟悂寮婚敓鐘插耿婵炲棗璀﹂敐鍥╃＜缂備焦顭囧ú鎾煛娴ｇ懓濮嶇�规洏鍔戦、姗�鍨惧畷鍥у箣婵犵數濮烽弫鍛婂垔閹绢喖绠柣鎴ｅГ閳锋垿鏌涢…鎴濇珮闁稿骸绉归弻娑氣偓锝庝簼閸ゅ洭鏌ｉ幙鍐ㄤ喊鐎规洖鐖兼俊鎼佹晜缂併垺袨闂傚倷绀侀幗婊勬叏閻㈢绠查柛銉戝苯娈ㄩ梺鍓插亝濞叉﹢宕愭繝姘厱闁斥晛鍠氬▓妯好归悩娆忓暊閺�浠嬫煟閹邦剙绾фい銉︽崌閺屾盯濡搁妸锔绘濡炪倖娲╃紞浣哥暦瑜版帩鏁冮柕蹇嬪灮閻涱噣姊绘担鍝ョШ闁稿锕畷锝嗘償閵婏附娅㈤梺鍏间航閸庢娊骞婇崶顒佺厸閻忕偛澧介‖鑲╃磼閻樺磭娲撮柡浣瑰姍瀹曘劑顢樿娴溿倝姊虹拠鏌ヮ�楅柣蹇旇壘椤灝顫滈埀顒�鐣烽鐐茬妞ゆ梹鍎崇粊锕傛倵楠炲灝鍔氭い锔垮嵆瀵尙绮欏Λ闈涚秺閹晛顔忛鐓庡闂佽瀛╅懝楣兯囬鐐┾偓锔炬崉閵婏箑纾梺鎯х箳閹虫捇鍩涙繝鍥ㄢ拺鐟滅増甯╁Λ鎴︽煕韫囨枂顏堟偩閻戣棄绠抽柟瀛樻⒐閺傗偓闂備焦鎮堕崕婊堝礋椤掑倹袠婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌涢幘妤�鍟悘濠囨倵楠炲灝鍔氶柟宄邦儔閹偞绂掔�ｎ偆鍘卞銈嗗姂閸婃洟寮搁弮鈧妵鍕煛閸屾粌寮ㄩ悗娈垮枛閻栧ジ骞冨▎鎾崇骇闁规惌鍘介ˉ瀣磽閸屾瑨鍏屽┑顔肩－閸掓帒鈻庨幘瀹犳憰闂佹寧绻傞ˇ浼村疾閺屻儲鐓曢柍鈺佸暟閹冲嫰鏌涢敐鍐ㄥ姢缂佽鲸鎸婚幏鍛喆閸曘劍瀚婚梻浣告贡椤牓宕崸妤佸仼鐎瑰嫰鍋婂鈺呮偣妤︽寧顏犻柛濠勫仱濮婃椽妫冨☉杈╁彋婵犵鈧櫕宸濈紒顔芥椤㈡宕熼鑺ュ闂備礁鎲＄粙鎴︽晝閵堝閿ゅ┑鐘叉处閻撴盯鏌涚仦鎹愬闁逞屽墮濞尖�愁嚕椤愶箑绠婚悹鍥у级椤ユ繈姊洪棃娑氬婵☆偅顨婇、?
//
// 闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁稿绻濋弻鏇㈠醇濠垫劖笑闂佽偐顭堢紞濠囧蓟閺囥垹閱囨繝鍨姈绗戠紓鍌欒兌婵灚绻涙繝鍥ц摕婵炴垯鍩勯弫鍐煏閸繃鍣洪柣搴″⒔缁辨捇宕掑鎵佹瀸闂佸綊顥撻崗妯侯潖缂佹ɑ濯撮柛娑橈攻閸庢挸顪冮妶蹇撶槣闁稿锕ら悾宄邦煥閸愶絾鏂�闁诲函绲介悘姘跺疾閻愭祴鏀介柣鎰级椤ョ偤鏌熺粙娆剧吋鐎殿喗鐓￠、妤呭礋椤掆偓閳ь剙鐖奸弻锝夊箛椤栨稓銆愰悶姘哺濮婄粯绻濇惔鈥斥拻闂佸憡鎸婚悷鈺侊耿娓氣偓濮婃椽骞愭惔锝囩暤闂佺粯顨呴敃锕�鈽夐悽绋块唶闁哄洨鍠撻崢鍛婄箾鏉堝墽绉繛浣冲洤鐒垫い鎺嶈兌缁犵偞顨ラ悙璇ц含妤犵偞顭囬幏鐘诲箵閹烘梻宕哄┑锛勫亼閸婃牠鎮ч鐘茬筏濞寸姴顑呯粈鍫ユ煏婵炵偓娅嗛柍閿嬪灴閺屾稑鈽夊鍫ョ反婵犮垼顫夐敃銏ゅ蓟閿濆憘鏃堝焵椤掑嫬绠犻柟閭﹀枛閸ㄦ繃銇勯幘鍗炵仼鐎瑰憡绻堥弻鈩冨緞鐎ｎ亞浠煎銈忓瘜閸嬪嫰鍩為幋鐐茬疇闂佺锕ラ幑鍥箖閻愮儤鏅濋柛灞剧☉閻濇帡鏌ｆ惔顖滅У闁逞屽厵閸ㄥ湱绱炴繝鍥х畺闁冲搫鎳庣粻鐢告煙閻戞绠栨繛鍫㈠劋缁绘繈鎮介棃娑楃捕闂佺粯顨呴敃顏勭暦瑜版帒閿ゆ俊銈呭暙缁侊箓姊虹化鏇炲⒉缂佸鍨甸蹇撯攽閸ャ儰绨婚梺鍦檸閸亪宕戦幘宕囨殾闁搞儜鍐懇婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犱即鏌熼梻瀵歌窗闁轰礁瀚伴弻鐔衡偓鐢殿焾鏍″銈庡亝濞叉鎹㈠┑瀣棃婵炴垵宕崜鎵磽娴ｅ搫校濠电偛锕璇测槈閵忊晜鏅濋梺鎸庣箓濞层劑鎮￠崒鐐粹拺缂侇垱娲樺▍鍛存煕閻曚礁浜版繝鈧笟鈧娲箰鎼达絿鐣甸梺缁橆殔閿曪箑鈽夐悽绋块唶闁哄洨鍠撻崢鍛婄箾鏉堝墽绉繛浣冲洤鐒垫い鎺嶈兌缁犵偞顨ラ悙璇ц含妤犵偞顭囬幏鐘诲箵閹烘梻宕哄┑锛勫亼閸婃牜鏁鍫濈闁绘垼濮ら悡鍐偣閸ヮ亜鐨虹紒鐘差煼閺屸�崇暆鐎ｎ剛袦闂佺硶鏂侀崑鎾愁渻閵堝棗鍧婇柛瀣尭閳规垿妾遍柛瀣姍閸┾偓妞ゆ帊绶￠崯蹇涙煕閻樺啿鍝虹�规洘顨呰灒闁惧繗顫夊▓鎯р攽閳藉棗鐏熼悹鈧敃鍌氳Е閻庯綆鍠楅悡鏇㈡煃閳轰礁褰侀柟杈鹃檮閸嬵亪鏌涢妷顔煎闁抽攱鍨块弻娑㈡晜鐠囨彃缁╁┑锛勫亾閹倿寮诲☉妯滅喖骞愭惔顔筋棄闂備焦瀵уú蹇涘垂娴犲鏋侀柟鍓х帛閺�?
// 闂傚倸鍊风粈渚�骞栭位鍥焼瀹ュ懐锛熼梺鍦濠㈡﹢宕归崒娑栦簻闁哄秲鍔岄悞褰掓煛鐎ｎ亪鍙勯柡灞炬礉缁犳稓鈧綆浜栭崑鎾诲即閻樼數鐒奸悗鍏夊亾闁告洦鍓涢崢鍗炩攽閻愭潙鐏熼柛銊潐缁傚秹鎮ч崼婊呯畾濡炪倖鍔戦崹娲吹閸ヮ剚鐓涢悘鐐插⒔閳藉鎽堕敐澶嬬厽闁规儳鍟块銏ゆ煟鎼淬値鍤欐い顏勫暣婵¤埖鎯旈垾鑼嚬闂備礁鎲″褰掓偡閳哄懐宓侀柛鈩冾殢閸氬鏌涢埄鍏狀亪顢撻幘鍓佺＝濞达絽澹婇崕鎰版倵缁楁稑鎳嶉悞濠囨倵閿濆骸浜炵紒鐘荤畺閹鈽夊▎妯煎姺闂佹椿鍘奸敃顏堝蓟閿濆鏁囨繝闈涳工閸橈繝姊洪悷鎵暛闁搞劎顢婇悘鎺旂磽閸屾瑧鍔嶉柨姘亜鎼淬垺宕岄柟顔筋殜閻涱噣宕归鐓庮潛闂備胶鎳撻崯鍨归悜钘夌閻庯綆鍠栭拑鐔兼煏婢舵稑顩柛妯兼暩缁辨挻鎷呯拠鈩冪暦缂備礁顑嗛崹浣冪亱濡炪倖鎸堕崹鍦磼閳哄懏鐓熼柨婵嗘噺濠�浼存煕閻樺啿濮嶉柡灞诲�濆畷婊堝箵閹烘埈娼婚梻浣筋嚙缁诲棝寮插┑鍫燁潟闁圭儤顨呯粻鐔兼倵閿濆骸澧伴柣锕�鐗撳铏规嫚閳ュ磭浠╅梺鍝ュ枑濞兼瑩鎮鹃悜鑺ュ亜缁炬媽椴搁弲銏＄箾鏉堝墽绉繛鍜冪秬閳煡姊婚崒姘偓椋庣矆娓氣偓楠炲鍨鹃幇浣告櫊婵犵數濮甸懝楣冩偪閻愵兙浜滈煫鍥ㄦ尰椤ョ偞銇勯锝嗙缂佺粯绻堝Λ鍐ㄢ槈閸楃偛澹堢紓鍌欑贰閸嬪嫮绮旇ぐ鎺戣摕闁挎繂鎲橀悢鐑樺厹闁告粈绀佹俊鎶芥⒒娴ｅ憡鎲搁柛鐘查叄閹勭節閸パ呯杽闂侀潧顭堥崕顕�寮ㄦ禒瀣厱闁哄洢鍔屾禍楣冩煙妞嬪骸鍘寸�殿喗鎸抽幃顏堝川椤旂⒈浼撻梻浣稿閻撳牓宕戦幒妤佸�垮ù鐘差儐閻撴瑩鏌涘▎蹇ｆ▓婵炲牊绮庨埀顒冾潐濞插繘宕濋幋锔衡偓浣糕枎閹惧磭鐓戝銈嗗姦閸撴盯鎮鹃悽鍛婄厸閻忕偛澧介埥澶嬨亜椤愶絿绠炴鐐叉椤т焦绻涘顔煎箻缂佽鲸鎸荤粭鐔煎炊瑜庨悵顖滅磽娴ｈ櫣甯涚紒璇插�块、姘舵晲婢跺á鈺呮煃閸濆嫬鈧宕濋棃娑掓斀闁绘劖娼欓悘锔芥叏濡濮傞柛鈹垮灲瀵挳濮�閳锯偓閹峰搫鈹戦鐐殌婵炲眰鍊栨穱濠囧礂闂傚绠氬銈嗗姧缁插灝煤鐎电硶鍋撶憴鍕缂佽妫濊棟鐟滅増甯楅悡娑樏归敐鍛喐閺佸牓姊烘潪鎵妽闁圭懓娲顐﹀箻缂佹ɑ娅�?
//
// 1. 闂傚倸鍊峰ù鍥敋瑜嶉湁闁绘垼妫勯弸浣糕攽閻樺磭顣查柡鍛倐閺屻倝骞侀幒鎴濆Б闂侀潧妫欑敮锟犲蓟閵堝牄浜归柟鐑樻⒒閺嗩偊姊洪崫鍕効缂佺粯绻傞悾閿嬬附閸撳弶鏅濋梺闈涚箳婵參骞忛妶澶嬧拻濞达綀濮らˉ澶愭煕婵犲啯鍊愭い銏＄墵瀹曞崬鈻庨幋鐘靛姽闂備礁婀遍崕銈夈�冮崱娑樺惞閻庯綆鍠楅悡鐔兼煏韫囧鐏柡鍡忔櫊閺屾盯鍩℃担鐩掞絿绱掔紒妯笺�掗柍褜鍓涢弫鎼佲�﹂崼銉晛闁规儳澧庣壕濂告煙缂佹ê绗氶柛瀣ㄥ劦閺岀喖顢欓崫鍕濡炪値鍘归崝鎴濈暦婵傚憡鍋勭�瑰嫭婢橀ˉ澶愭⒒閸屾瑧顦﹂柟娴嬧偓瓒佹椽鏁冮崒姘憋紱闂佸憡娲﹂崹浼存偪閻愵剛绠鹃柛鈩兩戠亸浼存煟閹惧鈽夐柕鍡樺笒椤繈顢楁繝鍌氼潬缂傚倷绀侀鍛粹�﹂悜钘夎摕闁绘梻鍘х粻鐟懊归敐澶嬫暠闁哥姵宀稿鐑樻姜閹殿噮妲紓浣割槼閸╂牜绮嬮幒妤佹櫇闁稿本绋戞禒濂告倵閸忓浜鹃梺閫炲苯澧撮柟顔惧亾濞煎繘濡搁妶鍥╃暰闂備胶绮崝锔界濠婂牆鐒垫い鎺嶈兌濞插瓨銇勯姀锛勬噭缂佺粯绻堝畷鐔碱敆閳ь剚鎯旀繝鍌楁斀妞ゆ梻鐡旈悞楣冩煕閳哄倻澧电�规洘鍨块崺锟犲磼濠婂拋鍟庨梻浣虹《閸撴繈銆冮崱娑樼闁挎繂顦伴悡鐔兼煟閺冨偆鐒惧┑顔肩Ф閳ь剚顔栭崰鏍偉婵傜鏄ラ柨鐔哄Т绾惧吋鎱ㄥΟ鍝勬倯妞ゃ儱顑嗙换婵嬫偨闂堟稐绮堕梺缁橆殔閿曨亜鐣疯ぐ鎺戦敜婵°倐鍋撶紒鐘崇墱閹叉悂寮捄銊︽婵犻潧鍊搁幉锟犲磻閸曨垱鐓曟繝闈涘閸斻倗鎮敐澶嬧拻濞达絿鐡旈崵娆愮箾閺夋垵妲婚柍璇茬Ч婵偓闁靛繒濮风粵蹇旂箾鐎电孝妞ゆ垵鎳愮划濠氭偄閸忚偐鍙嗛梺缁樻煥閹碱偄鐡柡澶嗘櫆缁诲啰鎹㈠☉娆愮秶闁告挆鍛呮艾顪冮妶搴′簻妞わ妇鏁婚悰顔跨疀濞戞瑧鍔堕悗骞垮劚濡盯宕㈤崨濠勭瘈闁靛骏绲剧涵鐐繆椤愶絾灏︽鐐茬箻閹粓鎸婃径宀�鍘┑鐘灱閸╂牠鏁嬫繛瀵稿У濡炶棄顫忕紒妯诲闁告稑锕ら弳鍫ユ煟閵忊晛鐏℃い銊ワ躬婵℃挳宕橀埡浣虹獮闂佸綊鍋婇崕鐢稿Ψ閳哄倻鍘遍梺閫涘嵆濞佳囧几閻斿吋鐓涢柛婊�绀佹晶鎾煙椤旀枻鑰块柟顔界懇閹粌顫滈崼銏犳優缂傚倸鍊风欢锟犳偂婢舵劕绠�?
//    闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲婊堝疾濠靛鐓ユ繝闈涙瀹告繄绱掗悩铏棃闁哄本绋戦埥澶愬础閻愬浜跺┑鐐茬摠閸ゅ酣宕愬┑瀣摕闁绘柨鐨濋弸鏃堟煕椤垵鏋熼柣蹇撶Ч濮婄儤瀵煎▎鎴犘滄繛瀛樼矊閻栫厧顕ｇ拠娴嬫婵犲﹤鎳愰弶鎼佹⒑閻熸澘鈷旂紒杈╁枛婵＄兘鍩￠崒婊冨箺婵＄偑鍊栭幐楣冨闯閵夈儮鏋旈柡鍥╁Х绾惧ジ鏌￠崘銊モ偓鎼佸几濞戙垺鐓欐い鏂诲妼濞层倝鏌嬮崶顒佺厽闁哄洦姘ㄩ崝宥囩磽瀹ュ棴鑰挎慨濠勭帛缁楃喖鍩�椤掆偓椤洩顦查摶鐐烘煙缂併垹鏋涚紒鐙�鍨堕弻?
// 2. 闂傚倸鍊峰ù鍥敋瑜嶉湁闁绘垼妫勯弸浣糕攽閻樺磭顣查柡鍛倐閺屻倝骞侀幒鎴濆Б闂侀潧妫欑敮锟犲蓟閵堝牄浜归柟鐑樻⒒閺嗩偊姊洪崫鍕効缂佺粯绻傞悾閿嬬附閸撳弶鏅濋梺闈涚箳婵厼顭囩紒妯圭箚闁绘劦浜滈埀顒佸灴瀹曟繂顓奸崶褍鐏婇悗骞垮劚濞层劑鎯屾径鎰厵闁绘垶锕╁▓鏃堟倵濮橆剦妯�闁哄矉缍佹慨鈧柕蹇婂墲濮ｅ嫬鈹戦埄鍐ㄥ姢闁绘牕銈稿濠氬焺閸愩劎绐為梺绯曞墲钃遍柣婵囨礈缁辨挻鎷呴崜鎻掑壉闂佸憡姊归〃鍫澪ｉ幇鐗堝�烽柛婵嗗缁愭盯姊洪崫鍕垫Ч闁搞劌缍婇幃锟犲箣濠垫劖瀵岄梺闈涚墕濡稒鏅堕鍌滅＜閻庯綆鍋勯悘鎾煕閳哄倻娲寸�殿噮鍣ｅ畷濂告偄閾氬倸鎽嬪┑鐘垫暩閸嬬偤宕归崼鏇椻偓锕傚醇閳垛晛浜炬慨姗嗗亜瀹撳棝鏌＄仦璇测偓婵嗙暦閵婏妇绡�闁告劦浜滈崵鎺撲繆閻愵亜鈧牕煤閳哄啰绀婇柍褜鍓涚槐鎺楁偐瀹曞洦鍒涢悗娈垮枟閹告娊骞冮姀銈嗗�绘俊顖涙た閸熷懘姊婚崒姘偓椋庣矆娓氣偓楠炲鏁撻悩鑼槷闂佸搫娲ㄦ慨鐑芥儗閹剧粯鐓熼柕蹇嬪焺閻掔偓鎱ㄧ憴鍕弨妤犵偞鐗曡彁妞ゆ巻鍋撳┑陇鍋愮槐鎺楁偐閻㈤潧绗￠梺闈涙搐鐎氫即鐛鈧畷锟犳倷瀹割喚鈧绱撻崒娆掝唹闁稿鎸搁…鍧楁嚋闂堟稑顫庨梺鍛婄懄閹瑰洭寮诲☉銏犖ㄩ柟瀛樼箓椤忊晜绻涢崼鐕佹疁婵﹥妞藉Λ鍐ㄢ槈濞嗘ɑ顥ｇ紓鍌欒兌缁垶宕归悽绯曗偓锕傚炊閵娧呯槇濠殿喗锕╅崢濂稿焵椤掑倸鍘撮柡灞诲�楅崰濠囧础閻愬樊娼介梻浣告惈濡瑥顫忛崷顓熷床婵炴垶鍩冮崑鎾绘偨濞堣法鍔搁悶姘ュ姂濮婅櫣绮欓崹顕呭妷闂佺粯鎸撮埀顒佸墯閸ゆ洟鏌熼梻瀵割槮缂佲偓閸愵喗鐓冮柛婵嗗閺嬨倖绻涢弶鎴濐伃婵﹥妞藉畷顐﹀礋椤撶儐鏆梻浣告啞閸╁啴宕戦幘鍓佺＝濞达綁娼ф俊娲煕濡や礁鈻曠�殿喛顕ч埥澶娢熼柨瀣偓濠氭椤愩垺绁紒鎻掓健瀹曪絽顫濇潏鈺冿紳婵炶揪绲块幊鎾诲极閸撗呯＜缂備焦顭囩粻鐐烘煟濞戝崬鏋ら柍褜鍓ㄧ紞鍡涘窗閺嶎厼绀冮柍褜鍓欓—鍐Χ閸℃鐟ㄩ梺鎸庢磸閸庢娊鍩�椤掍浇澹樼紓宥咃躬瀵鈽夊Ο閿嬵潔闂佸憡顨堥崑娑氱不瑜版帗鍊甸柣銏ゆ涧椤ｅジ鏌熼崨濠冨�愭繝鈧笟鈧铏圭磼濡浚浜炴竟鏇㈩敇閻斿憡鐝烽梺鍓茬厛閸嬪倻鎹㈤崱娑欑厵闁诡垎鍕闁�?
//    婵犵數濮烽弫鎼佸磻濞戙垺鍋ら柕濞у啫鐏婇悗鍏夊亾闁逞屽墴閸┾偓妞ゆ帊鑳堕埢鎾绘煛閸涱垰孝妞ゆ洩缍侀幖褰掝敃閿濆懎濡抽梻渚�娼ч…鍫ュ磿閹剁瓔鏁婇柟鐑樺焾濞撳鏌曢崼婵囶棡閻忓繒鏁婚弻娑氣偓锝庡亞濞叉挳鏌熼娆戠獢鐎规洖銈稿鎾偄閾氬倻鏁炬繝鐢靛仩閹活亞寰婃禒瀣疅闁跨喓濮撮梻顖炴煙闂傚鍔嶉柣鎾跺█閺屾盯鈥﹂幋婵呯盎闂佽绻戦幐鎶藉蓟閻旂⒈鏁嶆慨姗嗗墯濞堝鎮楃憴鍕闁哥姵鐗犻妴渚�寮撮姀鐘栄囨煕濞戝崬鐏￠柣鎺斿亾缁绘繈鎮介棃娑楃捕濡炪倖娲﹂崢浠嬪箞閵娾晛绠绘い鏇炴噺閺呯偤姊虹化鏇炲⒉缂佸鍨块幏鎴︽偄閸忚偐鍘介梺鍝勫�归娆忊枔閻樼粯鐓曢柕鍫濇缁�瀣煟閹垮啫浜扮�规洖鐖兼俊鐑藉Ψ閵夈儛鎴犵磽閸屾瑨顔夐柛瀣尭椤潡鎳滈棃娑橆潔闂佹娊鏀遍崹鍧楀蓟閻旇櫣纾兼俊顖濇椤戝倿鎮楀☉娆戠疄婵﹨娅ｉ崠鏍即閻斿摜褰嗘俊鐐�戦崝灞轿涘☉姘灊婵炲棙鍔曠欢鐐烘倵閿濆骸澧伴柣锕�鐗撳娲川婵犱胶绻侀梺鍛婎焽閸嬫捇寮查崼鏇ㄦ晬婵炴垶姘ㄩ鏇㈡⒑閻熼偊鍤熼柛瀣仱閹繝濡烽敂杞扮盎闂佺懓鐡ㄧ换鍐╁緞閸曨垱鐓涢柛娑氬绾箖鎽堕弽顓熺厱婵炴垵宕獮妯何旈悩鍙夊枠婵﹥妞藉畷銊︾節閸屾鏇㈡⒑缂佹ɑ灏柣妤佹尭閻ｇ兘濡烽埡浣哥獩闁诲孩绋掗…鍥储閸楃偐鏀介柣鎰綑閻忥箓鏌ㄩ弴妤佹珚闁诡喚鍋為妶锝夊礃閳哄啫寮抽梻浣虹帛濮婂鈥﹂崼銉﹀�跺┑鐘叉处閻撶喖鏌熼搹鐟颁户闁伙綁浜堕弻銊╁即濡櫣浠鹃柣搴ㄦ涧閵堢顕ｉ崼鏇炵闁绘宕靛畷婊堟⒒閸屾瑨鍏岄柛瀣ㄥ姂瀹曟洟宕￠悜鍡楁闂佸壊鍋呭ú锕傚极閸愵煁褰掓偐瀹割喖鍓遍梺缁樻尰濞茬喖寮婚悢鍏煎�绘俊顖滅帛閸庡骸鈹戦悙鑼闁荤啿鏅犲濠氬即閵忕姴鑰垮┑掳鍊愰崑鎾绘煛閸☆厾绉柡灞稿墲閹峰懘宕妷鎰╁�曢湁闁绘瑥鎳愰悾鍨叏婵犲懎鍚归柍褜鍓欓悘姘跺箖閸岀偞鍊垫繛宸簼閳锋帒霉閿濆懏鍟為柛鐔哄仱閺岋綁鎮㈤弶鎴濆Е闂佽桨绀侀崯鎾极閹版澘鐐婇柍鍝勫暟閺嗐儵姊绘担鍛婂暈濞撴碍顨婂畷鏉课旀担渚锤闂侀潧鐗嗛ˇ浼存偂閵夆晜鐓熼柡鍥╁仜閳ь剙婀遍埀?
//    闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁逞屽墴閸┾偓妞ゆ帊绀侀崵顒勬煕閹捐泛鏋庨柣锝囧厴婵偓闁靛牆鎲樿閺屾盯濡烽敐鍛瀳濡炪倕绻戦幃鍌氼潖濞差亜绠伴幖杈剧悼閻ｇ敻姊鸿ぐ鎺撴暠闁搞劎鎳撳嵄闁规壆澧楅弲鎻掝熆鐠轰警鍎戦柛妯绘倐濮婃椽宕ㄦ繝鍐槱闂佺顑呭Λ婵嗩嚕娴兼潙纾奸柣鎰嚟閸欏棝姊虹紒妯荤叆闁硅绻濋幃姗�顢氶埀顒勫蓟閻旂厧绀勯柕鍫濇椤�?

// 闂傚倸鍊搁崐鐑芥嚄閸洍鈧箓宕奸姀鈥冲簥闂佸綊鍋婇崰姘舵儗閹剧粯鐓熼柟杈剧到琚氶梺绋垮椤ㄥ棙绌辨繝鍥ч柛鏇ㄥ枛閸橈繝姊虹紒妯肩畵闁绘牕銈稿濠氭晲閸涘倹妫冮崺鈧い鎺戝閸嬪鈹戦悩鍙夌カ缂傚秵鐗犻弻鈥愁吋鎼粹�崇闂佺粯鎸堕崕鑼崲濞戙垹绠ｉ柣鎰仛閸ｎ喖顪冮妶蹇曞埌鐎殿喖澧庨幑銏犫攽鐎ｎ偅娅㈡繛瀵稿Т椤戝棝宕戠�ｎ喗鐓曟い鎰╁�曢弸搴€亜椤愮啿鍋撻幇浣瑰瘜闂侀潧鐗嗗Λ娑欐櫠椤掑嫭鐓熼柣鏇炲�婚悾鍨亜閵忊剝绀冪紒鍌涘笧閳ь剨缍嗛崑鍡涘储閹间焦鈷戦柛娑橈攻缁�瀣箾娴ｅ啿娲﹂崐鍫曟煃閳轰礁鏆熺紒鈾�鍋撻梻浣芥硶閸犲秶鍒掑▎鎾崇畺鐟滄柨鐣锋總鍛婂亜濠靛倸顦伴拏瀣攽閿涘嫬浜奸柛濠冪墵閹兾旈崨顔间画闂佹寧娲栭崑鍡涘极閸愵煁褰掓偐瀹割喖鍓遍梺缁樻尵閸犳劖绌辨繝鍥ч煫鍥ㄦ煥椤忓爼姊绘担铏瑰笡妞ゃ劌鎳橀弫鍐Χ婢跺棌鍋撻敃鍌氱倞妞ゆ巻鍋撻梺鍗炴喘閺屾洘寰勯崼婵嗗Б濡炪倖鏌ㄥú锔炬崲濞戞瑦缍囬柛鎾楀憛姘渻閵堝骸浜滄い锕佷含閸掓帗绻濆顒傤唺闂佸湱鍋ㄩ崝搴ㄥ箠閹剧儵鈧箓濡搁埡浣歌�垮┑鈽嗗灣绾爼宕戦幘璇茬妞ゎ厼顑囬幊鎾烩�﹂妸鈺佺妞ゆ劧缍�閻т線鏌ｆ惔銈庢綈婵炴祴鏅濆濠囧礈瑜庡畷鍙夌節闂堟侗鍎忕�瑰憡绻冮妵鍕冀閻㈢數蓱闂佽桨闄嶉崐婵嗩潖缂佹ɑ濯撮柧蹇曟嚀缁楋繝姊洪崨濠傜仴缂傚秴锕ら悾鐑藉级鎼存挻顫嶉梺闈涚箚閸撴繂鈻嶉姀銈嗏拺闁兼亽鍎嶉鍩跺洦瀵奸弶鎴︽７缂備礁顑嗛敍鏇㈡偡闁妇鍙嗛梺鍛婃处閸嬪懐鎷犻悙鐑樷拺閻犲洠鈧櫕鐏嶆繝鐢靛仜閿曨亪鎮伴纰卞悑濠㈣埖蓱閺呪晜绻濋姀鐘差暢婵炲懌鍨荤划濠氬箻鐠囪尪鎽曢梺闈涱焾閸庮喖危閸儲鐓ｉ煫鍥风到娴滄粍銇�?as is"闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熷▎陇顕уú顓㈢嵁韫囨洑娌悹浣芥珪閻繐鈹戦悙鑸靛涧缂佽尪妫勯敃銏ゆ焼瀹ュ棗浠柣鐔哥懃鐎氼喚绮绘ィ鍐╃厵閻庢稒顭囩粻姗�鏌ㄥ☉妯夹ょ紒杈ㄥ浮閸┾偓妞ゆ帒瀚弲?
// 闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敂钘変罕濠电姴锕ら悧鍡欑矆閸喓绡�闂傚牊渚楅崕鎰版倵濮橆剙鏆ｉ柟顔筋殜閺佹劖鎯旈垾鑼晼婵＄偑鍊愰弲婵嬪礂濮椻偓楠炲啳銇愰幒鎴滅炊闂佸憡娲﹂崜姘跺磿閹剧粯鈷戝ù鍏肩懅閻ｉ亶鏌ｉ弽褋鍋㈡鐐插暣閺屻劎鈧綆鍋勯鎾绘⒑閸涘﹦鈽夐柨鏇樺�曢埢宥夊閵忋垻锛濇繛杈剧秬椤曟牕鈻撻弮鈧妵鍕晝閸屾瑦鍠氬Δ鐘靛仜缁绘濡甸幇鏉跨闁规儳鍘栫花濠氭⒒娴ｇ鎮戦柟顔煎�搁…鍥槼闁诡垱姊圭换婵嬪礃椤忓棭鍟庨梺鍝勵槸閻楀棙鏅堕悾宀�鐭欑紓浣诡焽缁犻箖鏌涘▎蹇ｆ＆妞ゅ繐瀚粊顐︽⒒娴ｇ儤鍤�妞ゆ洦鍘介幈銊╂倻閼恒儱鍓归梺绯曞墲缁嬫帡鎮￠悢鍏肩厵閻庣敻鏅茬槐铏亜韫囨挾澧涢柛濠呭煐娣囧﹪濡堕崒姘婵＄偑鍊ら崑鍛淬�冮崨鏉戠叀濠㈣泛艌閺嬪孩淇婇婊冨付濠殿喗妞藉缁樼瑹閳ь剙顭囪鐓ら柨鏃�鍎抽弸鍫⑩偓骞垮劚濞层劑鎯屽▎蹇婃斀闁绘ɑ褰冮鐢告煙妞嬪骸鍘撮柡浣瑰姈閹棃鍨鹃懠顒傛晨濠碉紕鍋戦崐鏇犫偓娑掓櫊楠炴劕顫㈢仦鐣屽�掗梻鍌欑劍閹爼宕曢鐐茬閹艰揪绲挎稉宥嗘叏濡灝鐓愰柣鎾跺枑閵囧嫰骞樼捄鐑樼彙濠电偛鐗婂ú婊呮閹烘纾兼繛鎴烆焽閻熸煡鏌ｆ惔锝嗘毄闁告鍥х厺閹兼番鍔岀粻锝夋煟濞嗗苯浜惧┑陇灏欓崗妯侯潖缂佹ɑ濯撮柛娑橈工閺嗗牓姊虹紒姗嗘畷婵炶尙鍠栭悰顔界節閸涱垳鏉搁梺鍝勬祩娴滄繄鈧俺顫夐幈銊ノ熼悡搴′粯濡ょ姷鍋為〃濠囧蓟閻旈鏆嬮柣妤�鐗嗗▓妤呮倵鐟欏嫭绀嬪ù婊嗘硾椤曪綁骞橀钘変汗闂佸壊鐓堥崑鍕几閹剧粯鈷掗柛灞捐壘閳ь剚鎮傚畷鎰板传閵夈垹浜炬慨妯煎帶瀵喚鈧娲樼换鍫ョ嵁閹烘绫嶉柛銉仢閳ユ剚娓婚柕鍫濇缁楁帡鏌涙繝鍕幋闁诡喚鍋炵换婵嬪炊閵娿垺瀚兼俊鐐�栧濠氬磻閹惧墎纾奸悗锝庝簻椤忣厽顨ラ悙鑼闁诡喗绮撻幐濠冨緞瀹�瀣簥濠电姵顔栭崰妤呮晝閳哄懎鍌ㄩ柦妯侯槴閺嬫梹銇勯弽顐沪闁抽攱鍨块幃褰掑炊閿濆倸浜鹃柛鎰絻琚╅梻鍌欒兌椤牓寮甸鍕仭鐟滄柨螞閸曨偒鍚嬪璺侯儌閹锋椽姊洪崨濠勨槈闁挎洩绠撻獮濠囧礃椤旂晫鍙嗛梺鍝勬祩娴滎亜顬婇鍓х＜闁哄啫鍊搁弸娑欘殽閻愭潙娴�殿噮鍣ｉ獮姗�寮堕幋顓濈处闂備浇宕甸崰鎰版偡閵壯�鍋撳鐓庡籍闁诡垰鍟撮獮瀣倷閻㈡鍟庨梺鑽ゅТ濞壯囧礋椤愵偂绱�
// 闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁逞屽墴閸┾偓妞ゆ帊绀侀崵顒勬煕閻樺磭澧甸柛鈹垮灲楠炴鎷犻懠顒夊悈闂備焦瀵у濠氬疾椤愶箑绀夐柣銏犳啞閳锋垹绱掔�ｎ偄顕滄繝鈧幍顔剧＜妞ゆ棁鍋愭晥閻庢鍠栭悿鍥╃不濞戞ǚ妲堟繛鍡樺灥楠炲秵淇婇悙顏勨偓鏍春閸儱绀堟繛鍡樻尭绾惧綊鏌ｉ敐鍛伇闁活厼妫濋幃妤呮晲鎼存繃鍠氬┑鐐茬毞閸撴繄鎹㈠☉銏犵闁绘劕鐏氶崳浠嬫⒑缂佹ê绗傜紒顔界懇瀵寮撮姀鐘靛�為梺闈涱焾閸庨亶骞楅棃娴虫棃鎮╅棃娑樺闂佸綊顥撻崗姗�骞冨畡閭︾叆闁告劦鐓堥崝澶愭⒑閸涘﹤绗掗柨鏇畵閸┾偓妞ゆ帊鑳堕埊鏇熴亜椤撶偞鍠橀柛鈺冨仜椤撳ジ宕卞▎鎴犳闂傚倸鍊搁悧濠勭矙閹达富鏁傞柣銏犳啞閻撴瑥顪冪�ｎ亪顎楅柛妯侯嚟閳ь剝顫夊ú妯兼暜閹烘せ鈧箓濡搁埡浣侯槰闂佺粯鍔﹂崜姘舵儊閺冨牊鈷掗柛灞剧懅椤︼箓鏌熺喊鍗炰喊閽樻繃銇勯弽顐粶闁汇値鍠楅妵鍕冀閵娧呭箵闂佸綊顥撻崗妯虹暦瑜版帩鏁冮柨婵嗗椤ュ牓鏌ｆ惔銏╁晱闁哥姵鐗犻幃妯侯潩椤掑娈梺鍛婃处閸撴瑧娆㈤悙鐑樺�甸柨婵嗛婢ь垳绱掗妸褍浠辨慨濠勭帛閹峰懘宕ㄦ繝鍌涙畼闂備浇宕甸崰鍡涘磿閻㈢鏋侀柛鎰靛枛鍞梺闈涱樈閸ㄧ敻鍩�椤掆偓濞硷繝寮婚敐鍛傛棃鍩�椤掑嫭鍋嬪┑鐘插暞閸欏繑绻濇繝鍌氼仴濞存粍绮撻弻鈥愁吋閸愩劌顬嬮梺鐟板暱鐎氼參濡甸崟顖氱疀妞ゆ牗渚楀Λ鍕⒑鐎圭姵顥夋い锕傛涧椤曪綁顢楅埀顒勫煝鎼淬劌绠氱憸宥嗙珶瀹ュ洨纾藉ù锝夌細濡炬悂鏌涘▎蹇曠妤犵偛绻橀幃婊堟嚍閵夈垺瀚肩紓鍌氬�烽悞锕傛晪闂佹悶鍊ら崜鐔煎蓟濞戙垺鍋愮�规洖娲﹂崚娑㈡⒑鏉炴壆鍔嶉柟鐟版喘楠炴劖绻濋崘銊х獮闁诲函缍嗘禍鐐躲亹閸涱垳纾介柛灞剧懄缁佹澘顪冮弶鎴炴喐闁瑰箍鍨藉畷鐓庘攽閹邦剚顓挎俊鐐�栧ú宥夊磻閹剧粯鐓欐い鏃囶潐濞呭棛绱掑Δ鍐ㄦ灈妞ゃ垺绋戦～婵嬵敇閻斿搫缍戞繝鐢靛Х閺佹悂宕戝☉銏╂晪妞ゆ挾鍠愰崣蹇撐旈敐鍛灓闁轰礁锕ら埞鎴︽偐閹绘帩浼�缂備讲鍋撳┑鐘插閸嬫捇鐛崹顔煎濡炪倧瀵岄崹鎶芥儉椤忓浂妯勯梺鍝勮嫰缁夎淇婇悜钘壩ㄩ柕澹洨宕滃┑锛勫亼閸婃牠宕濋幒鏂垮灊婵炲棙鎸搁拑鐔兼煛閸ャ儱鐏╂鐐灪閵囧嫰骞樼捄鐑樼�诲?
// 闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敃鈧悿顕�鏌ｅΔ鈧悧濠囧矗韫囨拹鏃堟晲閸涱厽鐏撻梺杞扮閿曨亪寮婚悢鍛婄秶闁告挆鍛缂傚倷鑳舵刊瀵哥礊娓氣偓瀵鎮㈤崗鑲╁姺闂佹寧娲嶉崑鎾愁熆瑜滈崹宕囨閹烘鐒垫い鎺戝闁卞洭鏌曟径娑橆洭闁告鏁婚弻锝嗘償閵忊懇濮囧銈庡幖濞诧箓寮查幆閭︽▌闂佸搫鐬奸崰鏍偘椤曗偓瀹曞綊顢欓崣銉ф／闂傚倷鑳堕幊鎾诲床閺屻儱绠犳俊顖欒閸ゆ洟鏌熺紒銏犳灍闁哄拋鍓熼弻娑㈠即閵娿儱绠瑰Δ鐘靛亹閸嬫挸鈹戦悩鍨毄闁稿鐩、姘额敇閻旂寮挎俊銈忕到閸犳岸寮繝鍌楁斀闁绘ɑ褰冮鐢告煙妞嬪骸鍘存俊顐㈠暙閳藉鈻庨幇顓烆伆缂傚倸鍊风粈渚�顢栭崨瀛樻櫇闁靛鍎洪崵妤呮煕閺囥劌鐏犻梺鍗炴处閵囧嫰骞掑鍥舵М濡炪倕绻楅崺鏍崲濞戞瑦缍囬柛鎾楀憛姘渻閵堝骸浜滄い锔炬暬瀵偊骞樼拠鍙傘劑鏌嶉崫鍕偓鍛婄椤栨稓绠鹃弶鍫濆⒔閸掍即鏌熺喊鍗炰喊鐎规洘绻勯埀顒婄秵閸嬩焦绂嶅鍫熺厵闁绘垶蓱鐏忕數绱掗悩绛硅�块柡宀�鍠庨悾锟犲箥椤旀嫎銊╂⒑鏉炴壆鍔嶉柛鏃�鐟ラ悾鐑芥偄绾拌鲸鏅㈤梺閫炲苯澧柟顖涙⒐缁绘繈宕橀鍡╁晭闂備胶鎳撻顓㈠磻閻愬吀鐒婃い鎾卞灪閻撴瑧鐥弶鍨埞濞存粍绮撻幃锟犲Χ閸℃瑧鐦堟繝鐢靛Т閸婄粯鏅堕弴銏″仭婵炲棙鐟ч悾鐢告煛鐏炲墽娲存い銏℃礋閹晠鎳犻鎸庡亝濠碉紕鍋戦崐鏍蓟閵娾晜鏅濇い蹇撶墕閽冪喐绻涢幋鐐电煂闁汇倐鍋撻梻浣筋潐瀹曟﹢顢欓幇顔筋潟闁绘劗鍎ら埛鎺戙�掑顒佹悙闁哄鍠栭弻鐔奉潰鐏炲墽褰ф繛锝呮搐閿曪箓鍩�椤掍胶鈯曢拑鍗炩攽椤栨稒灏﹂柟顔煎槻閳诲氦绠涢幙鍐х触濠德板�楁慨瀵告崲濮椻偓瀵鍩勯崘銊х獮闂佺硶鍓濊摫闁绘繃鏌ㄩ埞鎴︽倷閼碱剚鍕鹃梺绋匡攻缁诲啯绌辨繝鍥ㄥ仺缂佸娉曢娲⒑缂佹◤顏堝疮閸ф鏁傞柟闂寸劍閳锋垿鏌熺粙鎸庢崳缂佺姵鎹囬幃妤�顫濋悡搴＄闂佷紮绲块崗姗�鐛幘璇茬闁糕剝锕╁鏃堟⒒娴ｇ瓔娼愮�规洘锕㈤、姘跺冀椤撶偠鍩為梺鎯х箰濠�杈╁婵傚憡鐓熸慨妞诲亾婵炰匠鍥у嚑婵炴垶鐟▓浠嬫煟閹邦剚鈻曢柛搴㈡⒒閳ь剚顔栭崰鏍焵椤掑倸娅忔俊鑼跺亹缁辨挻鎷呴幓鎺嶅闂備礁澹婇崑渚�宕曢弻銉ョ厱闁圭儤顨嗛悡鏇熴亜閹邦喖孝闁诲繆鏅涢湁闁绘﹩鍋呭▍鍥╃磼鏉堛劌绗氶悗鐢靛帶閳诲酣骞囬澶夌处
// 缂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇炲�哥粻顖涚節闂堟稓澧㈢痪鎹愬Г閹便劌螣婢剁鎯堟繛鎴炴尭缁夊綊寮婚妸銉㈡斀闁糕剝锕╁Λ銈夋⒑閼姐倕鏋庣紓宥咃躬瀵鈽夐埗鈹惧亾閿曞倸绠ｆ繝闈涙噽閸戝湱绱撻崒姘偓鍝ョ矙閸曨垰绠柣鎴ｅГ閳锋帒霉閿濆洦鍤�妞ゆ洘绮庣槐鎺斺偓锝庡亜閻忔挳鏌熼銊ユ搐楠炪垺绻涢崱妯兼噭閻庢艾缍婇弻娑⑩�﹂幋婵呭闂佽偐澧楃�笛囥�冮妷鈺傚�烽柤纰卞墰椤旀帒顪冮妶鍐ㄧ仾妞ゃ劌锕ら悾宄邦潨閳ь剟銆侀弮鍫濆耿婵炲棙鍔栭惁鎺戔攽閻樺灚鏆╁┑顔诲嵆瀹曠懓煤椤忓嫮锛熼梺绋跨箳椤戞洘绂掗崼銉︾厵闂傚倸顕ˇ锕傛煕閵娿儱鈧潡寮婚弴鐔虹闁绘劦鍓氶悵鏃傜磽娴ｆ彃浜鹃梺绋跨灱閸嬬偤鎮″☉銏＄厱妞ゆ劗濮撮悘顏堟煛閸″繑娅婃慨濠冩そ楠炲棜顦查柍褜鍓欏鈥愁嚕鐠囨祴妲堟俊顖涚矌閸犳牠骞冮埄鍐╁劅闁靛繆鎳囬崑鎾舵嫚濞村鏂�闂佺粯鍔栬ぐ鍐棯瑜忕槐鎺楊敊閸忓吋宕抽梺鍛婂笚鐢�崇暦瑜版帩鏁冮柕蹇嬪灮閻涱喗绻濋悽闈涗沪闁搞劏娉涢～婵嬪Ω閳寡冩喘椤㈡洟鏁傜憴锝嗗闂備胶顭堢换鎰板触鐎ｎ剚顐介柡灞诲劜閻撶喐銇勯幘瀵哥畼缂佹劖姊归〃銉╂倷閺夋垹浼岄梺杞扮劍閸旀牕顕ラ崟顓涘亾閿濆骸浜濋柣婵愬亰濮婅櫣鎷犻懠顒傤唺闂佺顑囬崰鏍箖濞差亜绫嶉柛顐ｇ箓閹偤姊虹紒姗嗙劸妞ゃ儱妫濋幃鐑芥焽閿旀儳寮抽梻浣告啞閸旓附绂嶅鍫濆惞妞ゆ帒瀚埛鎴︽煟閻旂顥嬮柣锝庡弮閺屾盯濡搁敂濮愪虎濡ょ姷鍋涚换妯虹暦閵娾晛绾ч柟瀛樼箓缁侇噣姊绘担铏瑰笡闁告梹娲熼、姘额敇閳跺搫娲、姗�鎮㈤搹璇″晭闂佸搫顦悧鍡樻櫠閻ｅ瞼鐭撴い鎺嶈兌缁犳儳顭跨捄渚剱缂佲偓鐎ｎ兘鍋撳▓鍨珮闁稿锕ユ穱濠囨嚋闂堟稓绐炴繝鐢靛Т閸婃槒銇愭径瀣╃箚闁绘劦浜滈埀顒佺墱閺侇噣骞掑Δ鈧悿顕�鏌熼幆鐗堫棄缂佺媭鍨遍妵鍕箛閵婏箑顕橀悷婊呭鐢宕戦幇鐗堢厽闁瑰鍎愰悞浠嬫煏閸℃ê濮嶉柡宀嬬稻閹棃鏁嶉崟顏嗛┏婵＄偑鍊ら崢鐓幟洪銏㈠祦濠㈣泛谩閺冨牆宸濇い鎾跺仧閻涒晜淇婇悙顏勨偓鏍ь潖婵犳艾鐓曢柛顐犲劚濮规煡鏌嶉埡浣告殶缂佺娀绠栭幃妤�鈽夊▎妯煎姺闂佹椿浜欓崡鎶藉蓟濞戞ǚ妲堥柛妤冨仦閻忓秴鈹戦悙鍙夊櫡闁搞劏妫勯～蹇涘传閸旇姤妞介幊锟犲Χ閸涱叀绶熼梻鍌欒兌閹虫捇宕甸弽顓炵?
// 婵犵數濮烽弫鎼佸磻濞戙埄鏁嬫い鎾跺枑閸欏繐螖閿濆懎鏋ら柡浣革工閳规垿鎮╅幓鎺濅紑缂備讲鍋撳┑鐘插閸嬫捇鐛崹顔煎濡炪倧缂氶崡鍐茬暦閺囩喐鍎熼柕濠忕畱閳ь剙鐏氱换娑㈠箣閻戝棔鐥銈呯箰閹冲海娆㈤悙纰樺亾楠炲灝鍔氭い锔垮嵆閹�斥枎閹扳晙绨婚梺瑙勬儗閸樺ジ宕㈤崫銉х＜闂婎剚褰冮埀顒佺箞閻涱喛绠涘☉娆戝弳闁诲函缍嗛崜娑㈠箠濠靛鈷戦悹鎭掑妼閺嬫瑦淇婇銏狀伂闁诲繐顑夊铏圭矓閸℃顏存繛鍫熸⒒缁辨帡鎮╅崘娴嬫灆闂佸搫鏈ú妯侯嚗閸曨偀妲堟繝濠傞閹牓姊绘担鍝ョШ妞ゃ儲鎹囧缁樺緞閹板啫娲︾�佃偐鈧稒顭囬崣鍡涙⒑缂佹ɑ鈷掓い顓炵墦閹ɑ绻濋崟顓狅紲闂侀�炲苯澧柟宄版嚇閹兘鏌囬敃鈧▓濂告⒒娴ｇ瓔娼愮�规洘锕㈤、姘愁樄闁诡垰鑻灃闁告侗鍠氶崢鐢告煟鎼达絾鏆╂い顓炵墦瀹曟粓骞庨懞銉у幍婵＄偛顑呯�涒晠鎮為幐搴涗簻闁挎柨鐏濆畵鍡涙煛鐏炶濮傞柟顔哄灮缁瑧鎹勯妸銈呮瀳闂傚倷鑳堕崢褔鎮块崶顒�鏄ラ柡宥庡亞閸楁岸鏌ｉ弮鍌氬付缂佺姵濞婇弻鐔衡偓娑櫳戦埛鎰版煟韫囧海鍔嶇紒缁樼箞閹粙妫冨ù韬插灲閺屾盯鎮╁畷鍥ㄥ垱濡ょ姷鍋涚换姗�骞冮崸妤婃晬闁挎繂鏌婅濮婄粯鎷呴懞銉с�婇梺鍝ュУ閸旀瑥鐣烽悷鎵虫斀閻庯綆鍋勯埀顒�娼￠弻銊╁即閻愭祴鍋撻崫銉ヮ棜闁秆勵殕閻撶喖鏌曡箛瀣仾闁哄棌鏅濋惀顏堝礈瑜嶆禍楣冩煙娓氬灝濡兼い顐ｇ矒瀹曞崬螖閳ь剚瀵兼惔銊︹拺鐟滅増甯╁Λ鎴︽煛鐏炵瓔妯�閽樻繈鏌熼幆鏉啃撻柣鎾存礋閺屾洘绻濊箛鏇炲煂婵犵绱曢弲顐ゆ閹烘纾兼繛鎴烆焽椤戝倿姊洪悷鏉挎Щ妞ゆ垵鎳橀幃楣冩倻閽樺鍊為梺瀹狀嚃閸擄箓宕㈤崜褎顫曢柟鎹愵嚙绾惧吋绻涢崱妯虹仴濠碘�茬矙濮婃椽宕烽褏鍔稿銈庡幘閸忔﹢鐛崘銊庣喓鎷犻懠顒傜嵁闂備礁缍婇崑濠囧储婵傜绀堟い鎾卞灪閳锋垿鏌涘☉姗堟敾濠㈣泛瀚伴弻娑㈠箻鐎靛憡鍣伴梺璇″枛濞硷繝銆佸璺虹劦妞ゆ帒瀚粻鏍ㄤ繆閵堝懏鍣归柟纭呭煐閵囧嫰骞樺Δ鈧崯顐︼綖濮樿京纾介柛灞剧懄缁佹澘顪冪�涙ɑ鍊愰柟顔惧厴閸┾剝鎷呴悜妯活啎闂備胶绮…鍫ヮ敋瑜嶉蹇撯攽閸ャ儰绨婚梺鍝勫暙閸婄敻骞忛垾瓒佸綊鎮╅棃娑楀缂備胶绮粙鎺戭焽韫囨稑绀堢憸宥夊春鐏炶В鏀介柍钘夋娴滄繃鎱ㄦ繝鍛惞闁告帗甯￠、姗�鎮㈡搴ｇ嵁闂備礁缍婇崑濠囧储閹间礁绠伴柛鎰靛枟閳锋垿鎮归幁鎺戝婵炲懏鍔欓弻?
// 婵犵數濮烽弫鎼佸磻濞戙垺鍋ら柕濞у啫鐏婇悗鍏夊亾闁逞屽墴閸┾偓妞ゆ帊鑳堕埢鎾绘煛閸涱喚娲存繝鈧担绯曟斀闁绘劖娼欓悘锕傛煟閻旀繂娲㈤埀顒�鎳橀幃婊堟嚍閵壯冨汲婵犵數濞�濞佳兾涘▎鎾抽棷闁绘垶顭囩粻楣冩煕濞戝崬骞橀柣鎺撴倐閺岋紕浠﹂崜褉妲堥梺瀹狀潐閸ㄥ灝鐣烽妸鈺婃晬婵﹩鍓﹂悗鎾⒒閸屾瑧鍔嶉柟顔肩埣瀹曟繃绻濋崶褏顦梺鐟扮摠缁诲嫰寮抽敂鐣岀瘈闂傚牊渚楅崕蹇曠磼閳ь剟宕橀鐣屽幍缂傚倷鐒﹂敋濞ｅ浂鍨辩换娑㈡嚌閻楀牏褰х紓浣虹帛閻╊垶鐛�ｎ喗鍊烽悗鐢殿焾瀵櫕淇婇悙顏勨偓鏍垂閻㈠憡鍋嬮柟鎯х－閺嗭箓鏌℃径瀣靛劌婵炵鍔戦弻銊╂偄閸撲胶鐓撳Δ鐘靛仜閸燁垳绮嬮幒鏂哄亾閿濆簶鍋撻娑欐珚闁哄被鍔岄埞鎴﹀幢濞嗘埈鍞归梺璇插濮樸劑骞婇幘缁樼畳闂備焦瀵х换鍌炲箠鎼粹垾锝嗙節濮橆厾鍘撻柣鐘叉穿鐏忔瑧绮绘繝姘厸鐎光偓鐎ｎ剛袦闂佺硶鏂侀崑鎾愁渻閵堝棗鍧婇柛瀣尭閳规垿鏁嶉崟顒佺彧闂侀�炲苯澧叉い顐㈩槸鐓ら柨鏇炲�搁崹鍌炴煕濡ゅ啫鍓遍柛銈嗩殜閺屾盯寮撮妸銉ヮ潾闂佽崵鍠庣紞濠囧蓟濞戙垹鍐�闁靛牆鎳庨埛澶愭煟鎼淬垺鐨戦柟铏崌濠�渚�姊洪幐搴ｇ畵婵炶绠戦埢宥夊即閵忥紕鍘梺鍓插亽閸嬪嫭绂嶆导瀛樼厸鐎光偓鐎ｎ剛鐦堥悗瑙勬礃鐢帡鍩ユ径濠庢僵妞ゆ挾鍋為悵顒勬⒑鐠囧弶鍞夋い顐㈩槸鐓ら柨鏇炲�搁崹鍌炴煕濡ゅ啫鍓遍柛銈嗩殜閺屾盯寮撮妸銉ヮ潾闂佽崵鍠庣紞濠囧蓟濞戙垹鍐�闁靛牆鎳庨埛澶愭煟鎼淬垺鐨戦柟铏崌濠�渚�姊洪幐搴ｇ畵婵炴潙鍊块幃鐐淬偅閸愨晝鍘介梺鍦劋閹稿濡靛┑瀣厸鐎光偓鐎ｎ剛袦闂佺硶鏂侀崜婵堢箔閻斿摜绡�闁告劏鏅滃В搴ㄦ⒑鐠囧弶鍞夋い顐㈩槸鐓ら柨鏇炲�搁崹鍌炴煕濡ゅ啫鍓遍柛銈嗩殜閺屾盯寮撮妸銉ヮ潾闂佽崵鍠庣紞濠囧蓟濞戙垹鍐�闁靛牆鎳庨埛澶愭煟鎼淬垺鐨戦柟铏崌濠�渚�姊洪幐搴ｇ畵妞わ箒妫勮灋闁硅揪闄勯悡鐔兼煟閺冨牜妫戠紒澶嬫そ閺岋紕浠﹂崜褎鍒涢悗娈垮櫘閸撶喖骞冮閿亾濞戞顏堫敂閸洘鈷戦柤瑙勬緲椤ュ秵绻涙径瀣创闁绘侗鍣ｉ崺鈧い鎺戝閳锋帒霉閿濆懏鍟為柟顖氱墦閺屾稓鈧綆浜濋ˉ銏⑩偓瑙勬磸閸ㄦ椽濡堕敐澶婄闁宠桨妞掑Σ鎰版⒒娴ｇ儤鍤�妞ゆ洦鍘介幈銊╂煥鐎ｃ劋绮撮梺鍛婂姇濡﹪鎮㈤崱娑欑厾闁告縿鍎查弳鈺呮煏閸℃ê绗х紒杈ㄥ浮閸┾偓妞ゆ帒瀚獮銏＄箾閹寸偟鎳呴柛娆忔閳规垿鎮欓弶鎴犱紘濠电偛鎳忓ú婊堝焵?
// 婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犱即鏌涘┑鍕姢闁活厽鎸搁—鍐偓锝庝簼閹癸綁鏌ｉ鐐搭棦闁诡喗顨婇弫鎰償閳ヨ尙鏁栨俊鐐�愰弲婵嬪礂濮椻偓楠炲啰鎲撮崟顒�顎撻梺鍛婄缚閸庤崵妲愰悙鐢电＝濞达絽澹婂Σ鍛婄箾绾绡�妤犵偛鍟抽妵鎰板箳閹寸姷鏉搁梻浣告啞閹搁绮堟笟鈧、姘舵焼瀹ュ棌鎷洪梺鑽ゅ枑婢瑰棝鎮鹃銏＄厱闁靛鍊楅惌娆戔偓娈垮櫘閸嬪嫰顢樻總绋跨倞闁挎棁妫勬刊浼存⒒娴ｈ棄袚闁挎碍銇勯敃鍌欐喚濠碘�崇埣椤㈡岸鍩�椤掆偓椤繐煤椤忓拋妫冮梺鍐叉惈鐎氼噣藝娴煎瓨鈷戦柛娑橈攻閻撱儳绱掔紒姗堣�块柕鍡曠椤繈顢楁径瀣厞闂佸搫顦悧鍐疾濠靛鍋傞悗锝庡枟閸婂灚顨ラ悙鑼虎闁告梹宀搁幃妤�顫濋悡搴♀拫闂佺硶鏂傞崹鑲╃不濞戞ǚ妲堟繛鍡樺灥楠炴姊绘笟鈧埀顒傚仜閼活垱鏅堕灏栨斀闁炽儳鍋ㄩ崑銏ゆ煛鐏炲墽娲存鐐差儔椤㈡稑顭ㄩ崨顖涱潓闂傚倷绀佸﹢閬嶅磻閵娾晛鍨傚ù鐘差儏缁犳椽骞栧ǎ顒�濡肩痪鎯у悑缁绘繃绻濋崒娑樻濡炪倖鎸搁…宄邦潖缂佹ɑ濯撮柛娑橈工閺嗗牓姊洪崷顓х劸闁硅姤绮庨崚鎺楀籍閸繄顔掑銈嗘閸嬫劙鎮块崨瀛樷拺閻犳亽鍔岄弸鏂库攽椤旂偓鏆�规洘娲栬灃闁告侗鍠氶崢顏呯節閵忥絾纭鹃柣妤�妫濆畷婵嗩潩閼搁潧浠繛杈剧到濠�閬嶅矗閳ь剟姊洪崫鍕潶闁稿﹥绻堥獮鏍亹閹烘繃鏅濋梺闈涙禋濠⑩偓闁哥姴锕︾槐鎾诲磼濞嗘埈妲悷婊勬緲椤﹂潧鐣烽敓鐘茬闁芥ê顦抽幗鏇㈡⒑閸涘﹦鈽夐柣掳鍔戝畷鎴﹀箛閻楀牏鍘遍梺褰掑亰閸ㄤ即鎯冮崫鍔界懓顭ㄩ幇顔煎煂闂佸疇顫夐崹鍧椼�佸▎鎾村仼鐎光偓閳ь剛妲愭导瀛樷拺缂佸灏呴弨缁樸亜閵娿儳澧︽鐐插暣椤㈡岸鍩�椤掑嫨鈧線寮撮姀鈩冩珖闂侀�炲苯澧扮紒顔碱煼瀵濡烽敂鎯у箺闂備礁鎼崐褰掝敄濞嗗繆鏋旈柣妯肩帛閻撴洟鏌ｉ幇顒傛憼闁靛洦绻堥弻鈥崇暆鐎ｎ剛袦婵犵鍓濋幃鍌涗繆閻戣棄唯妞ゆ棁宕靛Λ顖炴⒒閸屾瑨鍏屾い顓炵墛椤ㄣ儵宕妷锕�搴婂┑掳鍊曢幊搴㈩攰闂備浇顫夊妯绘償濠婂懐绀婇柡宥冨妸娴滄粓鏌熼幑鎰【閸熸悂姊洪悷鐗堚枙闁哥姵顨堥幑銏犫槈濮橈絽浜炬繛鎴炵懐閻掍粙鏌ｅ鍡╁殭闁宠鍨块崹楣冩惞椤愩垺鐏庨柣搴ゎ潐濞叉鎹㈤崱娴板洭鎮烽幍铏杸闂佹枼鏅涢崯顖滀焊閿曞倹鐓涘ù锝堫潐瀹曞矂鏌℃担瑙勫磳闁�?
//-----------------------------------------------------------------------------
// Copyright (C) 2012-2020 闂傚倸鍊搁崐鎼佸磹閹间礁纾诲┑鐘叉搐缁狀垶鏌ｉ幋锝呅撻柣鎾存礃閵囧嫰顢橀悢椋庝淮闂佸搫顑囬崰鏍蓟閿濆围閹肩补鍓濋悘鎾剁磽娴ｄ粙鍝洪柟绋款煼楠炲繘宕ㄩ弶鎴﹀敹濠电娀娼уΛ宀勫磻閹剧粯鍤掗柕鍫濇矗缁楀绻涚�电孝妞ゆ垵妫濋幃锟犳偐濞村鏂�闂佺鏈崙鐟拔ｆ搴ｇ＜闁靛鐓堥崵娆撴煃鐟欏嫬鐏存い銏＄懅閹叉挳宕熼鍌氱秲闂佽姘﹂～澶娒哄鍕闁逞屽墰閳ь剚顔栭崰鏇犲垝濞嗘劒绻嗛柟闂寸劍閺呮粓鏌涢幘妤�瀚鎴︽⒒閸屾艾鈧悂宕愰幖浣哥９闁告縿鍎崑鎾愁潩閻撳骸绫嶉悗瑙勬礃缁诲牆顕ｉ幘顔碱潊闁绘鏁搁崢顒勬⒒娴ｅ憡鎯堟繛灞傚灲瀹曠銇愰幒鎾冲壒濠德板�曢幊蹇涙偂閵夆晜鐓熼柡鍥╁仜閳ь剙婀遍埀?All Rights Reserved
// 闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敃鈧壕鍦磼鐎ｎ偓绱╂繛宸簼閺呮煡鏌涘☉鍙樼凹闁诲骸顭峰娲濞戞氨鐤勯梺绋匡攻濞叉粓骞夐幘顔芥櫇闁稿本绋撻崣鍡涙⒑缂佹ɑ绀�闁稿﹤婀遍埀?    闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熼悜姗嗘闁轰礁妫欓妵鍕敂鎼达綆鍞�2515.c
// 濠电姷鏁告慨鐑姐�傞挊澹╋綁宕ㄩ弶鎴濈�銈呯箰閻楀﹪寮查幖浣圭厱濠电姴瀚弸鎴︽煟濠垫劒閭柡灞剧〒閳ь剨绲婚崝宀勫礉閿曞倹鐓涚�光偓閳ь剟宕伴幘璇茬闁绘绮崵鎴炪亜閹烘垵浜為柛鐔风墦濮婄粯鎷呯粙娆炬闂佺顑嗛幑鍥嵁? SPI闂傚倸鍊风粈渚�骞栭位鍥焼瀹ュ懐锛涢梺缁樻煥椤ㄥ酣宕靛Δ鍐ｅ亾楠炲灝鍔撮柡浣哥埣濮婂宕掑▎鎴犵崲濠碘槅鍋夊▔鏇㈠箯閸愵喗鏅濋柛灞捐壘閻庮參姊洪幆褎绂嬮柛瀣噹閳诲秹鎮╃紒妯煎幐婵犮垼娉涢鍡楃毈p2515闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁逞屽墴閸┾偓妞ゆ帊鑳堕悡顖炴煕濡や礁鈻曠�规洘妞介幃娆忣啅椤斿吋鍊┑鐘灱濞夋盯鏁冮敃鍋瑰洭顢氶埀顒�顫忛搹瑙勫磯闁靛鍎查悵銏ゆ⒑?
// 濠电姷鏁告慨鐑姐�傞挊澹╋綁宕ㄩ弶鎴濈�銈呯箰閻楀﹪寮查幖浣圭厱濠电姴瀚弸鎴︽煟濠垫劒閭柡灞剧〒閳ь剨绲婚崝宀勫礉閿曞倹鐓涚�光偓鐎ｎ剙鍩岄柧缁樼墵閺屻劑鎮㈤崜浣虹厯闂佽鍟崟顓犵槇闂佺鐭夌粻鎺楀焵椤掆偓濞硷繝寮婚妸鈺傚亞闁稿本绋戦? V1.00
// 闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁嶉崟顒佹濠德板�曢崯浼存儗濞嗘挻鐓欓悗鐢殿焾鍟哥紒鎯у綖缁瑩寮婚悢鐓庣畾鐟滄粓宕甸悢鎼炰簻闁冲搫鍊婚崣鈧梺鍝勬湰缁嬫垿鍩為幋锕�骞㈡俊銈咃梗閻ヮ亪姊绘担鍛婃喐濠殿垱鎸抽獮? zhb
// 闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁嶉崟顒佹濠德板�曢崯浼存儗濞嗘挻鐓欓悗鐢殿焾鍟哥紒鎯у綖缁瑩寮婚悢鐓庣闁逛即娼у▓顓犵磽娓氬洤浜滅紒澶婄秺瀵鈽夐姀鈺傛櫇闂佹寧绻傚Λ娑⑺囬妸鈺傗拺闁圭楠搁崰鏇㈡煙? 11/01.2017
// =============================================================================

#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include "os.h"
#include "djybus.h"
#include "spibus.h"
#include "mcp2515.h"
#include "cpu_peri.h"
#include "board-config.h"
#include "ring.h"
#include "shell.h"
#include "canbus.h"
#include "project_config.h"     //本文件由IDE中配置界面生成，存放在APP的工程目录中。
                                //允许是个空文件，所有配置将按默认值配置。

//@#$%component configure   ****组件配置开始，用于 DIDE 中图形化配置界面
//****配置块的语法和使用方法，参见源码根目录下的文件：component_config_readme.txt****
//%$#@initcode      ****初始化代码开始，由 DIDE 删除“//”后copy到初始化文件中
//extern bool_t ModuleInstall_MCP2515(char *BusName,u32  baudrate);
//    if( ModuleInstall_MCP2515(CFG_MCP2515_BUS_NAME,CFG_MCP2515_SPEED) == false)
//    {
//        printf("MCP2515 Install Error!\r\n");
//        while( 1 );
//    }
//%$#@end initcode  ****初始化代码结束

//%$#@describe      ****组件描述开始
//component name:"mcp2515"               //填写该组件的名字
//parent:"none"                          //填写该组件的父组件名字，none表示没有父组件
//attribute:bsp组件                                                                     //选填“第三方组件、核心组件、bsp组件、用户组件”，本属性用于在IDE中分组
//select:可选                                                                                      //选填“必选、可选”，若填必选且需要配置参数，则IDE裁剪界面中默认勾取，
                                        //不可取消，必选且不需要配置参数的，IDE裁剪界面中不显示
//grade:init                            //初始化时机，可选值：none，init，main。none表示无须初始化，
                                        //init表示在调用main之前，main表示在main函数中初始化
//dependence:"lock","spibus",           //该组件的依赖组件名（可以是none，表示无依赖组件），
                                        //选中该组件时，被依赖组件将强制选中，
                                        //如果依赖多个组件，则依次列出，用“,”分隔
//weakdependence:"none"                 //该组件的弱依赖组件名（可以是none，表示无依赖组件），
                                        //选中该组件时，被依赖组件不会被强制选中，
                                        //如果依赖多个组件，则依次列出，用“,”分隔
//mutex:"none"                          //该组件的依赖组件名（可以是none，表示无依赖组件），
                                        //如果依赖多个组件，则依次列出，用“,”分隔
//%$#@end describe  ****组件描述结束

//%$#@configue      ****参数配置开始
//%$#@target = header           //配置后生成头文件还是命令行变量
#ifndef CFG_MCP2515_SAM_MODE   //****检查参数是否已经配置好
#warning    MCP2515组件参数未配置，使用默认值
//%$#@num,0,100,
#define CFG_MCP2515_SPEED                 (10*1000*1000)     //"SPI总线速度",配置MCP2515的SPI总线速度
//%$#@enum,true,false,
//%$#@string,1,10,
#define CFG_MCP2515_BUS_NAME              "SPI0"             //"SPI总线名称",MCP2515的总线名称
//%$#select,        ***������ֵ�ĺ꣬�����ڵ��������
//%$#@free,
#endif
//%$#@end configue  ****参数配置结束
//@#$%component end configure

/* Configuration Registers */
#define Mcp2515_CANSTAT         0x0E
#define Mcp2515_CANCTRL         0x0F
#define Mcp2515_BFPCTRL         0x0C
#define Mcp2515_TEC             0x1C
#define Mcp2515_REC             0x1D
#define Mcp2515_CNF3            0x28
#define Mcp2515_CNF2            0x29
#define Mcp2515_CNF1            0x2A
#define Mcp2515_CANINTE         0x2B
#define Mcp2515_CANINTF         0x2C
#define Mcp2515_EFLG            0x2D
#define Mcp2515_TXRTSCTRL       0x0D
/*  Recieve Filters */
#define Mcp2515_RXF0SIDH        0x00
#define Mcp2515_RXF0SIDL        0x01
#define Mcp2515_RXF0EID8        0x02
#define Mcp2515_RXF0EID0        0x03
#define Mcp2515_RXF1SIDH        0x04
#define Mcp2515_RXF1SIDL        0x05
#define Mcp2515_RXF1EID8        0x06
#define Mcp2515_RXF1EID0        0x07
#define Mcp2515_RXF2SIDH        0x08
#define Mcp2515_RXF2SIDL        0x09
#define Mcp2515_RXF2EID8        0x0A
#define Mcp2515_RXF2EID0        0x0B
#define Mcp2515_RXF3SIDH        0x10
#define Mcp2515_RXF3SIDL        0x11
#define Mcp2515_RXF3EID8        0x12
#define Mcp2515_RXF3EID0        0x13
#define Mcp2515_RXF4SIDH        0x14
#define Mcp2515_RXF4SIDL        0x15
#define Mcp2515_RXF4EID8        0x16
#define Mcp2515_RXF4EID0        0x17
#define Mcp2515_RXF5SIDH        0x18
#define Mcp2515_RXF5SIDL        0x19
#define Mcp2515_RXF5EID8        0x1A
#define Mcp2515_RXF5EID0        0x1B
/* Receive Masks */
#define Mcp2515_RXM0SIDH        0x20
#define Mcp2515_RXM0SIDL        0x21
#define Mcp2515_RXM0EID8        0x22
#define Mcp2515_RXM0EID0        0x23
#define Mcp2515_RXM1SIDH        0x24
#define Mcp2515_RXM1SIDL        0x25
#define Mcp2515_RXM1EID8        0x26
#define Mcp2515_RXM1EID0        0x27
/* Tx Buffer 0 */
#define Mcp2515_TXB0CTRL        0x30
#define Mcp2515_TXB0SIDH        0x31
#define Mcp2515_TXB0SIDL        0x32
#define Mcp2515_TXB0EID8        0x33
#define Mcp2515_TXB0EID0        0x34
#define Mcp2515_TXB0DLC         0x35
#define Mcp2515_TXB0D0          0x36
#define Mcp2515_TXB0D1          0x37
#define Mcp2515_TXB0D2          0x38
#define Mcp2515_TXB0D3          0x39
#define Mcp2515_TXB0D4          0x3A
#define Mcp2515_TXB0D5          0x3B
#define Mcp2515_TXB0D6          0x3C
#define Mcp2515_TXB0D7          0x3D
/* Tx Buffer 1 */
#define Mcp2515_TXB1CTRL        0x40
#define Mcp2515_TXB1SIDH        0x41
#define Mcp2515_TXB1SIDL        0x42
#define Mcp2515_TXB1EID8        0x43
#define Mcp2515_TXB1EID0        0x44
#define Mcp2515_TXB1DLC         0x45
#define Mcp2515_TXB1D0          0x46
#define Mcp2515_TXB1D1          0x47
#define Mcp2515_TXB1D2          0x48
#define Mcp2515_TXB1D3          0x49
#define Mcp2515_TXB1D4          0x4A
#define Mcp2515_TXB1D5          0x4B
#define Mcp2515_TXB1D6          0x4C
#define Mcp2515_TXB1D7          0x4D
/* Tx Buffer 2 */
#define Mcp2515_TXB2CTRL        0x50
#define Mcp2515_TXB2SIDH        0x51
#define Mcp2515_TXB2SIDL        0x52
#define Mcp2515_TXB2EID8        0x53
#define Mcp2515_TXB2EID0        0x54
#define Mcp2515_TXB2DLC         0x55
#define Mcp2515_TXB2D0          0x56
#define Mcp2515_TXB2D1          0x57
#define Mcp2515_TXB2D2          0x58
#define Mcp2515_TXB2D3          0x59
#define Mcp2515_TXB2D4          0x5A
#define Mcp2515_TXB2D5          0x5B
#define Mcp2515_TXB2D6          0x5C
#define Mcp2515_TXB2D7          0x5D
/* Rx Buffer 0 */
#define Mcp2515_RXB0CTRL        0x60
#define Mcp2515_RXB0SIDH        0x61
#define Mcp2515_RXB0SIDL        0x62
#define Mcp2515_RXB0EID8        0x63
#define Mcp2515_RXB0EID0        0x64
#define Mcp2515_RXB0DLC         0x65
#define Mcp2515_RXB0D0          0x66
#define Mcp2515_RXB0D1          0x67
#define Mcp2515_RXB0D2          0x68
#define Mcp2515_RXB0D3          0x69
#define Mcp2515_RXB0D4          0x6A
#define Mcp2515_RXB0D5          0x6B
#define Mcp2515_RXB0D6          0x6C
#define Mcp2515_RXB0D7          0x6D
/* Rx Buffer 1 */
#define Mcp2515_RXB1CTRL        0x70
#define Mcp2515_RXB1SIDH        0x71
#define Mcp2515_RXB1SIDL        0x72
#define Mcp2515_RXB1EID8        0x73
#define Mcp2515_RXB1EID0        0x74
#define Mcp2515_RXB1DLC         0x75
#define Mcp2515_RXB1D0          0x76
#define Mcp2515_RXB1D1          0x77
#define Mcp2515_RXB1D2          0x78
#define Mcp2515_RXB1D3          0x79
#define Mcp2515_RXB1D4          0x7A
#define Mcp2515_RXB1D5          0x7B
#define Mcp2515_RXB1D6          0x7C
#define Mcp2515_RXB1D7          0x7D
/*******************************************************************
*               Bit register masks                                *
*******************************************************************/
/* TXBnCTRL */
#define Mcp2515_TXREQ           0x08
#define Mcp2515_TXP             0x03
/* RXBnCTRL */
#define Mcp2515_RXM             0x60
#define Mcp2515_BUKT            0x04
/* CANCTRL */
#define Mcp2515_REQOP           0xE0
#define Mcp2515_ABAT            0x10
#define Mcp2515_OSM             0x08
#define Mcp2515_CLKEN           0x04
#define Mcp2515_CLKPRE          0x03
/* CANSTAT */
#define Mcp2515_REQOP           0xE0
#define Mcp2515_ICOD            0x0E
/* CANINTE */
#define Mcp2515_RX0IE           0x01
#define Mcp2515_RX1IE           0x02
#define Mcp2515_TX0IE           0x04
#define Mcp2515_TX1IE           0x80
#define Mcp2515_TX2IE           0x10
#define Mcp2515_ERRIE           0x20
#define Mcp2515_WAKIE           0x40
#define Mcp2515_MERRE           0x80
/* CANINTF */
#define Mcp2515_RX0IF           0x01
#define Mcp2515_RX1IF           0x02
#define Mcp2515_TX0IF           0x04
#define Mcp2515_TX1IF           0x80
#define Mcp2515_TX2IF           0x10
#define Mcp2515_ERRIF           0x20
#define Mcp2515_WAKIF           0x40
#define Mcp2515_MERRF           0x80
/* BFPCTRL */
#define Mcp2515_B1BFS           0x20
#define Mcp2515_B0BFS           0x10
#define Mcp2515_B1BFE           0x08
#define Mcp2515_B0BFE           0x04
#define Mcp2515_B1BFM           0x02
#define Mcp2515_B0BFM           0x01
/* CNF1 Masks */
#define Mcp2515_SJW             0xC0
#define Mcp2515_BRP             0x3F
/* CNF2 Masks */
#define Mcp2515_BTLMODE         0x80
#define Mcp2515_SAM             0x40
#define Mcp2515_PHSEG1          0x38
#define Mcp2515_PRSEG           0x07
/* CNF3 Masks */
#define Mcp2515_WAKFIL          0x40
#define Mcp2515_PHSEG2          0x07
/* TXRTSCTRL Masks */
#define Mcp2515_TXB2RTS         0x04
#define Mcp2515_TXB1RTS         0x02
#define Mcp2515_TXB0RTS         0x01
/*******************************************************************
*                    Bit Timing Configuration                     *
*******************************************************************/
/* CNF1 */
#define Mcp2515_SJW_1TQ         0x40
#define Mcp2515_SJW_2TQ         0x80
#define Mcp2515_SJW_3TQ         0x90
#define Mcp2515_SJW_4TQ         0xC0
/* CNF2 */
#define Mcp2515_BTLMODE_CNF3    0x80
#define Mcp2515_BTLMODE_PH1_IPT 0x00
#define Mcp2515_SMPL_3X         0x40
#define Mcp2515_SMPL_1X         0x00
#define Mcp2515_PHSEG1_8TQ      0x38
#define Mcp2515_PHSEG1_7TQ      0x30
#define Mcp2515_PHSEG1_6TQ      0x28
#define Mcp2515_PHSEG1_5TQ      0x20
#define Mcp2515_PHSEG1_4TQ      0x18
#define Mcp2515_PHSEG1_3TQ      0x10
#define Mcp2515_PHSEG1_2TQ      0x08
#define Mcp2515_PHSEG1_1TQ      0x00
#define Mcp2515_PRSEG_8TQ       0x07
#define Mcp2515_PRSEG_7TQ       0x06
#define Mcp2515_PRSEG_6TQ       0x05
#define Mcp2515_PRSEG_5TQ       0x04
#define Mcp2515_PRSEG_4TQ       0x03
#define Mcp2515_PRSEG_3TQ       0x02
#define Mcp2515_PRSEG_2TQ       0x01
#define Mcp2515_PRSEG_1TQ       0x00
/* CNF3 */
#define Mcp2515_PHSEG2_8TQ      0x07
#define Mcp2515_PHSEG2_7TQ      0x06
#define Mcp2515_PHSEG2_6TQ      0x05
#define Mcp2515_PHSEG2_5TQ      0x04
#define Mcp2515_PHSEG2_4TQ      0x03
#define Mcp2515_PHSEG2_3TQ      0x02
#define Mcp2515_PHSEG2_2TQ      0x01
#define Mcp2515_PHSEG2_1TQ      0x00
#define Mcp2515_SOF_ENABLED     0x80
#define Mcp2515_WAKFIL_ENABLED  0x40
#define Mcp2515_WAKFIL_DISABLED 0x00
/*******************************************************************
*                  Control/Configuration Registers                *
*******************************************************************/
/* CANINTE */
#define Mcp2515_RX0IE_ENABLED   0x01
#define Mcp2515_RX0IE_DISABLED  0x00
#define Mcp2515_RX1IE_ENABLED   0x02
#define Mcp2515_RX1IE_DISABLED  0x00
#define Mcp2515_G_RXIE_ENABLED  0x03
#define Mcp2515_G_RXIE_DISABLED 0x00
#define Mcp2515_TX0IE_ENABLED   0x04
#define Mcp2515_TX0IE_DISABLED  0x00
#define Mcp2515_TX1IE_ENABLED   0x08
#define Mcp2515_TX2IE_DISABLED  0x00
#define Mcp2515_TX2IE_ENABLED   0x10
#define Mcp2515_TX2IE_DISABLED  0x00
#define Mcp2515_G_TXIE_ENABLED  0x1C
#define Mcp2515_G_TXIE_DISABLED 0x00
#define Mcp2515_ERRIE_ENABLED   0x20
#define Mcp2515_ERRIE_DISABLED  0x00
#define Mcp2515_WAKIE_ENABLED   0x40
#define Mcp2515_WAKIE_DISABLED  0x00
#define Mcp2515_IVRE_ENABLED    0x80
#define Mcp2515_IVRE_DISABLED   0x00
/* CANINTF */
#define Mcp2515_RX0IF_SET       0x01
#define Mcp2515_RX0IF_RESET     0x00
#define Mcp2515_RX1IF_SET       0x02
#define Mcp2515_RX1IF_RESET     0x00
#define Mcp2515_TX0IF_SET       0x04
#define Mcp2515_TX0IF_RESET     0x00
#define Mcp2515_TX1IF_SET       0x08
#define Mcp2515_TX2IF_RESET     0x00
#define Mcp2515_TX2IF_SET       0x10
#define Mcp2515_TX2IF_RESET     0x00
#define Mcp2515_ERRIF_SET       0x20
#define Mcp2515_ERRIF_RESET     0x00
#define Mcp2515_WAKIF_SET       0x40
#define Mcp2515_WAKIF_RESET     0x00
#define Mcp2515_IVRF_SET        0x80
#define Mcp2515_IVRF_RESET      0x00
/* CANCTRL */
#define Mcp2515_REQOP_CONFIG    0x80
#define Mcp2515_REQOP_LISTEN    0x60
#define Mcp2515_REQOP_LOOPBACK  0x40
#define Mcp2515_REQOP_SLEEP     0x20
#define Mcp2515_REQOP_NORMAL    0x00
#define Mcp2515_ABORT           0x10
#define Mcp2515_OSM_ENABLED     0x08
#define Mcp2515_CLKOUT_ENABLED  0x04
#define Mcp2515_CLKOUT_DISABLED 0x00
#define Mcp2515_CLKOUT_PRE_8    0x03
#define Mcp2515_CLKOUT_PRE_4    0x02
#define Mcp2515_CLKOUT_PRE_2    0x01
#define Mcp2515_CLKOUT_PRE_1    0x00
/* CANSTAT */
#define Mcp2515_OPMODE_CONFIG   0x80
#define Mcp2515_OPMODE_LISTEN   0x60
#define Mcp2515_OPMODE_LOOPBACK 0x40
#define Mcp2515_OPMODE_SLEEP    0x20
#define Mcp2515_OPMODE_NORMAL   0x00
/* RXBnCTRL */
#define Mcp2515_RXM_RCV_ALL     0x60
#define Mcp2515_RXM_VALID_EXT   0x40
#define Mcp2515_RXM_VALID_STD   0x20
#define Mcp2515_RXM_VALID_ALL   0x00
#define Mcp2515_RXRTR_REMOTE    0x08
#define Mcp2515_RXRTR_NO_REMOTE 0x00
#define Mcp2515_BUKT_ROLLOVER    0x04
#define Mcp2515_BUKT_NO_ROLLOVER 0x00
#define Mcp2515_FILHIT0_FLTR_1  0x01
#define Mcp2515_FILHIT0_FLTR_0  0x00
#define Mcp2515_FILHIT1_FLTR_5  0x05
#define Mcp2515_FILHIT1_FLTR_4  0x04
#define Mcp2515_FILHIT1_FLTR_3  0x03
#define Mcp2515_FILHIT1_FLTR_2  0x02
#define Mcp2515_FILHIT1_FLTR_1  0x01
#define Mcp2515_FILHIT1_FLTR_0  0x00
/* TXBnCTRL */
#define Mcp2515_TXREQ_SET       0x08
#define Mcp2515_TXREQ_CLEAR     0x00
#define Mcp2515_TXP_HIGHEST     0x03
#define Mcp2515_TXP_INTER_HIGH  0x02
#define Mcp2515_TXP_INTER_LOW   0x01
#define Mcp2515_TXP_LOWEST      0x00
/*******************************************************************
*                  Register Bit Masks                             *
*******************************************************************/
#define Mcp2515_DLC_0          0x00
#define Mcp2515_DLC_1          0x01
#define Mcp2515_DLC_2          0x02
#define Mcp2515_DLC_3          0x03
#define Mcp2515_DLC_4          0x04
#define Mcp2515_DLC_5          0x05
#define Mcp2515_DLC_6          0x06
#define Mcp2515_DLC_7          0x07
#define Mcp2515_DLC_8          0x08
/*******************************************************************
*                  CAN SPI commands                               *
*******************************************************************/
#define Mcp2515_SPI_RESET       0xC0
#define Mcp2515_SPI_READ        0x03
#define Mcp2515_SPI_WRITE       0x02
#define Mcp2515_SPI_RTS         0x80
#define Mcp2515_SPI_RTS_TXB0    0x81
#define Mcp2515_SPI_RTS_TXB1    0x82
#define Mcp2515_SPI_RTS_TXB2    0x84
#define Mcp2515_SPI_READ_STATUS 0xA0
#define Mcp2515_SPI_BIT_MODIFY  0x05
#define Mcp2515_SPI_RX_STATUS   0xB0
#define Mcp2515_SPI_READ_RX          0x90
#define Mcp2515_SPI_WRITE_TX    0X40
/*******************************************************************
*                  Miscellaneous                                  *
*******************************************************************/
#define Mcp2515_DUMMY_BYTE      0x00
#define Mcp2515_TXB0            0x31
#define Mcp2515_TXB1            0x41
#define Mcp2515_TXB2            0x51
#define Mcp2515_RXB0            0x61
#define Mcp2515_RXB1            0x71
#define Mcp2515_EXIDE_SET       0x08
#define Mcp2515_EXIDE_RESET     0x00
/**************************************************************
*                  CAN Speed                                 *
*************************************************************/
#define Mcp2515_CAN_10Kbps          0x31
#define Mcp2515_CAN_25Kbps          0x13
#define Mcp2515_CAN_50Kbps             0x09
#define Mcp2515_CAN_100Kbps         0x04
#define Mcp2515_CAN_125Kbps            0x03
#define Mcp2515_CAN_250Kbps         0x01
#define Mcp2515_CAN_500Kbps         0x00
/*Frame Definition*/

#define MCP2515_SPI_SPEED      (1000*1000)    //1MHz
#define CN_MCP2515_MSGQ_LEN        13
#define CN_MCP2515_MSGQ_NUM       200
#define CN_MCP2515_RCV_LEN        (200*13)

static struct CANBusCB * p_MCP2515_CBHandle;//MCP2515闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁告洦鍋勯幆鐐寸節閻㈤潧顎岄柡瀣墵濮婂宕掑▎鎰偘濡炪倖娲橀悧鐘茬暦濠婂啠鏀介柛鈩冪懄濞堥箖姊哄Ч鍥х伄妞ゎ厼鐗撳畷銉ㄣ亹閹烘垹顔愬┑鐑囩秵閸撴瑦淇婇懖鈺冪＜闁绘灏欓敍宥夋煙閼碱剦鐒炬い鎾冲悑瀵板嫭绻濋崘鈹碍绻濆閿嬫緲閳ь剚娲熼獮濠冩償閵婏妇鍙嗛梺闈涚墕濡梻鎹㈤崱娑欑厪闁割偅绻冮崳褰掓煛閸℃瑥鏋戠紒缁樼♁瀵板嫰宕煎┑鍫滅礄闂備礁鎼惌澶屾閺囥垹鐒垫い鎺戯功缁夐潧霉濠婂嫮鐭掓い銏℃椤﹀绱掓潏銊﹀碍妞ゆ捁澹堢粻娑㈠棘濞嗗彞绱�,闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敂钘変罕濠电姴锕ら悧鍡欑矆閸喐鍙忔俊顖氭惈閺嗛亶鏌￠崱娆忎槐婵﹦绮幏鍛瑹椤栨稓绉洪梻浣告啞濞叉牠鎮樺鑸靛仼闁割偅娲橀崑鈩冪節婵犲倸顏╂い搴㈢矒閹绠涢弮鍌涘櫚濡ょ姷鍋涢ˇ鐢哥嵁濮椻偓椤㈡瑩鎳為妷锔讳户闂傚倷娴囧▔鏇㈠闯閿曞倸绠�?
static struct SPI_Device s_MCP2515_Dev;
static u32 s_MCP2515_Timeout = 50*mS;

static bool_t sMCP2515Inited = false;

static struct SemaphoreLCB s_MCP2515_Semp;   //闂傚倸鍊搁崐椋庢濮橆儵娑氭崉閵婏箑顎忛梺鎸庢礀閸婃悂宕归崒鐐寸叄闊浄绲芥禍婵囩箾閸涱垰鈻堥柡灞糕偓鎰佸悑闁告劑鍔岄‖瀣渻閵堝倹娅嗛柣鎿勭節瀵鎮㈤崗鐓庘偓缁樹繆椤栨繍鍤欓梻澶婄Ч濮婅櫣鎷犻懠顒傤啋婵炲瓨绮岄悥濂哥嵁閸愵亝鍠嗛柛鏇ㄥ墮椤庢捇姊洪崨濠勨槈闁挎洏鍊栫粋鎺楀级閹存梹鏂�闂佸疇妫勫Λ妤佺椤栫偞鐓曢柍鍝勫�绘晶杈╃磼椤旇棄鍝虹�规洩绻濋幃娆撳煛閸屾稒婢戦梻鍌欑劍閹爼宕曞ú顏呭�舵繝闈涱儐閺�?

static void MCP2515_CsActive(void);
static void MCP2515_CsInActive(void);
static void SPI_Send(uint8_t data);
bool_t MCP2515_Reset(void);

static u32 Mcp2515_baudrate=250;

typedef struct Frame_Strut
{
    unsigned int ID;
    unsigned char DLC;
    CanFrameType Type;
}Frame_TypeDef;

bool_t MCP2515_Read(uint8_t *CAN_RX_Buf,Frame_TypeDef *Frame);
bool_t MCP2515_Write(struct CANBusCB * CANBus,CanFarmeDef *Frame);
bool_t MCP2515_Ctrl(struct CANBusCB * CANBus,uint8_t ctrlcmd,ptu32_t param1,ptu32_t param2);

//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鎳忛崳娲煟閹捐泛鏋戝ǎ鍥э躬婵℃儼绠涢弬娆句紦濠电姷鏁搁崑娑樜熸繝鍥х煑闁告劦鍠栭弸渚�鏌熼崜褏甯涢悗鐢靛Т椤潡鎳滈惉顏呭灦閺呫儲绻濋悽闈浶ｆい鏃�鐗犲畷褰掑箮閽樺锛熼梺闈涚墕椤︻垳绮婚鐐寸厱婵炴垶顭囬幗鐘绘煛閸涱喗鍊愰柡灞诲姂閹倝宕掑☉姗嗕紦
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挾鍠栧濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愭祴鏀介悗锝庝簽椤㈠懘姊虹紒妯虹仴婵☆偅鐟ヨ闁割偁鍎查埛鎺楁煕鐏炲墽鎳呴悹鎰嵆閺屾稓鈧綆浜滈顓㈡寠濠靛鐓熸俊銈傚亾闁绘妫濆畷褰掑籍閸喓鍘介梺鐟邦嚟閸婃牠骞嬮悙鎻掔亖闂佸湱铏庨崰鏍不瑜版帗鐓欑痪鏉垮船楠炴牠鏌ｈ箛銉ф偧缂佽鲸甯￠崺鈧い鎺嶇缁剁偤鏌熼柇锕�骞愰柟宄版惈椤啴濡堕崱妤�顫囬梺绯曟櫅鐎氼剙宓勯梺缁樺灱婵倝鎮￠悩缁樼厱妞ゎ厽鍨垫禍婊堟煟韫囨搩鍤熼柍褜鍓濋～澶娒哄Ο鑽ょ濠电姴鍟╃换鍡涙煙闂傚顦﹂崶鎾⒑缁洘顎嗛柡鍛♁缁�?
//=====================================================================
static void MCP2515_CsActive(void)
{
     SPI_CsActive(&s_MCP2515_Dev,CN_TIMEOUT_FOREVER);
}

//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鎳忛崳娲煟閹捐泛鏋戝ǎ鍥э躬婵℃儼绠涢弬娆句紦濠电姷鏁搁崑娑樜熸繝鍥х煑闁告劦鍠栭弸渚�鏌熼崜褏甯涢悗鐢靛Т椤潡鎳滈惉顏呭灦閺呫儲绻濋悽闈浶ｆい鏃�鐗犲畷褰掑箮閽樺锛熼梺闈涚墕椤︻參鍩�椤掆偓閸熸潙鐣烽崼鏇ㄦ晢濞达綀顫夐鐔兼⒒娴ｈ姤纭堕柛锝忕畵楠�?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挾鍠栧濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愭祴鏀介悗锝庝簽椤㈠懘姊虹紒妯虹仴婵☆偅鐟ヨ闁割偁鍎查埛鎺楁煕鐏炲墽鎳呴悹鎰嵆閺屾稓鈧綆浜滈顓㈡寠濠靛鐓熸俊銈傚亾闁绘妫濆畷褰掑籍閸喓鍘介梺鐟邦嚟閸庢垶绗熷☉娆戠闁割偆鍣ュ▓鏇㈡煙娓氬灝濡奸摶鏍煃瑜滈崜鐔煎箖瑜戠粻娑㈠即閻樼數鍔跺┑鐘灱濞夋盯鎯夐懖鈺侇棜闁芥ê顥㈣ぐ鎺撴櫜闁割偒鍋呯紞鍫ユ煟韫囨挾绠冲褎顨堥幑銏犫槈濮橆剚鐎抽梺鍛婎殘閸嬫﹢宕版繝鍋芥棃鎮╅棃娑楁勃闂佽崵鍠嗛崕鐢搞�佸Ο鑽ら檮缂佸娉曢ˇ鏉款渻閵堝棙灏靛┑顕呭弮瀵�?
//=====================================================================
static void MCP2515_CsInActive(void)
{
    SPI_CsInactive(&s_MCP2515_Dev);
}

//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚婵°倕鍟伴妶鐧愰梻鍌氬�搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂佹寧娲栭崐鎼佸垂閸岀偞鐓曠憸搴ㄣ�冮崱娑樼柧闁归棿鐒﹂悡娆撴倵濞戞顏嗙箔瑜旈弻娑㈠棘鐠恒剱褔鏌熼鑽ょ煓妞ゃ垺绋戦埥澶娾枎韫囨挻鏁梺璇插椤旀牠宕伴幘璇茬閹兼番鍔岀粻鏌ユ煕閺囥劌鐏犲ù鑲╁█閺屾盯寮撮妸銉ヮ潾濠碘�虫▕娴滎亜顫忕紒妯诲闁兼亽鍎埀顒�鍟扮槐鎺楃叕閹绘巻鍋撳┑瀣祦闊洦绋掗弲?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挻宀搁獮鍫ュΩ閵夘喗寤洪梺绯曞墲椤ㄥ懘锝為埡鍐＝濞达絿顭堢痪褎淇婇悙鑸殿棄妞ゎ偄绻愮叅妞ゅ繐绉甸弲婵嬫⒒閸曨偅鍠樼�规洘顨堟禒锕傚礈瑜忛鏇㈡⒑閸撴彃浜為柛鐘查叄閹鈧數纭堕崑鎾斥枔閸喗鐝梺绋款儏閿曨亪鐛崘顓ф▌閻庤娲滈崢褔鍩為幋锕�閱囨繛鎴灻奸崰濠囨⒒閸屾艾鈧娆㈠顒夌劷濠电姵纰嶉埛鏃堟煕閺囥劌浜介柣鏂挎娣囧﹪顢涘▎鎺濆妳闂佺粯甯婄划娆撳蓟濞戙垹绠涢梻鍫熺♁閻忓牓寮堕埡鍌滅畺缂佺粯绋掑蹇涘礈瑜忚ⅲ婵＄偑鍊ら崑鍕囬鐐茬厺闁规崘顕ч柋鍥煛閸モ晛鏋旈柛妯兼暬閺岋綁鎮╅崣澶岊槺闂侀�炲苯澧叉繛鍛礋閹潧鈹戠�ｎ偀鎷洪梺鍛婄箓鐎氼參藟閳ユ剚娓婚悗娑櫳戦崐鎰殽閻愬弶顥㈢�殿噮鍣ｅ畷濂告偄閸涘﹦褰嗛梻鍌欒兌缁垶鎳濇ィ鍐╁仱闁靛ě鈧崑鎾愁潩鏉堛劌娈岄梻鍥ь樀閺屻劌鈹戦崱妯侯槱闂佹悶鍊愰崑鎾斥攽閻橆喖鐏辨繛澶嬬〒缁棁銇愰幒鎴ｆ憰濠电偞鍨惰彜闁哄閰ｉ弻鐔煎级鐠恒劋绮甸梺浼欑悼閸樠囧煘閹达附鍊烽柤纰卞墮椤も偓闂備焦鎮堕崝宀勬倶濠靛鏁嬮柨婵嗩樈閺佸啴鏌ㄩ弮鍥棄濞存粓浜跺娲礈閹绘帊绨肩紓浣筋嚙鐎氱増淇婇崼鏇熸櫇闁稿本绋堥幏娲⒒閸屾氨澧愰柡鍛Т椤﹪顢欓悾宀�鐦堥梺闈涚箚閸╂顢旈崼姘ｅ亾閿曞倸鐐婃い鎺嗗亾缂佲偓閸愨斂浜滈柡鍌涘椤秹鏌曟径鍫濆壄鐟滅増甯楅弲鏌ユ煕椤愵偄浜濈紓宥呯墕閳规垿鎮欓懠顒�顣洪梺缁樼墪閵堢顕ｆ繝姘亜闁绘垶锚閻濅即姊洪悙钘夊姤婵炲懏娲熼幃闈涒攽鐎ｎ偀鎷洪梺鍛婄箓鐎氼參藟閳ユ剚娓婚悗娑櫳戦崐鎰殽閻愬弶顥㈢�殿噮鍣ｅ畷濂告偄閸涘﹦褰嗛梻鍌欒兌缁垶鎳濇ィ鍐╁仱闁靛ě鈧崑鎾愁潩鏉堛劌娈岄梻鍥ь樀閺屻劌鈹戦崱鈺傂у┑鐐叉噺缁捇寮婚敐澶婄闁规惌鍨版慨娑氱磽娴ｄ粙鍝洪悽顖涱殔椤曘儵宕熼鍌滅槇闁硅壈鎻徊浠嬪箖閹达附鈷掑〒姘ｅ亾婵炶壈宕靛濠囧箚瑜滃〒璇裁归悩宸剰闁哄鑳堕埀顒�绠嶉崕閬嵥囬鐐寸厑闁搞儯鍔庣弧鈧梻鍌氱墛缁嬫帡藟閻樼鍋撻崗澶婁壕濠电偞鍨崹娲煕閹烘垯鈧帒顫濋浣规倷婵炲瓨绮嶉〃鍫㈡閹烘鐒垫い鎺嶈兌閻熷綊鏌嶈閸撴瑩鎮鹃悜鑺ュ仺缂佸娉曢娲⒑缂佹ê濮夋い锝勭矙瀵悂寮借濞撳鏌曢崼婵囧櫧缂佺姳鍗抽弻鐔煎礃閼碱剛顔囬梺宕囩帛閹搁箖骞戦崟顓熷仒闁斥晛鍠氬鏃堟⒒娴ｅ憡鎯堥柛濠傜秺椤㈡牕鈻庨幘宕囷紵闂婎偄娲︾粙鎺楁偂濞嗘劑浜滈柡鍐ㄥ�婚幗鍌涚箾閸喓鐭岄柍褜鍓濋～澶娒哄鈧弫瀣渻閵堝棙灏柕鍫㈩焾閻ｇ兘濡搁埡濠冩櫖濠电姴锕ラ崝妤呯嵁閵忥紕绡�闁汇垽娼ф牎濡炪倖姊归悧鐘茬暦娴兼潙鍐�妞ゆ挆鍕珗闂備礁鎲＄粙鏍春閸ャ劎顩茬憸鐗堝笚閻撴洟鎮橀悙鎻掆挃闁靛棙甯￠弻宥囩磼濡椿妫冮梺鍝勮閸旀垿骞冮姀銏″珰婵炲牆顑嗛幐鍓ф閹烘柡鍋撻敐搴濇喚婵☆垪鍋撴俊鐐�戦崹鍝勎涢崘銊ф殾闁靛ň鏅╅弫濠囨煠閹帒鍔ゆ俊鍙夋礃缁绘繈鎮介棃娑楁勃闂佹悶鍔岄悥濂哥嵁閺嶎収鏁冮柨鏇楀亾缂佺媭鍨抽埀顒傛嚀鐎氼厽绔熺�ｎ�綁宕奸妷锔惧幍闂佸壊鐓堥崰鏍汲閺囥垺鐓欐い鏃囧亹鑲栫紓浣介哺鐢顭囪箛娑樜╃憸蹇涙偪閸曨垱鍊甸悷娆忓缁�鍐磼椤旇偐鐒告い銏★耿瀹曟鎮℃惔锝囩嵁闂佽鍑界紞鍡涘磻娓氣偓閸┾偓妞ゆ巻鍋撻柛鐔告綑椤繐煤椤忓嫪绱堕梺鍛婃处閸嬫帗瀵煎畝鍕拺闁硅偐鍋涙俊钘夆攽閻愯韬�规洘妞介幃娆撳传閸曨偄鏁ゆ俊鐐�栭崝褏寰婃禒瀣仧闁绘鐗忕粻楣冩煛婢跺鐏ラ柟顔藉灴閺岋綁鎮㈠┑鍡樺櫧闁活厼妫濋弻?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愬搫顫呴柨娑樺閻﹀牏绱撴担鐟板濞存粏娉涢～蹇撁洪鍕獩婵犵數濮寸�氼參宕抽銏♀拺闁硅偐鍋涙俊鍏肩箾绾绡�鐎殿噮鍋婇獮妯兼嫚閼碱剦鍚呴梻浣告贡閸庛倝寮婚妸锔跨箚濞寸姴顑嗛悡鐔兼煏韫囧﹥娅呴柣蹇ョ節閺岀喓绮欓崹顔芥瘣濡炪倖娲╃紞浣逛繆閹间礁鐓涢柛灞剧♁椤忕喖姊绘担鑺ョ《闁革綇绠撻獮?
//=====================================================================
static u32 MCP2515_TxRx(u8* sdata,u32 slen,u8* rdata, u32 rlen,u32 RecvOff)
{
    struct SPI_DataFrame data;
    s32 result;

    data.RecvBuf = rdata;
    data.RecvLen = rlen;
    data.RecvOff = RecvOff;
    data.SendBuf = sdata;
    data.SendLen = slen;

    result = SPI_Transfer(&s_MCP2515_Dev,&data,true,s_MCP2515_Timeout);
    if(result != CN_SPI_EXIT_NOERR)
        return 0;
    return 1;
}

//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚婵°倕鍟伴妶鐧愰梻鍌氬�搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂佹寧娲栭崐鎼佸垂閸岀偞鐓曠憸搴ㄣ�冮崱娑樼柧闁归棿鐒﹂悡娑㈡煕鐏炰箙顏堝焵椤掍胶澧遍柍?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挾鍠栧濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愭祴鏀介悗锝呯仛閺呫垽姊虹捄銊ユ灁闁哄拋鍋嗛崚鎺楀醇閳垛晛浜鹃柨婵嗛閺嬬喖鏌ｉ幘璺烘瀾缂佺粯鐩畷鍗炍熻箛锝勭凹闁哄懎鐖奸、娆撴倷椤掆偓閺嬫垿姊洪崫鍕垫Ц闁诲繑绻堥崺鈧い鎺嗗亾婵炲皷鈧剚鍤曞┑鐘宠壘瀹告繃銇勯弮鍥棄妞ゅ孩鎹囧娲嚒閵堝懏鐎惧┑鐘灪椤洭寮鈧獮妯肩磼濡攱瀚奸梻浣告啞缁嬫垿鏁冮敃鍌氱疇闁告洦鍨遍悡鏇㈡煏婵炑冨濞堝矂姊哄畷鍥╁笡闁圭懓娲悰顔锯偓锝庡枟閺呮繈鏌嶈閸撶喎顕ｉ崨濠勭懝闁逞屽墴瀵鏁愰崨鍌涙閸┾偓妞ゆ帒瀚崑瀣煕閳╁啰鎳呴柣顓炵墦閺屻劑寮撮悙娴嬪亾瑜版帗鍋傞柕澶涘缁犻箖鏌熺�甸晲绱虫い蹇撶墑閳ь剙鍟埢搴ㄥ箣閻樼绱叉繝寰锋澘鈧劙宕戦幘娣簻闁挎梻鍋撻弳顒勬煟濞戝崬娅嶆鐐村笒铻栭柍褜鍓欓弫顕�姊绘担鐟邦嚋婵☆偂鐒﹂幈銊╁Χ閸�?
//=====================================================================
static void SPI_Send(uint8_t data)
{
     MCP2515_TxRx(&data,1,NULL,0,0);
}

/**
  * @brief  Send a byte to MCP2515 through SPI to return corresponding status you need
  * @param  Add:Address of register
  * @param  Data:the data U need to be sent from MCU to MCP2515
  * @retval none
  */
//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鎳忛崳娲煟閹惧瓨绀嬮柡宀�鍠栭弻鍥晝閳ь剟鐛鈧弻鐔煎礃閹绘帗娈婚梺鍝勭焿缂嶄線寮崘顔肩劦妞ゆ巻鍋撻棁澶愭煟閹达絽袚闁哄懏鎮傞弻銈夊箒閹烘垵濮㈤梺鎰佸灡濞茬喖寮婚妸銉僵妞ゆ挾濮烽鏇㈡⒑閸涘﹦鐭婇柛鐕佸灣閳�?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挻宀搁獮鍫ュΩ閵夘喗寤洪梺绯曞墲椤ㄥ懘锝為鈶╂斀闁炽儱鍟跨痪褔鏌涢妸銉﹀仴妤犵偛鍟灃闁逞屽墴閸┿儲寰勬繛鐐�哄銈嗘寙閸屾粎娉块梻浣哥枃椤曆呯矓瑜版帞宓侀柟鐑樺殾閺冨牆鐒垫い鎺戝缁犳煡鏌涢锝嗙闁绘挻绋戦…璺ㄦ崉娓氼垰鍓板銈嗘礃缁海妲愰幒妤�绠甸柟鐑樼箘閸氬姊洪崫鍕拱缂佸鍨块垾锕傚Ω閳轰胶顦ㄩ梺鍐叉惈閸婂湱鈧碍濞婂缁樻媴娓氼垳鍔哥紓浣虹帛閸旀瑥鐣烽幇鏉垮瀭妞ゆ梻鍋撳▓鎯р攽閳藉棗鐏ラ柕鍡忓亾闂佸搫顑呴柊锝夋偂椤愶箑鐐婇柕濠忕畱绾板秴鈹戦娆炬綈闁绘挴鈧剚娼栭柛婵嗗珔瑜斿畷鎯邦槻妞ゎ剙鐗撻弻锝嗘償閵忕姴姣堥梺鍛婄懃閸燁偊顢氶敐澶婄闁兼亽鍎辨禍婊堟⒑缂佹ɑ灏繛瀵稿厴椤㈡瑦寰勯幇顓涙嫼闁荤姵浜介崝灞解枍閹扮増鐓�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愭祴鏀介柛顐ゅ枎椤庢盯鏌ｉ悢鍝ユ噧閻庢凹鍓熼、鏃傛崉鐞涒剝鏂�濡炪倖姊婚悡顐︻敂閸℃妫滃銈嗘尵婵攱绋夊澶嬬厸闁割偒鍋呴悘鍦涢梻鍌氬�搁崐椋庣矆娓氣偓楠炲鏁嶉崟顐ｇ�抽悗骞垮劚椤︻垶宕掗妸褏纾奸悗锝呯仛閺�?515闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂佹寧娲栭崐鎼佸垂閸岀偞鐓曠憸搴ㄣ�冮崱娑樼柧闁归棿鐒﹂悡娆撴倵濞戞顏嗙箔濮橆厹浜滈柨鏇炲亞濡垹绱掓潏銊ユ诞鐎殿噮鍓涢幑鍕Ω閿旇棄鏋涚紓鍌氬�风粈渚�顢栭崨姝ゅ洭鎮介幖鐐╁亾娓氣偓瀵噣宕煎┑鍫Ч婵＄偑鍊栭幐楣冨窗閹版澘绐楅柡鍥ュ灪閳锋帒霉閿濆懏鎯堥悽顖氱埣閺岀喓鍠婇崡鐐板枈閻庤娲橀崝娆撶嵁閺嶃劍濯撮柣鐔告緲婢瑰嫰姊绘笟鈧褏鎹㈤崱娑樼婵犻潧娲ㄩ々鏌ユ煏閸繍妲归柣鎾寸洴閺屾稓浠﹂崜褉妲堝銈嗘礃缁海妲愰幒妤�鐒垫い鎺戝閺呯霉閻樺樊鍎愰柍閿嬪灴閺屾盯鏁傜拠鎻掑闂佸搫妫欑划鎾诲蓟閻斿壊妲归幖绮光偓鍐茬婵犳鍠栭敃銈夆�﹀畡鎵殾闁割偅娲橀悡銉╂倵閿濆簼鎲惧ù鍏兼崌濮婂宕掑▎鎴濆闂佹椿浜滅紞濠傜暦濠靛棛鏆嗛柍褜鍓熼崺鈧い鎺嶇閸ゎ剟鏌涢悩鎰佹疁妤犵偛鐗撴俊鎼佸煛娴ｄ警鍟囧┑鐐舵彧缁蹭粙骞楀鍫熷仼闂侇剙绉甸埛鎴︽偣閹帒濡兼繛鍛姍閺�?
//=====================================================================
void MCP2515_WriteReg(uint8_t Addr,uint8_t Data)
{
    MCP2515_CsActive();
    SPI_Send(Mcp2515_SPI_WRITE);
    SPI_Send(Addr);
    SPI_Send(Data);
    MCP2515_CsInActive();
}

/**
  * @brief  Send a command to MCP2515 through SPI to return corresponding status you need
  * @param  CMD:command
  * @retval Data:Data from MCP2515'SO pin
  */
//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鎳忛崳娲煕鐎ｅ墎绉柡灞剧洴婵＄兘顢欑紒妯烘灓闂備焦鎮堕崐鏍偡閳哄懎钃熼柨婵嗩槹閺呮繈鏌嶈閸撴瑩婀侀梺缁樺灱婵倝寮查幖浣圭厾闁诡厽甯掗崝銈夋煃椤栨稒绀嬮柡灞诲妼椤繈顢橀悩娈垮晭闂備礁鎲℃笟妤呭窗閺嶎灐褰掝敊缁涘顔旈梺缁樺姈濞兼瑦鎱ㄥ鍥ｅ亾鐟欏嫭绀�闁绘牕銈稿顐﹀磼閻愭潙鐧勬繝?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挻宀搁獮鍫ュΩ閵夘喗寤洪梺绯曞墲椤ㄥ懐绮昏ぐ鎺撯拺闁告稑顭�閹寸姵鏆滈柨鐔哄Т缁犳牜鎲搁悧鍫濈瑨闁绘劕锕ラ妵鍕疀閹炬剚浠奸梺璇″灣閸嬫盯鍩為幋锔藉�烽柤纰卞墮椤も偓闂備焦鎮堕崝宀�绱炴繝鍥ф瀬闁规儳顕々鐑芥倵閿濆骸浜濋梺娆惧弮閺岋絾鎯旈姀鐘叉瘓闂佸憡鎸鹃崰鏍嵁閸愵煁娲敂閸曞簶鏅犻弻宥嗘姜閹殿喚鐛㈠┑鈽嗗亞閸忔ê顫忓ú顏咁棃婵炴垼浜崝鎼佹⒑缁嬪灝顒㈤柣鎾偓宕囨殾闁绘梹鎮堕崑鍛存煕閹般劍娅囬柛姗�浜堕幃宄邦煥閸曨厾鐤勫Δ鐘靛仜缁绘﹢寮�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愭祴鏀介悗锝呯仛閺咃綁姊虹紒妯虹仴婵☆偅鎸抽獮蹇撶暋閹佃櫕鐎婚悗鐢靛缁诲倻绱炴繝鍥ф瀬闁圭増婢樺婵囥亜閺冨洦顥夐梻鍌ゅ灦濮婄粯鎷呴懞銉ｂ偓鍐煟閹虹偟鐣垫鐐插暣瀹曟帡鎮欓弶鎴滅钵婵＄偑鍊栭弻銊︽櫠閼恒儯浠氶柟鎯板Г閻撴洟鏌ㄩ弮鍥跺殭妤犵偞蓱閵囧嫰鏁傜拠鍙夌彎濠殿喖锕ュ钘夌暦閻戠瓔鏁囩憸蹇涘礉缁嬫娓婚柕鍫濈箰椤╊剟鏌℃担铏瑰笡濞ｅ洤锕﹂埀顒佺♁钃遍柛搴ｅ枛閺屾洝绠涙繛鎯т壕闁告劖褰冮煢闂傚倸鍊搁…顒勫磻閸曨個娲晝閸屾氨顔囬梺鍛婄缚閸庤京娆㈤妶鍡欑鐎瑰壊鍠曠花濂告煃闁垮鐏﹂柕鍥у楠炲洭濡搁妷銉㈡嫟缂傚倷妞掗懗鑸垫櫠濡ゅ懎桅闁告洦鍨伴崡铏叏濮楀棗澧紒渚囧枛铻栭柣姗�娼ф禒锕傛煕閺冣偓閻熴儵鎮鹃悜钘夐唶闁哄洨鍠愬▍鍡涙⒑閼恒儍顏堟晬瀹ュ绠ｉ柨鏃囆掗幏娲⒒閸屾氨澧涚紒瀣浮钘熸繛鍡樻尰閻撶娀鎮楅崷顓炐ｇ痪顓㈢畺閹繝濡堕崥銈呯秺瀹曟宕楅懖鈺冣枏闂備礁鎲￠崝蹇涘磻閹剧粯鈷掑ù锝堫潐閸嬬娀鏌涙惔銏㈢煉鐎规洜鍠栭、鏇㈠閵忊�虫殠闂傚倸鍊搁崐鐑芥嚄閸洩缍栭悗锝庝憾閸氬鏌涢埄鍐炬濞村吋鎹囧濠氬磼濞嗘垵濡介柣搴ｇ懗閸涱垳鐓撻梺纭呮彧闂勫嫰宕甸幇顓滀簻闁哄稁鍋勬禒婊堟煟閵堝骸娅嶉柡灞诲姂閹垽宕滄担铏瑰幆闂備浇顕栭崰鏍礊婵犲倻鏆﹂柛顐ｆ处閺佸倻鈧箍鍎遍幊蹇涘汲椤栨粎纾介柛灞剧懅閸斿秹鏌＄仦璇插闁诡喗妞芥俊姝岊槾闁活厽鐟ラ…鍧楁嚋闂堟稑袝闂佽桨绀侀崐鍧楀蓟濞戞ǚ妲堥柛妤冨仦閻忓秴顪冮妶鍡樼叆缂佸鎳撻～蹇撁洪鍕祶濡炪倖鎸鹃崳銉︾瑜斿娲偡閺夋寧顔�闂�?
//=====================================================================
uint8_t MCP2515_ReadByte(uint8_t Addr)
{
    u8 temp[3],i;
    u8 Data[3];
    temp[0]=Mcp2515_SPI_READ;
    temp[1]=Addr;
    temp[2]=0xaa;

    MCP2515_CsActive();

    for(i=0;i<3;i++)
    {
        MCP2515_TxRx(temp+i,1,Data+i,1,0);
    }

//    Djy_DelayUs(10);
    MCP2515_CsInActive();
    return Data[2];
}

/**
  * @brief  Reset the MCP2515 then U go into the configruation mode
  * @param  none
  * @retval none
  */
//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鍊告禍鎯ь渻閵堝骸寮ㄦ繛澶嬫礋楠炴垿宕熼娑欏劒闂佸憡鎸婚崝褏妲愰弴鐘愁潟闁圭偓鍓氶崥瀣煕濞戝崬鏋涙繛鍫燁殔铻栭柣姗�娼ф禒锕傛煕閺冣偓閻熴儵鎮鹃悜钘夐唶闁哄洨鍠愬▍鍡涙⒑閼恒儍顏堟晬?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挾鍠栧濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愭祴鏀介悗锝呯仛閺呫垺绻濋姀锝嗙【闁荤啿鏅犻崺锟犲磼濠婂拋鍟庨梺鍝勵槸閻楀棙鏅舵禒瀣闁规鍠氱壕鐓庮熆鐠虹儤婀伴柡鍡忔櫊閺屻劑鎮㈢紒姗嗘闂佽绻戝銊╁窗婵犲偆鍚嬮柛銉㈡櫇閻掑潡姊洪崷顓炲妺妞ゃ劌鎳庡ú鍧楁⒒娴ｅ憡鍟炲〒姘殜瀹曪綁鍩�椤掍降浜滈柡鍌涱儥濡插湱绱掔紒妯笺�掗柍褜鍓涢弫鎼佲�﹂崼锝傚徔闂傚倷鑳堕…鍫澝归悜钘夋瀬閻犲洩灏欓弳锕傛煙閹増顥夌紒鐘垫嚀闇夐柨婵嗘噺閸熺偞銇勯妷锔剧疄婵﹥妞藉畷顐﹀礋閸倣锕傛⒑鐠囪尙绠茬紒璇茬墦楠炲啫顫滈埀顒佷繆閻戣棄唯闁靛繆鍓濋弶鍛婁繆閻愵亜鈧牕顫忔繝姘厱闁割偁鍎辩壕鍧楃叓閸ャ劎鈯曢柛濠勬暬閺岋綁濮�閻樺吀绮电紓浣稿閸ゅ湧2515 闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁逞屽墴閸┾偓妞ゆ帊绀侀崵顒勬煕閹捐泛鏋庨柣锝囧厴椤㈡宕熼銈庡晪婵＄偑鍊栧濠氬疾椤愶箑绀夐柟闂寸劍閳锋垿姊婚崼鐔剁繁闁绘帡绠栭弻娑欐償閳ヨ櫕姣愰柛妤呬憾閺岀喐娼忔ィ鍐╊�嶉梺绋匡工閻忔氨鎹㈠☉銏犵闁绘垵妫旈惀顏勵渻閵堝懐绠伴悗姘�鍥у嚑鐎广儱顦伴悡娆撴煟閹寸儑渚涙繛鍫熸礋閺岋繝宕担绋库拫闂佽鍠楅敃銏ゅ箖濞嗘垶瀚氱憸搴ｂ偓姘秺閺岋綁寮崼顐ｎ棖閻熸粎澧楅悡鈥愁潖濞差亝鍤掗柕鍫濇啗閿涘嫮纾奸柍褜鍓氶幏鍛喆閸曨剛褰垮┑鐐差嚟婵挳顢栭崱娑樼；妞ゅ繐鐗婇悡鏇㈡煃閳轰礁鏆熼柍顖涙礋閺岋綁骞橀姘闂備浇顕ф鍝ョ不瀹ュ纾块柛妤冧紳濞差亜惟闁宠桨绀侀崵鎴︽⒑缁嬫寧婀扮紒瀣姉閹广垽宕卞Ο闀愮盎闂佸搫绋侀悡鍫濃枔閿濆鐓欑�瑰嫭婢樺Σ濠氭煟閿濆洤鍘寸�规洖鐖奸崺鈩冪節閸愨晜娈㈤梻鍌氬�搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熺�电浠ч梻鍕閺岋繝宕橀妸銉㈠亾閼姐倗涓嶉柡鍐ㄧ墛閻撴洜鈧厜鍋撻柍褜鍓熷畷鎴︽倷閸濆嫮锛涢梺闈浥堥弲婊堝煕閹烘鐓曟い鎰╁�曢弸鏃堟煃閽樺妯�闁哄矉缍�缁犳稓鈧綆浜滄慨搴ㄦ⒑鐎圭媭娼愰柛銊ユ健閵嗕礁鈻庨幋婵囩�抽梺鍛婎殘閸嬫稒绔熼崼銉︹拺閻犲洦鐓￠崣鍕箾娴ｅ啿鍠氶崵鏇㈡偣鏉炴媽顒熼柣鎺曟閳规垿鎮╃�圭姴顥濋梺缁樺姇閿曨亪寮诲澶婃嵍妞ゆ挾鍋樻竟鏇㈡⒑缂佹ɑ灏靛┑顔炬暩閹广垹鈽夐姀鐘殿吅闂佺粯鍔曢悺銊╁磿閹剧粯鈷戠憸鐗堝俯濡垿鏌涜箛鏂嗩亪锝炶箛鎾佹椽顢斿鍡樻珦闂備礁鎲＄换鍌溾偓姘煎墴閳ユ牠宕奸妷锔规嫼闂佸憡鎹佺亸娆撳储濠婂牊鐓�?
//=====================================================================
bool_t MCP2515_Reset(void)
{
    u8 temp,Data;
    temp=Mcp2515_SPI_RESET;
    MCP2515_CsActive();
    Djy_DelayUs(100);
    MCP2515_TxRx(&temp,1,&Data,1,0);
    MCP2515_CsInActive();
    return true;
}

/**
  * @brief  Modify the bit of the register
  * @param  Add:Address of register
  * @param  Mask:1-->U can modify the corresponding bit;0-->U can not modify the corresponding bit
  * @param  Data:the data U need to be sent from MCU to MCP2515
  * @retval none
  */
//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鍊告禍楣冩煠閹稿骸濮嶉柡灞剧洴婵＄兘濡搁敂淇扁偓鎰版⒑閸濆嫷鍎戦柛鐘崇墵瀵鍩勯崘鈺侇�撻梺鑺ッˇ顔夹уΔ鍛拺閻犳亽鍔岄弸宥囩磼椤旂晫鎳冩い顓炴穿椤︽挳鏌嶈閸撴岸宕欒ぐ鎺戠闁绘梻鍘х粻鏍ㄧ箾瀹割喕绨婚幆鐔兼⒑鐎圭姵銆冪紒鑸佃壘铻為柣鎴ｅГ閳锋垿姊婚崼鐔惰吂婵炴垯鍨圭粈瀣亜閹捐泛鏋戞い鏂跨箲缁绘繈鎮介棃娑楀摋闂佽妞挎禍鐐垫閻愬搫鐐婃い鎺嗗亾缂佺媭鍨堕弻?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挻宀搁獮鍫ュΩ閵夘喗寤洪梺绯曞墲椤ㄥ懘锝為鈶╂斀闁炽儱鍟跨痪褔鏌涢妸銉﹀仴妤犵偛鍟灃闁逞屽墴閸┿儲寰勬繛鐐�哄銈嗘寙閸屾粎娉块梻浣哥枃椤曆呯矓瑜版帞宓侀柟鐑樺殾閺冨牆鐒垫い鎺戝缁犳煡鏌涢锝嗙闁绘挻绋戦…璺ㄦ崉娓氼垰鍓板銈嗘礃缁海妲愰幒妤�绠甸柟鐑樼箘閸氬姊洪崫鍕拱婵炶尙鍠庨悾鐑芥焼瀹ュ懎宓嗛梺缁樼憿閸嬫挻淇婂顔兼珝婵﹤鎼叅閻犲洩寮撶花璇测攽閳藉棗浜濈紒璇茬墦閻涱喛绠涘☉妯哄祮闂侀潧绻嗛埀顒�纾顔尖攽閻橆喖鐏辨繛澶嬬洴瀵敻顢楅崟顐ょ枀婵犵數濮电喊宥夊煕閹达附鐓熼柟鎯у暱椤掋垽鏌熼姘卞ⅵ闁哄本绋掔换婵嬪磼濠婂啰鍘介梻浣芥〃閻掞箓骞戦崶顒傚祦閻庯綆鍠栫粻鎶芥煛閸屾氨浠㈡い顒�顦靛缁樻媴閸涘﹥鍎撳┑鈽嗗亝閻╊垰鐣锋导鏉戝唨妞ゆ挾濮寸粊锕傛⒑绾懏褰ч悗闈涚焸瀵偅绻濋崶銊у幘濠电偞娼欓鍡椻枍閸℃稒鐓欓柟缁樺俯閻撳吋鎱ㄦ繝鍐┿仢闁硅櫕鐗犻崺鈩冩媴閻戞﹩鍚囬梻鍌欒兌閹虫捇宕甸弽顓炵?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愭祴鏀介悗锝呯仛閺呫垽姊虹粙鎸庢拱缂佸鎸剧划鏃堝箮閼恒儮鎷绘繛杈剧秬婵倝藟婢舵劖鍊垫慨妯煎帶閻忕娀鎽堕悙鐑樼厱闁哄洢鍔岄悘锟犳煕鐎ｃ劌鈧骞夐幖浣哥睄闁割偅绻勯悿鍥⒑缂佹ê濮囬柟纰卞亞婢规洟宕楅懖鈺冾啎闂佺硶鍓濋敋缂佹甯楅〃銉╂倷閳轰椒澹曟繝鐢靛Х閺佹悂宕戦悙鍝勫瀭闁割偅娲栫粻瑙勩亜閹板墎鐣辩紒鐙�鍨堕弻?闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁逞屽墴閸┾偓妞ゆ帊绀侀崵顒�霉濠婂懎浠ф俊鍙夊姍閹瑩宕崟顐ょ崺婵＄偑鍊栭悧妤冨垝鎼淬劍鏅柣鎰▕濞撳鏌曢崼婵囶棡妞ゃ儱妫涢埀顒冾潐濞叉粓寮崫銉ュ灊闁挎繂鎲橀弮鍫濈劦妞ゆ帒鍟徊褰掓⒒娴ｈ鍋犻柛搴㈡綑閳绘柨鈽夐姀鐘插殤闂佺粯鏌ㄩ崥瀣偂濞戞◤褰掓晲閸ュ墎鍔搁梺璇″枟閸ㄥ湱妲愰幒鏂哄亾閿濆簼鎲炬俊顖楀亾闂備浇顕栭崰妤冨垝瀹�鍐航缂傚倸鍊烽悞锕傛晝閳哄懎鐤柍褜鍓熷濠氬磼濞嗘帒鍘″銈冨灩閿曨亪銆佸璺哄唨妞ゆ挾鍋熼悰銉╂⒑閸濆嫮鈻夐柛妯圭矙瀹曟垿濡堕崶銊ユ瀾闂佸搫鍟悧鍡欑不閻樼粯鐓熼柟閭﹀墯閹牏鐥幆褍鎮戠紒缁樼洴瀹曞崬螣閾忓湱鎳嗘俊銈囧Х閸嬫劙宕戦幘缁樷拻濞达絿鐡旈崵娆愮箾鐎电鍘寸�殿噮鍋婇獮鏍ㄦ媴閸濄儳鏋冮梻浣告贡閸嬫捇宕曢崗鍏煎弿闁规儼濮ら悡鏇熺箾閸℃绂嬫俊鑼嚀閳规垿顢涘鐓庢闂侀�炲苯澧紒鐘茬Ч瀹曟洟宕￠悘缁樻そ婵℃悂鍩℃担绋挎闂備胶顭堥惉濂稿磻閻愮儤鍋傞柣鏂垮悑閻撳繐鈹戦悙鑼虎闁告梹纰嶉妵鍕疀婵犲啯鐝氶梺鍝勮閸旀垿骞冮姀銈嗗�绘俊顖濆吹瑜把囨⒒娓氣偓濞佳兾涘Δ鍜佹晞闁搞儺鐏涢敐澶婄疀妞ゆ垼濮ら弬鈧梻浣稿閸嬪懐鍒掑澶婄闁告劦鍠楅ˉ濠冦亜閹扳晛鐏璺哄閻ヮ亪寮剁捄銊愌呪偓娈垮枛閻栧ジ鐛弽銊﹀闁荤喐澹嬮崑鎾诲垂椤愩倗顔曢梺鐟邦嚟閸嬬喖骞婇幇顓犵闁割偆鍠撻幊鍐煃鐟欏嫬鐏撮柛鈹垮劦瀹曞崬螖閳ь剛绮婚搹鍦＝濞达絽澹婇崕蹇斻亜閿旂偓鏆柕鍡曠铻ｉ悶娑掑墲閺傗偓濠电姷鏁告慨瀵糕偓姘槻鍗�?闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁逞屽墴閸┾偓妞ゆ帊绀侀崵顒�霉濠婂懎浠ф俊鍙夊姍閹瑩宕崟顐ょ崺婵＄偑鍊栭悧妤冨垝鎼淬劍鏅柣鎰▕濞撳鏌曢崼婵囶棡妞ゃ儱妫涢埀顒冾潐濞叉粓寮繝姘畺鐎瑰嫭澹嬮弨浠嬫煕閻橆喖鐏╃紓宥咃工閻ｅ嘲螖閸涱喖娈為梺鍝勵槹椤戞瑥螞閻斿吋鐓熼柣鏂挎憸閻绻濋姀鈽呰�块挊婵嬫⒒閸喓銆掗柡鍡畵閺岋絽螣濞嗘儳娈梺鍛婂姀閸嬫捇姊绘担鍦菇闁搞劌顭峰顐﹀箹娴ｂ偓閸ヮ剦鏁嬮柍褜鍓欓～蹇斻偊鐟併倓姹楅梺鍦劋閹稿鏌ㄩ鐑嗘富闁靛牆妫楅悘銉╂煙閾忣個顏堟偩閻戠瓔鏁嗗ù锝勮濞村嫰鏌ｆ惔顖滅У闁稿妫濆畷銏ゅ箳濡や礁鈧敻鏌ｈ閹诧紕鈧艾缍婂娲川婵犲倸顫嶉梺绋块閸熷潡鍩㈤幘娲绘晬闁绘劗琛ラ幏鍝勨攽椤旂偓鍤�婵炲眰鍊栨穱濠冪附閸涘﹤鈧灚鎱ㄥΟ鐓庡付濠⒀呭缁绘盯宕遍幇顒備紙婵犳鍠掗崑鎾绘⒑闂堟稓绠氶柍褜鍓欑壕顓°亹閹绢喗鈷掑ù锝囨嚀椤曟粓鏌＄仦璇插闁哄懓鍩栫粋鎺斺偓锝庡亜閸撳綊姊�?
//=====================================================================
void MCP2515_BitModify(uint8_t Addr,uint8_t Mask,uint8_t Data)
{
    MCP2515_CsActive();
    SPI_Send(Mcp2515_SPI_BIT_MODIFY);
    SPI_Send(Addr);
    SPI_Send(Mask);
    SPI_Send(Data);
    MCP2515_CsInActive();
}

/**
  * @brief  Send a command to MCP2515 through SPI to return corresponding status you need
  * @param  CMD:
                  SPI_RX_STATUS;
                SPI_READ_STATUS;
                SPI_READ_RX;
  * @retval Data:the status you need
  */
//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鎳忛崳娲煟閹惧瓨绀冪紒缁樼洴瀹曞崬螣閸濆嫷娼撻梻浣筋嚙缁绘垿骞愰幎钘夎摕闁靛ň鏅滈崑鍕磼鐎ｎ厽纭跺ù婊�鍗冲铏圭磼濡椽鍤嬫繝纰樷偓铏枠闁轰焦鎹囬幐濠冨緞鐏炶偐椹崇紓浣哄亾濠㈡绮旈崜浣稿灊閻庯綆鍠栫粻铏繆閵堝倸浜鹃柛銉︽尦濮婃椽宕ㄦ繝浣虹箒闂佸憡眉缁瑩骞嗘笟鈧弫鎰緞鐎Ｑ勫闂佸搫顦遍崑鐐寸珶閸℃瑧椹抽煫鍥ㄧ♁閻撴瑩鏌涢幋娆忊偓鏍偓?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挻宀搁獮鍫ュΩ閵夘喗寤洪梺绯曞墲椤ㄥ懐绮昏ぐ鎺撯拺濞村吋鐟ラ々顒勬煙閾忣偅宕屾繝鈧笟鈧铏圭磼濡吋鍣ч梺鐟板暱缁绘帡鍩�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愭祴鏀介柛銉ｅ妿缁夊爼姊洪崘鍙夋儓閻庢凹鍓熼幃锟犲箣閿旇В鎷绘繛鎾村焹閸嬫挻淇婇銉︾《闁瑰嘲鍟撮弫鍐磼濮橆剛鈧參姊洪幆褎绂嬮柛瀣噹閳诲秹鎮╃紒妯煎幐閻庡箍鍎辨鎼佺嵁閺嶎厽鐓熸い鎾跺櫏濞堟粓鏌″畝鈧崰鎰焽韫囨稑绠查柟浼存涧閹牓姊绘担鍛婅础闁稿繑锕㈠銊╂焼瀹ュ懐顔嗛梺鍛婁緱閸ｎ喖危瑜版帒绠归柟纰卞幖閺嬫瑧绱掓潏顭嬵亪鍩為幋锔藉�烽柡澶嬪灩娴犳悂姊洪悷鎵癁闁哄懏绮庣划瀣吋閸涱亝鏂�闂佸壊鍋掗崜姘扁偓姘秺閺屾盯鈥﹂幋婵呯敖濡炪倧缍�鐏忔瑧妲愰幒妤�纾兼繛鎴炆戠拠鐐寸節绾版ê澧查柛搴ゅ亹缁鈽夐姀鐘插祮闂佺粯鐟㈤崑鎾翠繆閺屻儰鎲炬慨濠勭帛閹峰懘宕ㄦ繝鍐ㄥ壍闂備胶绮〃鍫ュ磻閵堝宓侀煫鍥ㄦ濡插綊骞栨潏鍓ф偧闁挎稒绮撳铏圭磼濡吋鍣ч梺鐟板暱缁绘帡鍩�椤掍浇澹樼紓宥咃工椤繐煤椤忓嫬绐涙繝鐢靛Т鐎涒晠鎮惧畡鎵虫斀闁绘劖褰冪痪褏绱掗鑲╃劯闁糕斂鍨介獮妯兼嫚閼碱剦鍚呴梻浣虹帛閿氶柛鐔锋健閹灚瀵肩�涙鍘介梺缁樏鑸靛緞閸曨厽鍠愰柡澶婄仢閺嗭絿鈧鍠楅悡锟犵嵁閺嶃劍濯撮柛锔诲幖楠炲牓姊绘担鍛婃儓闁哥噥鍋婂畷鎰板箹娴ｇ鍤戝┑鐐叉閹稿鎮￠弴銏㈠彄闁搞儯鍔嶉ˉ鏍煠閺夋寧鍋ラ柡灞稿墲閹峰懘宕妷鎰剁悼閳ь剙鐏氬妯尖偓姘煎墴閸┿儲寰勬繝搴㈠兊婵℃彃鏈悧妤�鏆╅梻鍌氬�搁崐椋庣矆娓氣偓楠炲鏁撻悩鑼槷闂佸搫绋侀崢浠嬪磻閿熺姵鐓忛柛顐ｇ箖瀹告繈鏌涘Δ浣稿摵闁诡喗顨呴埥澶娾枎濡厧濮洪梻浣哥－缁垰顫忚ぐ鎺懳﹂柛鏇ㄥ枤閻も偓闂佽鍎抽悺銊ョ暦瀹曞洨纾藉ù锝嗗絻娴滅偓绻濋姀锝嗙【闁活剝鍋愭竟鏇㈡嚃閳规儳浜鹃柛蹇擃槸娴滈箖姊洪崨濠冨闁告ê澧界划锝呂旈埀顒勨�旈崘顔嘉ч柛鈩冾焽椤︻厽绻濋埛鈧崟鍨暭缂備緡鍠楅悷锕�顕ラ崟顖氱疀妞ゆ挾鍠愰鐔兼⒒娴ｇ鎮戝ù婊�绮欏畷鏇㈠箮閽樺鍘洪梺鍝勫暊閸嬫捇鏌曢崶褍顏紒鐘崇洴楠炴鈧稒锚闂傤垳绱撻崒娆掝唹闁稿鎸搁…鍧楁嚋闂堟稑顫嶉梺缁樻尰濞茬喖寮婚悢鍏肩劷闁挎洍鍋撳褎澹嗛埀顒佺♁缁诲牆顫忓ú顏勪紶闁靛鍎查悗楣冩⒑鐟欏嫮鎽冪�规洜鏁搁崚鎺戔枎閹邦剛绐為梺褰掑亰閸樿棄鈻嶉姀銈嗏拺闁稿繘妫块懜顏堟煕鎼淬垹鈻曢柛鈹垮灲瀵噣宕奸悢鍝勫汲闂備胶绮ú鏍磹閸︻厸鍋�?闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏楣冩闁搞倖鍔栭妵鍕冀椤愵澀绮堕梺姹囧�ら崳锝夊蓟閵娾晜鍋勯柛鎾茶兌閻撴捇姊虹拠鈥虫灈缂傚秴锕ら悾鐑藉醇閺囥劍鏅滈悗骞垮劚閹冲繘顢欓崟顖涒拻濞达綀顫夐崑鐘绘煕婵炲灝鈧繂鐣烽姀銈嗗癄濠㈣埖顭囬崝閿嬬節閻㈤潧校闁艰鍎宠灋婵せ鍋撻柡宀�鍠撶划娆撳箰鎼淬垹闂俊鐐�х拹鐔煎磿闂堟侗娼栭柧蹇撴贡閻瑦绻涢崱妤�鈷旈柛娆愬哺濮婃椽鎮烽弶鎸庮唨闂�?
//=====================================================================
uint8_t SPI_CMD_MCP2515(uint8_t CMD)
{
    uint8_t Data;
    MCP2515_CsActive();
    MCP2515_TxRx(&CMD,1,&Data,1,1);
    MCP2515_CsInActive();
    return Data;
}

//----闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇楀亾妞ゎ厼鐏濊灒闁兼祴鏅濋悡瀣⒑閸撴彃浜濇繛鍙夛耿瀹曟垿顢旈崼鐔哄幈濠电姴锕ら幊蹇涱敁瀵ゆ岸姊婚崒姘偓鎼佸磹妞嬪孩顐介柨鐔哄Т绾惧鏌涘☉妯兼憼闁稿孩顨嗛妵鍕籍閸屾稒鐝梺宕囨嚀缁夋挳鍩為幋锔藉亹闁圭粯宸婚崑鎾绘偨缁嬪灝鍤戦梺鍝勭▉閸樹粙鎮¤箛娑氬彄闁搞儜灞藉壈闂佽绻嗛弲婊堝Φ閸曨垰唯闁挎梻绮悿渚�姊洪崫鍕効缂佽弓绮欓垾锕傚Ω閳轰胶鐤�濡炪倖鎸鹃崕鎰?--------------------------------------------------------
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼閻愬鍙嗛梺缁樻礀閸婂湱鈧�? 闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇楀亾妞ゎ厼鐏濊灒闁兼祴鏅濋悡瀣⒑閸撴彃浜濇繛鍙夛耿瀹曟垿顢旈崼鐔哄幈濠电姴锕ら幊蹇涱敁瀵ゆ岸姊婚崒姘偓鎼佸磹妞嬪孩顐介柨鐔哄Т绾惧鏌涘☉妯兼憼闁稿孩顨嗛妵鍕籍閸屾稒鐝梺宕囨嚀缁夋挳鍩為幋锔藉亹闁圭粯宸婚崑鎾绘偨缁嬪灝鍤戦梺鍝勭▉閸樹粙鎮¤箛娑氬彄闁搞儜灞藉壈闂佽绻嗛弲婊堝Φ閸曨垰唯闁挎梻绮悿渚�姊洪崫鍕効缂佽弓绮欓垾锕傚Ω閳轰胶顦ㄩ梺瀹犳〃缁�浣圭閸洘鈷掑ù锝堝Г绾爼鏌涢悩鍐插鐎殿喖鎲＄换婵嗩潩椤掑偆鍞甸梻?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄被鍔戦幃銈夊磼濞戞﹩浼�:baudrate,CAN闂傚倸鍊搁崐鎼佸磹妞嬪孩顐介柨鐔哄Т绾惧鏌涘☉妯兼憼闁稿孩顨嗛妵鍕籍閸屾稒鐝梺宕囨嚀缁夋挳鍩為幋锔藉亹闁圭粯宸婚崑鎾绘偨缁嬪灝鍤戦梺鍝勭▉閸樹粙鎮¤箛娑氬彄闁搞儜灞藉壈闂佽绻嗛弲婊堝Φ閸曨垰唯闁挎梻绮悿渚�姊洪崫鍕効缂佽弓绮欓垾锕傚Ω閳轰胶顦ㄩ梺瀹犳〃缁�浣圭閸洘鈷掑ù锝堝Г绾爼鏌涢悩鍐插鐎殿喖鎲＄换婵嗩潩椤掑偆鍞甸梻?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄繈寮查幖浣圭叆? 闂傚倸鍊搁崐鐑芥嚄閸洖绠犻柟鍓х帛閸嬨倝鏌曟繛鐐珔缂佲偓婢舵劖鐓涢柛銉㈡櫅閺嬫垿鏌涘▎蹇曠缂佺粯鐩獮瀣倷閸偄娅楀┑鐐茬摠閸ゅ酣宕愬┑瀣摕闁跨喓濮寸壕鍏肩箾閹寸儑渚涢柛銈咁儑缁辨挻鎷呴幓鎺嶅闂備浇娉曢崰鎾存媴閸炴檰e,婵犵數濮烽弫鍛婃叏娴兼潙鍨傛繛宸簻绾惧潡鏌ゅù瀣珔闁搞劍绻堥弻娑㈠箻濡も偓鐎氼剟寮搁崒鐐粹拺闁圭瀛╅ˉ鍡椻攽椤斿搫鈧牜绮嬪澶娢у璺侯儑閸樻悂姊虹粙鎸庢拱缂佸鍨块、姘煥閸涱垳锛滈梺閫炲苯澧撮柡浣规尵瀵板﹤顭冲鐠糴.
//闂傚倸鍊峰ù鍥х暦閸偅鍙忛柡澶嬪殮濞差亜围濠㈣泛顑呮禒閬嶆⒑闂堟侗鐒鹃柛搴㈢懇閺佹劖寰勬繝鍕靛悈闂備焦瀵уΛ浣规叏閵堝應鏋嶉柡宥庡幗閳锋垿鎮归幁鎺戝婵炲懏鍔欓弻?
//-----------------------------------------------------------------------------
 bool_t MCP2515__SetBaudRate(u32 baudrate)
{
 /* 闂傚倸鍊搁崐鐑芥嚄閸洖绠犻柟鍓х帛閸嬨倝鏌曟繛鐐珔闁搞劌鍊块幃瑙勬姜閹峰矈鍔呴梺缁樺笂缁瑩寮诲☉鈶┾偓锕傚箣濠靛懐鏁栨俊鐐�愰弲婵嬪礂濮椻偓楠炲啫螖閸涱喗娅滈柟鑲╄ˉ閳ь剚鍓氬楣冩⒒娴ｈ銇熼柛妯兼櫕閹广垽宕掗悙鑼弨婵犮垼鍩栭崝鏇犵不婵傚憡鐓曢柡鍥ュ妼婢ь喗銇勮箛姘【闁宠鍨块幃娆撳级閹寸姳妗撻梻浣烘嚀閹诧繝骞冮崒鐐偓渚�寮介鐐茶�垮┑鐐叉濞寸兘宕滈妸銉㈡斀闁绘绮☉褎銇勯幋婵囶棦鐎规洘鍨归埀顒婄秵閸犳鎮￠弴銏＄叆闁哄啫娴傞崵娆愵殽閻愬澧甸柡灞诲�濋幃婊兾熺悰鈩冪亞闂備礁鎼惌澶岀礊娴ｉ�涚箚闁归棿绀佸敮闂侀潧顦介崰鏇犳閹剧繝绻嗛柣鎰典簻閳ь剚鐗曢～蹇涙偡閹冲﹤鎼…銊╁川椤曞懏缍楅梻浣告惈閸燁偊鎮у鍫濇瀬濠电姴娲﹂悡鐘绘煙椤撶喎绗掗柛鏂诲�濋弻娑橆潨閳ь剙顭囪閸╃偤骞嬮敂钘夆偓椋庘偓鐟板閸犳鏅ュ┑鐘垫暩閸嬬偟绮婇幘顔肩柧婵犻潧鏌堥敐澶婄疀闁绘鐗嗘禍閬嶆⒑閸撴彃浜愰柟鍐叉喘瀵悂寮介鐔叉嫼闁荤姵浜介崝宀勫几瀹ュ洨纾兼い鏃傛櫕閹冲啴鏌ｉ敐鍛Щ閾绘牠鏌涘☉鍗炲箻闁绘挻鍨甸埞鎴﹀煡閸℃浠╃紓浣靛姂娴滃爼鐛箛娑樼労闁告劦浜為鏇㈡⒑閻熼偊鍤熼柛瀣仱楠炲棝宕熼鈧悷閭︾叆闁告洦鍘鹃悡澶愭倵鐟欏嫭绌跨紓宥勭椤曪綁骞橀钘夆偓濠氭煕閳╁喚娈曟い鎾虫健濮婄粯绻濇惔鈥茬盎濠电偛鐪伴崹钘夌暦閺囩偟鏆﹂柛銉㈡櫇楠炴捇姊�?
     TQ=2(BRP+1)/Fosc
         濠电姷鏁告慨鐑藉极閹间礁纾绘繛鎴旀嚍閸ヮ剦鏁囬柕蹇曞Т閻庮厾绱撻崒娆戝妽妞ゎ厼娲幃鐢稿醇閺囩喓鍘甸梺缁樺灦閿曗晛鈻撻弴銏＄厱閻庯綆鍋嗙粻鐐烘煛鐏炶濮傞柟顔哄�濆畷鎺戔槈濮楀棔绱�=1/(闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐叉疄婵°倧绲介崯顐も偓姘槹閵囧嫰骞掗幋婵愪紝闂佽桨绀佸Λ婵嬪蓟閿濆绠涙い鎾跺О閸嬬偤姊洪崫鍕靛剱婵☆偄鍟村濠氭晲婢跺娼婇梺缁樏崯鍧楀汲閸績鏀芥い鏇炴缁夊爼鏌�?婵犵數濮烽弫鎼佸磻閻斿澶愬箛閺夎法锛涢梺褰掑亰閸樹粙宕ｈ箛娑欑厽闁靛繈鍩勯悞鍓х磼閻樺崬宓嗛柡灞剧☉铻栭柛鎰╁妺濮规姊洪崫鍕靛剱婵☆偄鍟村濠氭晲婢跺娼婇梺缁樏崯鍧楀汲閸績鏀芥い鏇炴缁夊爼鏌�?PS1闂傚倸鍊搁崐鎼佸磹閹间礁纾诲┑鐘叉搐缁狀垶鏌ｉ幋锝呅撻柣鎾卞劦閺岋綁寮撮悙娴嬪亾閸︻厸鍋�?PS2闂傚倸鍊搁崐鎼佸磹閹间礁纾诲┑鐘叉搐缁狀垶鏌ｉ幋锝呅撻柣鎾卞劦閺岋綁寮撮悙娴嬪亾閸︻厸鍋�?*TQ
        闂傚倸鍊搁崐宄懊归崶銊х彾闁割偆鍠嗘禒鍫㈢磼鐎ｎ偒鍎ユ繛鍏肩墪閳规垿鎮╁畷鍥舵殹闂佺顑囬崰鎰崲濞戙垹绠ｉ柣鎴濇閸旀挳鎮峰鍕叆闁伙絿鍏橀獮鎺楀箣椤撶姴鏁告俊鐐�栫敮濠勭矆娴ｈ褰掝敊闁款垰浜鹃悷娆忓缁岃法绱掔紒妯肩畵闁伙絽鍢查～婊堝焵椤掑嫮宓侀柟鎹愵嚙缁犳娊鏌￠崶銉ュ闁�?   闂傚倸鍊搁崐鐑芥嚄閸洍鈧箓宕奸姀鈥冲簥闂佺懓鐡ㄧ换鎰版嚀鐠恒劍鍠愰柣妤�鐗嗙粭姘舵煕閵堝懐澧﹂柡灞诲姂閹倝宕掑☉姗嗕紦             BRP闂傚倸鍊搁崐椋庢濮橆剦鐒藉┑鐘崇閸ゅ牏鎲搁悧鍫濈瑲闁哄懏鎮傞弻銈夊箒閹烘垵濮庣紓鍌氱С缁�?闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇氶檷娴滃綊鏌涢幇闈涙灍闁稿孩顨呴…璺ㄦ崉閻戞ɑ鎷卞銈庡亝濞叉鎹㈠┑瀣棃婵炴垵宕崜鎵磼閻愵剙鍔ょ紓宥咃躬瀵濡堕崥銈呮贡閳ь剨缍嗛崑鍛存偟閺嶎厽鈷戠痪顓炴噹娴滃綊鏌涘Ο鐘叉处缁犳帗绻濋悽闈浶㈤柨鏇樺�濆畷顖烆敃閿曗偓閸氬綊寮堕崼姘珖缁炬儳銈稿鍫曞醇濞戞ê顬嬮梺鐟板暱閹虫﹢寮婚妸鈺傚亜闁告挷鑳堕悡鎾斥攽閻愭澘灏冮柛娑变簻娴滅偓鎱ㄥΟ鐓庡付濠⒀勬尦閺岀喖顢欓懞銉ｄ虎婵犵鍓濋幃鍌炲春閳╁啰鐟归柍褜鍓欒灋闁绘垼濮ら埛鎴︽煟閹邦垱顥夐柛鏃�绮庨幉鎼佸级濞嗙偓鏁�1闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇氶檷娴滃綊鏌涢幇闈涙灍闁稿鍊濋弻鐔虹磼濮椻偓濮掗箖姊婚崒姘偓鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁逞屽墴閸┾偓妞ゆ帊绀侀崵顒勬煕閹捐泛鏋涚�殿噮鍋婇獮妯兼嫚閸欏妫熼梻渚�娼ч悧鍡椢涘Δ鍜佹晜?1闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻搐缁�鍐ㄢ攽閻樺疇澹樼紒鐙�鍨堕弻?        Fosc闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢妶鍌氫壕婵ê宕崢瀵糕偓瑙勬礉椤顭囪箛娑樼厸闁逞屽墴閹偞绻濋崶銊у幗闂佸搫鍊搁悘婵嬪箖閹达附鐓曢柕鍫濇濞搭噣鏌＄仦鐣屝у┑锛勫厴婵℃悂鏁傞幆褎閿梻鍌欒兌缁垳缂撻崸妤�纾规繝闈涱儏閽冪喖鏌ㄥ┑鍡╂Ц閹喖姊洪棃娑辨Ф闁稿海鍎ょ�靛ジ宕橀…鎴炲瘜闂侀潧鐗嗙换鎺楀礆娴煎瓨鐓熼柡宓礁浠Δ鐘靛仜閸熸挳鐛惔銊﹀殟闁靛闄勯鐔兼⒒娴ｈ姤纭堕柛锝忕畵楠�?MHZ 闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏楣冩闁搞倖鍔栭妵鍕冀椤愵澀鏉梺閫炲苯澧柟铏崌钘濋柛娆忣槶娴滄粍銇勯幇顔夹㈤柣蹇斿絻閳规垿鍨惧畷鍥х厽閻庤娲忛崝鎴︺�佸鈧崺銉╁幢濡や焦姣夐梻鍌欐祰椤曆兠归悜钘夋瀬闁告稑锕ュ▍鐘充繆閵堝懏鍣规潻婵嬫⒑?
        闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敂钘変罕闂婎偄娲︾粙鎴犵玻濡ゅ懏鐓欓梺顓ㄧ畱婢ч箖鏌ら悧鍫濐嚋缂佺粯绻冪换婵嬪磼濮橆厽鐤侀梻浣告惈椤戝棝鎮ч悩璇茶摕闁哄浄绱曢悿鈧柣搴秵娴滅偞绂掗悡搴富闁靛牆鍟崝婊勩亜閵娿儻韬�殿喖顭烽弫鎰板椽娴ｅ搫寮抽梻浣告啞閸斿繘寮插鍫濈畺婵炲棙鎸婚埛鎴︽煕濞戞﹫宸ラ柣鎾亾缂傚倷鑳剁划顖滄崲閸儳宓侀柛鈩冾殘閺嗗棝鏌涢弴銊モ偓鐘诲Ω閿旇桨绨婚梺鍝勭Р閸斿酣鎯岀仦淇变簻闁挎梻鍋撻弫鐮嗛梻鍌欐祰椤曆冾潩閿曞偊缍栧鑸靛姈閸嬨倝鏌￠崶鈺佇￠柣鎺戯攻缁绘盯宕卞Ο璇查瀺闂佺顑呴崐鍧楀蓟閵娾晜鍋勯柛婵嗗珔閿濆鐓涢柛婊�绀佹晶鎾煙椤旀枻鑰块柟顔界懇閹虫粌鈻撻幐搴闂備浇宕垫慨宕囩矆娴ｅ壊鍤曢柛顐ｆ礀缁犵偤鏌曟繛鐐珕闁稿绻濋弻鈩冨緞婵犲倻娈归梺褰掝棑閸忔﹢鐛弽銊﹀缂佸瀵ч崕顏呬繆閻愵亜鈧牠骞愰崼鏇炲瀭鐟滅増甯楅崐宄扳攽閻樻彃鏆熺紒鐘荤畺閺岀喓鈧數顭堟禒褔鏌熼搹顐㈠闁哄本鐩幃娆撳箥椤斿墽鍘繝娈垮枛閿曘倝鈥﹂悜钘夋瀬闁规儳顕々鐑芥倵閿濆簼绨婚柣搴幖椤啴濡堕崱妯锋嫽闂佸啿鍢查悧鎾崇暦椤掑嫭鍊绘俊顖濆亹椤旀洟姊洪悷閭﹀殶闁稿鍋ら幃锟犲Ψ閿旇桨绨婚梺鐟扮摠缁诲啴宕甸崶顭戞闁绘劘灏欑粻鏌ユ倵娴ｅ啫浜归柍褜鍓氱粙鎺曟懌濠电偛鎳忛悧鐘差潖閾忚宕夐柕濞垮劜閻濄垽姊�?
        闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐叉疄婵°倧绲介崯顐も偓姘槹閵囧嫰骞掗幋婵愪紝闂佽桨绀佸Λ婵嬪蓟閿濆绠涙い鎾跺О閸嬬偤姊洪崫鍕靛剱婵☆偄鍟村濠氭晲婢跺娼婇梺缁樏崯鍧楀汲閸績鏀芥い鏇炴缁夊爼鏌�?1   婵犵數濮烽弫鎼佸磻閻斿澶愬箛閺夎法锛涢梺褰掑亰閸樹粙宕ｈ箛娑欑厽闁靛繈鍩勯悞鍓х磼閻樺崬宓嗛柡灞剧☉铻栭柛鎰╁妺濮规姊洪崫鍕靛剱婵☆偄鍟村濠氭晲婢跺娼婇梺缁樏崯鍧楀汲閸績鏀芥い鏇炴缁夊爼鏌�?闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏楣冩闁稿顑夐弻娑㈠焺閸愵亖濮囬梺绋块閿曨亪鐛弽銊︾秶闁告挆鍛呫倝姊洪悷鏉挎Щ闁搞垺鐓￠崺銉﹀緞婵炵偓鐎哄銈嗘寙閸屾粎娉块梻浣哥枃椤曆呯矓瑜版帞宓佺�广儱顦�氬绻�?闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇氶檷娴滃綊鏌涢幇闈涙珮闁轰礁妫欓妵鍕Ω瑜滈埀顒佸疂G闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁逞屽墴閸┾偓妞ゆ帊绀侀崵顒勬煕閹捐泛鏋涚�殿噮鍋婇獮妯兼嫚閸欏妫熼梻渚�娼ч悧鍡椢涘Δ鍜佹晜?1闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻搐缁�鍐ㄢ攽閻樺疇澹樼紒鐙�鍨堕弻?  PS1闂傚倸鍊搁崐鎼佸磹閹间礁纾诲┑鐘叉搐缁狀垶鏌ｉ幋锝呅撻柣鎾卞劦閺岋綁寮撮悙娴嬪亾閸︻厸鍋�?闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏楣冩闁稿顑夐弻娑㈠焺閸愵亖濮囬梺绋块閿曨亪鐛弽銊︾秶闁告挆鍛呫倝姊洪悷鏉挎Щ闁搞垺鐓￠崺銉﹀緞婵炵偓鐎哄銈嗘寙閸屾粎娉块梻浣哥枃椤曆呯矓瑜版帞宓佺�广儱顦�氬绻�?闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇氶檷娴滃綊鏌涢幇闈涙珮闁轰礁妫欓妵鍕Ω瑜庨弫鐩揋1闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁逞屽墴閸┾偓妞ゆ帊绀侀崵顒勬煕閹捐泛鏋涚�殿噮鍋婇獮妯兼嫚閸欏妫熼梻渚�娼ч悧鍡椢涘Δ鍜佹晜?1闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻搐缁�鍐ㄢ攽閻樺疇澹樼紒鐙�鍨堕弻?  PS2闂傚倸鍊搁崐鎼佸磹閹间礁纾诲┑鐘叉搐缁狀垶鏌ｉ幋锝呅撻柣鎾卞劦閺岋綁寮撮悙娴嬪亾閸︻厸鍋�?闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏楣冩闁稿顑夐弻娑㈠焺閸愵亖濮囬梺绋块閿曨亪鐛弽銊︾秶闁告挆鍛呫倝姊洪悷鏉挎Щ闁搞垺鐓￠崺銉﹀緞婵炵偓鐎哄銈嗘寙閸屾粎娉块梻浣哥枃椤曆呯矓瑜版帞宓佺�广儱顦�氬绻�?闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇氶檷娴滃綊鏌涢幇闈涙珮闁轰礁妫欓妵鍕Ω瑜庨弫鐩揋2闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁逞屽墴閸┾偓妞ゆ帊绀侀崵顒勬煕閹捐泛鏋涚�殿噮鍋婇獮妯兼嫚閸欏妫熼梻渚�娼ч悧鍡椢涘Δ鍜佹晜?1闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻搐缁�鍐ㄢ攽閻樺疇澹樼紒鐙�鍨堕弻?

        闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敃鈧悿顔姐亜閹板爼妾柛瀣樀閺岋綁骞橀崘宸敨濠电偞鍨崹褰掑垂閸屾稏浜滈柡鍐ㄦ祩濞兼劙鏌ｈ箛搴ｇ獢婵﹨娅ｇ划娆戞崉閵娧屽敽婵＄偑鍊ら崢濂告偋閹捐绠氬ù锝呭閻撱儵鏌涢銈呮瀻濞寸媭鍙冨娲传閸曨剙顦╁┑顔角滈崝鎴濈暦濠靛棭鍚嬮柛銉到娴滅偓绻涢崼婵堜虎闁哄棙鐟╅弻娑樷槈閸楃偞鐏嶉梺绋块叄娴滆泛顫忛搹鍦煓閻犳亽鍔庨鍥⒑绾懏鐝柛鏃�鐟╅妴渚�寮崼婵堫攨闂佺粯鍔忛弲婊堬綖瀹ュ鈷戦柣鐔稿娴犮垽鏌涢悢鍙夋珖闁奸缚椴哥换婵嗩潩椤撶姴骞堟繝鐢靛仜濡瑩宕濋弽顐ょ焼闁逞屽墮椤啴濡堕崱妯尖敍缂傚倸绉崑鎾剁磽娴ｅ搫校闁烩晩鍨辨穱濠囨偪椤栵絾鞋闂備胶绮粙蹇涘磿闂堟侗娼栫紓浣股戞刊鎾煟閻旂顥嬬紒浣稿槻閳规垿鎮欐０婵嗘疂缂備胶濮甸幑鍥嵁閸愵収妯勯梺鍝勮嫰濡顢樻總绋垮耿婵＄偠顕ф禍楣冩煟閹达絽袚闁绘挾鍠栭弻锝夊棘閹稿孩鍎撳銈忕到閵堢螞閸涙惌鏁嗗┑鐘插暙椤�?0%-70%婵犵數濮烽弫鍛婃叏娴兼潙鍨傞柣鎾崇岸閺嬫牗绻涢幋鐐茬劰闁稿鎸搁～婵嬵敆娴ｇ懓鏋戞繝纰樷偓鍐茬骇闁告梹娲熼崺鐐哄箣閻橆偄浜鹃柨婵嗛娴滅偤鏌涘Ο璇叉诞婵﹥妞介獮鏍倷閹绘帒顫戦梻浣告啞閺屻劎鈧稈鏅濈划鈺呮偄缁嬭法绐為梺褰掑亰閸橀箖宕㈡禒瀣拺鐟滅増甯掓禍浼存煕閻樻剚娈滅�规洜鏁婚崺鈧い鎺嗗亾闁宠鍨块幃顏堝川椤旂⒈浼撻梻鍌欒兌缁垶鎮疯缁�?闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敂钘変罕濠电姴锕ら悧鍡欏婵犳碍鐓曢柡鍥ュ妼閻忥繝鏌涚�ｎ亜顏柕鍥у楠炴帡骞嬪┑鎰棯闂備礁鎼幏瀣礈閻旂厧钃熼柕濞炬櫆閸嬪棝鏌涚仦鍓р槈妞�?
        闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩顔瑰亾閸愵喖绠涢柡澶庢硶椤斿棝姊�?   (闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐叉疄婵°倧绲介崯顐も偓姘槹閵囧嫰骞掗幋婵愪紝闂佽桨绀佸Λ婵嬪蓟閿濆绠涙い鎾跺О閸嬬偤姊洪崫鍕靛剱婵☆偄鍟村濠氭晲婢跺娼婇梺缁樏崯鍧楀汲閸績鏀芥い鏇炴缁夊爼鏌�?婵犵數濮烽弫鎼佸磻閻斿澶愬箛閺夎法锛涢梺褰掑亰閸樹粙宕ｈ箛娑欑厽闁靛繈鍩勯悞鍓х磼閻樺崬宓嗛柡灞剧☉铻栭柛鎰╁妺濮规姊洪崫鍕靛剱婵☆偄鍟村濠氭晲婢跺娼婇梺缁樏崯鍧楀汲閸績鏀芥い鏇炴缁夊爼鏌�?PS1闂傚倸鍊搁崐鎼佸磹閹间礁纾诲┑鐘叉搐缁狀垶鏌ｉ幋锝呅撻柣鎾卞劦閺岋綁寮撮悙娴嬪亾閸︻厸鍋�?/(闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐叉疄婵°倧绲介崯顐も偓姘槹閵囧嫰骞掗幋婵愪紝闂佽桨绀佸Λ婵嬪蓟閿濆绠涙い鎾跺О閸嬬偤姊洪崫鍕靛剱婵☆偄鍟村濠氭晲婢跺娼婇梺缁樏崯鍧楀汲閸績鏀芥い鏇炴缁夊爼鏌�?婵犵數濮烽弫鎼佸磻閻斿澶愬箛閺夎法锛涢梺褰掑亰閸樹粙宕ｈ箛娑欑厽闁靛繈鍩勯悞鍓х磼閻樺崬宓嗛柡灞剧☉铻栭柛鎰╁妺濮规姊洪崫鍕靛剱婵☆偄鍟村濠氭晲婢跺娼婇梺缁樏崯鍧楀汲閸績鏀芥い鏇炴缁夊爼鏌�?PS1闂傚倸鍊搁崐鎼佸磹閹间礁纾诲┑鐘叉搐缁狀垶鏌ｉ幋锝呅撻柣鎾卞劦閺岋綁寮撮悙娴嬪亾閸︻厸鍋�?PS2闂傚倸鍊搁崐鎼佸磹閹间礁纾诲┑鐘叉搐缁狀垶鏌ｉ幋锝呅撻柣鎾卞劦閺岋綁寮撮悙娴嬪亾閸︻厸鍋�?=60%-70%闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熺�电浠ч梻鍕閺岋繝宕橀妸銉㈠亾瑜版帩鏁冨ù鐘差儐閻撳繐顭跨拠鈥崇仩闁硅櫕鍔欓幃锟犲箻缂佹鍘介柟鍏兼儗閸ㄥ磭绮旈悽鍛婄厱闁绘ê纾晶顏堟煃鐠囪尙效闁轰焦鎹囬幃鈺呭棘閵夛箑顏洪梻鍌欑婢瑰﹪宕戦崨顖滅煓闁硅揪闄勯崐鑸点亜韫囨挻鍣哥紒璇叉閹綊宕堕崶褍顏╂い?2.5%
        闂傚倷娴囬褍霉閻戣棄绠犻柟鎯ь嚟閻濊泛鈹戦悩鍙夋悙缂佹劖顨婇弻锟犲炊閳轰絿銉х磼閻樿櫕鐓ユい顓℃硶閹瑰嫭绗熼姘缂傚倷绀佹晶搴ㄥ磻閻愬搫绠為柕濞垮労濞笺劑鏌涢埄鍐炬當妞ゎ偒浜鍝勑ч崶褍顬夐梺鎼炲妼濞尖�愁嚕婵犳碍鏅搁柣妯垮皺椤︿即姊婚崒姘卞缂佸鎸荤粋鎺斺偓闈涙憸绾捐棄霉閿濆牊顏犻悽顖涚洴閺岋絽螖閸愩剱銏°亜閺囶亞绋荤紒鍌涘笧閳ь剨缍嗛崑鍛枍閵忋倖鈷戦悹鎭掑妼濞呮劙鏌�?
 */
     if(baudrate==250)
     {
       MCP2515_WriteReg(Mcp2515_CNF1,Mcp2515_CAN_250Kbps);

       MCP2515_WriteReg(Mcp2515_CNF2,Mcp2515_BTLMODE|Mcp2515_PHSEG1_3TQ|Mcp2515_PRSEG_1TQ);

       MCP2515_WriteReg(Mcp2515_CNF3,Mcp2515_PHSEG2_3TQ);
     }
     if(baudrate==125)
     {
       MCP2515_WriteReg(Mcp2515_CNF1,Mcp2515_CAN_125Kbps);
     //set CNF2,SAM=0,caputre one time,PHSEG1=(2+1)TQ=3TQ,PRSEG=(0+1)TQ=1TQ
     //闂傚倸鍊峰ù鍥х暦閸偅鍙忕�规洖娲ㄩ惌鍡椕归敐鍫綈婵炲懐濮撮湁闁绘ê妯婇崕鎰版煕鐎ｅ吀閭柡灞剧☉椤劑宕ㄩ鎯ц摕F2闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎯х槣闁轰礁妫濋弻锝呪槈濮樺崬鏁� = 0闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熺�电浠ч梻鍕閺岋繝宕橀妸銉㈠亾婵犳艾纭�婵鍩栭悡娑橆熆鐠轰警鍎忛柣蹇撶Ч閺岋紕鈧綆浜崣鍕煛鐏炵晫效濠碉紕鏌夐¨渚�鏌涢弮鈧划鎾诲蓟閻斿壊妲归幖绮光偓鍐茬婵°倗濮烽崑鐐垫暜閳ユ剚鍤曢柟缁㈠枟閸嬪嫰鏌ｉ幋鐑囦緵闁告艾娲濠氬磼濞嗘垵濡介柣搴ｇ懗閸涱垳鐓撻梺纭呮彧鐎靛矂寮崱妯镐簻闁靛ě鍕殸EG1 =闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻搐缁�鍐ㄢ攽閻樺疇澹樼紒鐙�鍨堕弻? + 1闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎹愮闁逞屽厸缁�浣藉絹?= 3TQ闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎯х槣闁轰礁妫欓妵鍕Ω瑜滈埀顒佸疂G =闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻搐缁�鍐ㄢ攽閻樺疇澹樼紒鐙�鍨堕弻? + 1闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎹愮闁逞屽厸缁�浣藉絹?= 1TQ
       MCP2515_WriteReg(Mcp2515_CNF2,0x80|Mcp2515_PHSEG1_3TQ|Mcp2515_PRSEG_1TQ);
     //闂傚倸鍊峰ù鍥х暦閸偅鍙忕�规洖娲ㄩ惌鍡椕归敐鍫綈婵炲懐濮撮湁闁绘ê妯婇崕鎰版煕鐎ｅ吀閭柡灞剧☉椤劑宕ㄩ鎯ц摕F3闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎯х槣闁轰礁妫欓妵鍕Ω瑜庨弫鐩揋2 =闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻搐缁�鍐ㄢ攽閻樺疇澹樼紒鐙�鍨堕弻? + 1闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎹愮闁逞屽厸缁�浣藉絹?= 3TQ闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏楣冩闁搞倖鍔栭妵鍕冀閵娧呯厒缂備讲鍋撳┑鐘插�甸弨浠嬫煟濞嗗苯浜惧┑鈥冲⒔濞茬儬TRL.CLKEN = 1闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敃鈧悿顕�鏌熼崜浣烘憘闁轰礁锕弻鐔兼焽閿曗偓閺嬬喐銇勯锝嗙缂佺粯绻堝Λ鍐ㄢ槈濮橆剦鏆梻浣虹帛鐢帡鏁冮鍫濊摕婵炴垶锕╅悡銉╂煕濞戝崬娅橀柍褜鍓氱粣姝刄T闂傚倷娴囬褏鈧稈鏅犻、娆撳冀椤撶偟鐛ュ┑掳鍊愰崑鎾绘偂閵堝棛绡�闂傚牊渚楅崕蹇曠磼閳ь剟宕奸妷锔惧幘濠电偞娼欓鍡椻枍閸℃せ鏀芥い鏍ㄥ搸閸嬨垽鏌＄仦鍓ф创妤犵偞锚铻栭柍褜鍓熼獮濠呯疀濞戞瑥鈧灚銇勯幘璺烘灁缂佺娀绠栭弻鐔衡偓鐢殿焾娴狅妇鈧娲栭惉鑲╂閹捐纾兼繛鎴炵懅濞堛倕鈹戦悙鍙夘棑闁搞劋绮欓妴浣割潨閳ь剚鎱ㄩ埀顒勬煟濡椿鍟忔俊鏌ヤ憾濮婄粯鎷呴懞銉с�婇梺闈╃秶缁犳捇鐛�?
       MCP2515_WriteReg(Mcp2515_CNF3,Mcp2515_PHSEG2_3TQ);
     }
     return 1;

}

/**
  * @brief   Send n bytes with a given standard ID  corresponding to frame type
  * @param   CAN_TX_Buf: data to be sent
  * @param     DLC:DLC<=8
  * @param   SID:<=0x7FF
  * @param   CAN_FrameType:CAN_STD,CAN_RTR
  * @retval None
  */
//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鎳忛崳娲煟閹惧瓨绀冪紒缁樼洴瀹曞崬螣閸濆嫷娼撻梻浣筋嚙缁绘垿骞愰幎钘夎摕闁靛ň鏅滈崑鍕磼鐎ｎ厽纭跺ù婊�鍗冲铏圭磼濡椽鍤嬬紓浣哄У閹告悂顢氶敐澶婄闁兼亽鍎辨禍婊堟⒑缂佹ɑ灏繛瀵稿厴椤㈡瑦寰勯幇顓涙嫼闁荤姵浜介崝灞解枍閹扮増鐓�?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挻宀搁獮鍫ュΩ閵夘喗寤洪梺绯曞墲椤ㄥ懐绮昏ぐ鎺撯拺闁告稑顭�閹寸姵鏆滈柍銉﹀墯濞兼牗绻涘顔绘喚闁轰礁鍟撮弻銊モ攽閸℃浠归柣搴㈢▓閺呮繄妲愰幘瀛樺缂佹稑顑呭▓顓㈡⒑缁嬪潡顎楅柣妤冪ガ闂傚倸鍊搁崐宄懊归崶顒夋晪闁哄稁鍘肩粈鍫熺節闂堟稒顥犻柡鍡畵閺岋綁濮�閵忊晝鍔搁梺鍛婅壘缂嶅﹪鐛弽顬ュ酣顢楅埀顒佷繆婵傚憡鐓熸い鎾跺櫏濞堟粓鏌″畝鈧崰鎰焽韫囨稑绠查柟浼存涧閹牓姊绘担鍛婅础闁稿繑锕㈠銊╂焼瀹ュ懐顔嗛梺鍛婁緱閸ㄦ娊鎯屽▎鎾寸厵缂佸瀵ч幑锝嗕繆閸欏鑰挎慨濠勭帛閹峰懘宕ㄦ繝鍌涙畼婵＄偑鍊ら崢濂告偋閸℃稒鍋╅柣鎴ｅГ椤ュ牊绻涢幋鐐茬瑲闁诲繋绶氬铏规兜閸涱喖娑х紓浣哄У閸ㄥ灝顕ｉ崨濠勭懝闁逞屽墴瀵鏁愰崨鍌涙閸┾偓妞ゆ帒瀚崑瀣煕閳╁啰鎳呴柣顓炵墦閺屻劑寮撮悙娴嬪亾瑜版帗鍋傛繛鍡樺灩濡垶鏌℃径瀣靛劌婵℃彃缍婇幃妤�顫濋鍌溞ㄥ┑顔硷攻濡炶棄螞閸愵喖鐓涢柛鏇ㄥ弾濡插綊姊绘担鍛婂暈闁哄被鍔嶉〃銉╁箹娴ｅ摜鍘洪梺瑙勫礃椤曆呯不閿濆鐓熸俊顖氬悑閺嗏晠鏌ㄥ☉娆戠疄婵﹨娅ｉ幉鎾礋椤愩垹袘闂備礁鎽滈崰搴☆焽閳ユ剚鍤曢柟鎯板Г閻掕偐鈧箍鍎卞Λ娑㈠储闁秵鈷戦柛婵嗗閳诲鏌涚�ｎ亜顏�规洘绻勯埀顒婄秵閸犳宕愰悽鍛婄厱妞ゎ厽鍨垫禍婊堟煕濠靛洦銇濋柡灞糕偓宕囨殕閻庯綆鍓涢弳銈夋倵鐟欏嫭绀�闁靛牊鎮傞妴浣肝旈崨顓狅紲濠电姴锕ょ�涒晛鏆╅梻鍌氬�风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌涱棡闁瑰啿鏈换婵嬫偨闂堟侗鈧捇鏌熷畡鏉挎Щ闂囧鏌ㄥ┑鍡樺櫤閻犳劧绻濋弻宥囩磼濡椿妫冮梺鍝勮閸旀垿骞冮姀銏″珰婵炲牆顑嗛幐鍓ф閹烘柡鍋撻敐搴濇喚婵☆垪鍋撴俊鐐�戦崹鍝勎涢崘銊ф殾闁告鍋愰弸搴ㄦ煙闁箑澧版慨锝忕畵濮婂宕掑▎鎴М闂佸湱鈷堥崑濠囥�侀弽顓炲窛妞ゆ牗顨呮禍鐐叏濮椻偓濡法鑺遍悾宀�纾奸弶鍫氭櫅娴犙囨煃瑜滈崜銊х礊閸℃稑绐楁俊銈呮噹閻ょ偓銇勯幒鎴濐仾闁稿﹤鐖奸弻锝夊箛椤掑倹鎲奸梺璇叉禋閸犳氨妲愰幘鎰佸悑闁糕剝鐟ラ埅褰掓⒑鐎圭媭娼愰柛銊ョ仢閻ｇ兘骞掑Δ浣规珕闂佽姤锚椤﹁姤瀵�?闂傚倸鍊峰ù鍥敋瑜忛埀顒佺▓閺呮繄鍒掑▎鎾崇婵＄偛鐨烽崑鎾诲礃閳轰胶绐為柣搴岛閺呮繄绮诲顒夋富闁靛牆妫欑亸顏堟煕閵娿儳绉虹�殿喖鎲＄粭鐔煎焵椤掑嫬钃熼柨婵嗘啒閺冨牆鐒垫い鎺戝閸嬪鏌涢埄鍐噮闁活厼鐗撻弻銊╁即閻愭祴鍋撹ぐ鎺撳亗闁靛濡囩粻楣冩煙鏉堝墽绋婚柣婵愪邯閹�?9婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ら幁鎺戝姢闁崇粯姊婚埀顒�鍘滈崑鎾绘煛鐏炶鍔滈柍閿嬪灴閺岀喓绮欓幐搴㈠闯闂佸疇妫勯ˇ鐢稿蓟閿熺姴閱囨い鎰╁灩閳峰鎮楀▓鍨灍濠电偛锕獮鍐閵堝棗浜楅柟鑹版彧缂嶅棝宕憴鍕箚闁绘劦浜滈埀顒佺墪鐓ら柍鍝勬噹缁狀垶鏌ｉ幋锝呅撻柣鎾寸洴閺屾盯鍩勯崘銊ユ懙闂佸憡绻冨浠嬪蓟閻旂⒈鏁嶆繛鎴炵懐濡啴姊烘潪鎵槮闁稿﹤娼￠獮濠囧冀椤撶偟鍘搁梺鍛婂姉閸嬫挸鏆╅梻鍌氬�烽悞锕傛儑瑜版帒鏄ラ柛鏇ㄥ灠閸ㄥ倿骞栧ǎ顒�濡肩�瑰憡绻堝娲敇閵娾晜顎嶉梺鑺ュ灥椤﹂潧顫忕紒妯诲缂佸顑欏Λ宀勬⒑缂佹ɑ灏い锔炬暬閻涱喛绠涘☉娆愭?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愭祴鏀介悗锝庝簽閻も偓濠电偠鎻徊浠嬪箟閿熺媭鏁婇柟杈鹃檮閳锋帒霉閿濆牊顏犻悽顖涚♁閵囧嫰顢橀悙闈涒叺閻庤娲樺钘夘嚕娴犲鏁囬柣鏂挎啞椤忕喖姊绘担鐑樺殌闁宦板妿閺侇噣鍨鹃幇浣衡偓鍫曟煟閹达絽袚闁绘挶鍎甸弻锝夊籍閸屻倗鍔搁梺璇茬箰閿曪妇妲愰幒妤�鐒垫い鎺嶈兌閻熷綊鏌嶈閸撶喎顕ｉ锕�绠涢柣妤�鐗嗛埀顒傚厴閺岋綁濮�閵忊剝姣勯梺鎸庣♁缁诲牆顫忛搹瑙勫枂闁告洦鍋勬慨銏ゆ⒑閸濄儱鏋庢繛灏栤偓鎰佸殨闁规儼濮ら悞鑲┾偓骞垮劚濡盯宕㈤柆宥嗏拺闁告繂瀚埢澶愭煕鐎ｎ亜顏柟顖氬暣楠炲鎮╅悽纰夌床闂佸搫顦悧鍕礉鎼淬劌绠犻柛銉㈡杹閸嬫挾鎲撮崟顒傤槰闂佹寧宀搁弻宥囨嫚閸欏鏀紓浣哄У閻╊垶鐛Ο鍏煎磯闁告繂瀚悷鈺呮⒒閸屾艾鈧嘲霉閸パ屾禆闁靛ň鏅滈崵鍕煠缁嬭法浠涙繛鍛У娣囧﹪濡堕崒姘闂備椒绱徊浠嬫倶濮樿泛绠柛娑樼摠閸嬫牠鎮楀☉娅亪顢旂捄琛℃斀闁绘劖娼欓悘锕傛煟閻曚礁鐏犻柍缁樻尭閳诲氦绠涙繝鍐╂澑闂備礁鐤囧Λ鍕涘Δ鍛祦婵せ鍋撻柡灞诲姂閹垽宕滄担铏瑰幆婵犵數鍋橀崠鐘诲川椤忓嫪澹曞┑顔筋焽閸樠勬櫠閹绢喗鐓欐い鏃囧Г閵囨繂鈹戦埄鍐╁�愰柛鈹惧墲缁楃喖鍩�椤掆偓铻為柣鎴ｅГ閳锋垿姊婚崼鐔峰礋闁割偁鍎遍悿鐐箾閹寸們姘跺几瀹ュ鐓ラ柣鏂挎惈鏍￠梺缁樻尪閸庤尙鎹㈠☉銏犵闁绘垵妫涢崝鎼佹煟鎼淬垻鐓柛妤佸▕瀵鈽夊▎鎰妳闂侀潧绻掓慨鎾箺閻㈠憡鍊垫繛鍫濈仢濞呮﹢鏌涚�ｎ亷韬鐐插暢椤﹀湱鈧娲滈崢褔鍩為幋锕�閱囨繛鎴灻奸崰濠囨⒒閸屾瑦绁版い鏇嗗洦鐓�闁挎繂鎷嬮悞鐣屾喐韫囨稑鐒垫い鎺嶇閸ゎ剟鏌涢幘璺烘灈妤犵偛鍟叅妞ゅ繐瀚�閳哄懏鐓冮弶鐐村缁愭梹淇婇銈呭幋婵﹥妞藉Λ鍐ㄢ槈鏉堚晛濮奸梻浣侯焾閿曘儵銆冩繝鍥モ偓渚�寮崼鐔哄姸閻庡箍鍎卞Λ娑㈠储閹间焦鍊垫鐐茬仢閸旀岸鏌熼崘鏌ヮ�楅柍缁樻崌閸╋繝宕橀鍡床闂佸搫顦悧鍕礉瀹�鍕紶闁告繂瀚ч弨浠嬫煃閵夈儳锛嶉柟鐣屽█閺岀喎鐣￠悧鍫濇畻閻庤娲滈崗姗�銆佸Ο娆炬Ш缂備焦澧庨弲鐘差潖缂佹ɑ濯撮柛娑橈攻閸庢挾绱撴担鍓叉Ч婵炲吋鐟ч崣鍛存⒑闂堟稓澧曟繛璇х畱閻ｇ兘寮婚妷锔惧幐闂佸憡鍔栫�笛呪偓姘秺濮婃椽鎮烽弶鎸幮╅梺鐟板暱闁帮綁銆佸Ο鑽ら檮缂佸娉曢ˇ銊╂⒑閸︻収鐒惧Δ鐘虫倐椤㈡棃鎳滈悽鐢殿啎闁哄鐗嗘晶浠嬪箖閸忕浜滄い鎾跺仧婢с垻鈧灚婢橀敃銈囧弲濡炪倕绻愰幊澶愬箯閸濆嫷娓婚柕鍫濇婵箓鏌涢幘瀛樼殤闁�?
//     闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂佹寧娲栭崐鎼佸垂閸岀偞鐓曠憸搴ㄣ�冮崱娑樼柧闁归棿鐒﹂悡娆撴倵濞戞顏嗙箔瑜庨妵鍕晜閼测晝鏆ら梺鍝勬湰閻╊垱淇婇懜鍨劅闁炽儱纾惈鍕煟鎼淬値娼愭繛鎻掔箻瀹曡绂掔�ｎ亞鐤囬梺璺ㄥ枔婵潙娲块梻浣虹《閸撴繈鎮烽敃鈧埢?9婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ら幁鎺戝姢闁崇粯姊婚埀顒�鍘滈崑鎾绘煕濞嗗浚妲风紒璇叉閺岋綁骞囬崗鍝ョ泿闂侀�炲苯澧繛鑼枛閻涱噣寮介褎鏅濋梺闈涚墕閻楀棗鐨┑锛勫亼閸婃牠骞愭ィ鍐ㄧ獥闁规崘顕ч悡婵嬫煛閸愩劌鈧敻宕戦幘鑽ゅ祦闁割煈鍠栨慨搴ㄦ⒑閻熸澘妲绘い鎴濐槸閻ｇ兘鎮介崨濠備汗缂傚倷鐒﹂…鍥矗閸℃せ鏀介柣鎰綑閻忥附銇勯鐐村枠闁诡喚鍋ゅ畷銊︾節閸曨収鍟庨梻浣筋潐閸庡磭澹曢銏犳槬闁挎繂娲犻崑鎾舵喆閸曨剛顦梺绋跨箲钃卞ǎ鍥э躬楠炴牗鎷呯憴鍕彆闂備礁鍚嬫禍浠嬪磿濞差亜鐤柍褜鍓熷濠氬磼濞嗘帒鍘″銈冨灩閿曨亪銆佸璺哄唨妞ゆ挾鍋熼悰銉╂⒑閸濆嫮鈻夐柛妯绘瀹曞爼顢楅埀顒勬偂濞戙垺鐓曟繛鎴濆船閺嬫稑霉閻橆偅娅婃慨濠呮閸栨牠寮撮悙娴嬫嫟闂佽棄鍟虫ご鎼佸Φ閸曨喚鍞╅梺鎼炲劀閸涘宕滈梻鍌欑閸熷潡骞栭锕�纾瑰┑鐘冲焹閳ь剚鐗犲畷妤冪箔鏉炴壆鐩庨梻渚�娼х换鍡涘焵椤掆偓绾绢厽绂掓總鍛娾拺闁荤喖鍋婂▓鐘绘煕鐎ｎ亷宸ラ柣锝呭槻椤粓鍩�椤掑嫬鏄ラ柨鐔哄Т绾惧吋绻涢幋婵嗚埞闁�?
//=====================================================================
void MCP2515_SendData(uint8_t *CAN_TX_Buf,Frame_TypeDef *Frame )
{
    uint8_t tempdata;
    uint8_t HSID,LSID,SIDLEID,HEID,LEID;
    u32 SID,EID;
    uint8_t tx_ctrl,tx_buf_addr,tx_cmd,reg_sidh,reg_sidl,reg_eidh,reg_eidl,reg_dlc;
    //Select an empty tx buffer//婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犺銇勯幇鍓佺暠缂佺媭鍨堕弻?闂傚倸鍊峰ù鍥х暦閸偅鍙忛柡澶嬪殮濞差亜围濠㈣泛顑呮禒閬嶆⒑闂堟侗鐒鹃柛搴㈢懇閺佹劖寰勬繝鍕靛悈闂備胶绮…鍥极閹间焦鍋傞柡鍌氱氨閺�浠嬫煟閹邦剙绾ч柍缁樻礀闇夋繝濠傚缁犵偤鏌℃担鍝バч柡?
    if((MCP2515_ReadByte(Mcp2515_TXB0CTRL)&Mcp2515_TXREQ)==0)//TXBnCTRL闂傚倸鍊搁崐鐑芥倿閿曗偓椤啴宕稿Δ浣镐簵婵犮垼鍩栭崝鏇犵不椤栫偞鐓�?闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顭堥崕顖炲焵椤掍礁娴�规洜鍏橀、姗�鎮╁▓鎸幮﹂梻鍌欑閹诧紕绮欓幋锔藉仱闁靛ň鏅涢悿鐐亜閹哄秶鍔嶉柛娆忕箲缁绘繈妫冨☉娆樻￥闂佺偨鍎查悵鎬慟闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熼悜妯荤叆闁哄鐗忛埀顒�绠嶉崕鍗炍涘▎鎾崇煑闊洦绋掗悡蹇涙煕椤愶絿绠ユ俊鎻掓啞娣囧﹪顢曢敐蹇氣偓鍧楁煛鐏炲墽娲村┑锛勫厴楠炲鈹戦崱妯活啀闁诲骸鍘滈崑鎾寸箾閹存瑥鐏柍閿嬪笒閵嗘帒顫濋浣规倷婵炲瓨绮嶉〃鍡欐崲濞戙垹绾ч柟瀵稿仜閺嬬姴顪冮妶鍐ㄧ仾鐎光偓閹间降鈧礁螖閸涱喗娅㈤梺鍏间航閸庢彃鈻嶈箛娑欌拻濞达絼璀﹂悞楣冩煛閸偄澧撮柟顔炬焿椤﹀绱掗鑺ヮ棃闁�?
    {
        tx_ctrl=Mcp2515_TXB0CTRL;
        tx_buf_addr=Mcp2515_TXB0D0;//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂佹寧娲栭崐鎼佸垂閸岀偞鐓曠憸搴ㄣ�冮崱娑樼柧闁归棿鐒﹂悡娆撴倵濞戞顏嗙箔閳哄懏鐓曢煫鍥ㄦ尵閻忚京绱掓潏銊ユ诞妤犵偛顦遍埀顒婄秵閸撴盯寮抽妶澶嬪�甸悷娆忓缁�鍐煥閺囨ê鐏查柣娑卞櫍楠炴鎷犻懠顒夊敽闂備胶顢婇幓顏堟⒔閸曨垼鏁婇柛鎰靛枟閳锋帒霉閿濆牆袚闁靛棗鍟撮弻銈団偓鍦Т閻撴劙鏌￠崨鐗堢【閾绘牠鏌嶈閸撶喖骞冩ィ鍐ㄥ瀭妞ゆ劑鍊楅幊婵嬫⒑鐠恒劌鏋欐俊顐㈠閹儳鐣￠幏鏃傚枔閹即鍩勯崘顏佸亾婵犳碍顥婃い鎰╁灪婢跺嫰鏌熼崫銉劸閺佸牓鏌＄仦璇插姕闁抽攱鍨堕幈銊╂偡閻楀牊鎮欐繝纰樷偓鐐藉仮闁诡喗顨呴～婵嬫偂鎼粹檧鎷梻浣筋嚃閸垶鎮為敃鍌氱畾闁哄啫鐗婇弲鏌ョ叓閸ャ劍鐓ユい蹇氭硾閳规垿鎮欓弶鎴犱桓濡炪倕娴氭禍顏堛�侀弮鍫濈闁靛濡囬埀顒佹そ濮婃椽宕烽鐐插濡炪們鍔岄幊姗�鐛幋锕�閱囬柡鍥╁枔閸樺憡绻濋姀锝嗙【妞ゆ垵鎳橀、姘煥閸涱垳锛滈梺鍦帛鐢晠鎮￠崗鍏煎弿濠电姴鍟妵婵囥亜閵忊剝绀嬪┑顔瑰亾闂佸啿鎼崐鎰板Ψ閳哄倻鍘介梺缁樏崯鎸庢叏婢舵劖鐓曢煫鍥ㄦ閺嗘棿0闂傚倸鍊搁崐鐑芥倿閿曗偓椤啴宕稿Δ浣镐簵婵犮垼鍩栭崝鏇犵不椤栫偞鐓�?
        tx_cmd=Mcp2515_SPI_RTS_TXB0;//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂佹寧娲栭崐鎼佸垂閸岀偞鐓曠憸搴ㄣ�冮崱娑樼柧闁归棿鐒﹂悡娆撴倵濞戞顏嗙箔瑜旈弻娑㈠棘鐠恒剱銏ゆ煃鐟欏嫬鐏存い銏＄懇瀹曨偊宕熼妸銉ゅ濠电娀娼уΛ顓㈠吹閺囩喆浜滈柟鐑樺灥椤忊晠鏌ｉ幇顒婅含闁哄本娲樼换娑㈠垂椤旂厧袘婵犵妲呴崹鎵偓姘煎幘閹广垹鈽夊锝呬壕闁汇垺顔栭悞鍓ф偖閵娾晜鈷戠紒瀣皡閺�鑽ょ磼鐠囪尙澧︾�殿噮鍋婇獮妯肩磼濡櫣妾┑鐘灱閸╂牞鎽柛鐔告倐濮婃椽鎳￠妶鍛咃綁鏌涢弮鈧〃濠傜暦濡も偓椤繘宕�?闂傚倸鍊搁崐鐑芥倿閿曗偓椤啴宕稿Δ浣镐簵婵犮垼鍩栭崝鏇犵不椤栫偞鐓�?
        reg_sidh=Mcp2515_TXB0SIDH;
        reg_sidl=Mcp2515_TXB0SIDL;
        reg_eidh=Mcp2515_TXB0EID8;
        reg_eidl=Mcp2515_TXB0EID0;
        reg_dlc=Mcp2515_TXB0DLC;
    }
    else if((MCP2515_ReadByte(Mcp2515_TXB1CTRL)&Mcp2515_TXREQ)==0)
    {
        tx_ctrl=Mcp2515_TXB1CTRL;
        tx_buf_addr=Mcp2515_TXB1D0;//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂佹寧娲栭崐鎼佸垂閸岀偞鐓曠憸搴ㄣ�冮崱娑樼柧闁归棿鐒﹂悡娆撴倵濞戞顏嗙箔閳哄懏鐓曢煫鍥ㄦ尵閻忚京绱掓潏銊ユ诞妤犵偛顦遍埀顒婄秵閸撴盯寮抽妶澶嬪�甸悷娆忓缁�鍐煥閺囨ê鐏查柣娑卞櫍楠炴鎷犻懠顒夊敽闂備胶顢婇幓顏堟⒔閸曨垼鏁婇柛鎰靛枟閳锋帒霉閿濆牆袚闁靛棗鍟撮弻銈団偓鍦Т閻撴劙鏌￠崨鐗堢【閾绘牠鏌嶈閸撶喖骞冩ィ鍐ㄥ瀭妞ゆ劑鍊楅幊婵嬫⒑鐠恒劌鏋欐俊顐㈠閹儳鐣￠幏鏃傚枔閹即鍩勯崘顏佸亾婵犳碍顥婃い鎰╁灪婢跺嫰鏌熼崫銉劸閺佸牓鏌＄仦璇插姕闁抽攱鍨堕幈銊╂偡閻楀牊鎮欐繝纰樷偓鐐藉仮闁诡喗顨呴～婵嬫偂鎼粹檧鎷梻浣筋嚃閸垶鎮為敃鍌氱畾闁哄啫鐗婇弲鏌ョ叓閸ャ劍鐓ユい蹇氭硾閳规垿鎮欓弶鎴犱桓濡炪倕娴氭禍顏堛�侀弮鍫濈闁靛濡囬埀顒佹そ濮婃椽宕烽鐐插濡炪們鍔岄幊姗�鐛幋锕�閱囬柡鍥╁枔閸樺憡绻濋姀锝嗙【妞ゆ垵鎳橀、姘煥閸涱垳锛滈梺鍦帛鐢晠鎮￠崗鍏煎弿濠电姴鍟妵婵囥亜閵忊剝绀嬪┑顔瑰亾闂佸啿鎼崐鎰板Ψ閳哄倻鍘介梺缁樏崯鎸庢叏婢舵劖鐓曢煫鍥ㄦ閺嗘棿1闂傚倸鍊搁崐鐑芥倿閿曗偓椤啴宕稿Δ浣镐簵婵犮垼鍩栭崝鏇犵不椤栫偞鐓�?
        tx_cmd=Mcp2515_SPI_RTS_TXB1;//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂佹寧娲栭崐鎼佸垂閸岀偞鐓曠憸搴ㄣ�冮崱娑樼柧闁归棿鐒﹂悡娆撴倵濞戞顏嗙箔瑜旈弻娑㈠棘鐠恒剱銏ゆ煃鐟欏嫬鐏存い銏＄懇瀹曨偊宕熼妸銉ゅ濠电娀娼уΛ顓㈠吹閺囩喆浜滈柟鐑樺灥椤忊晠鏌ｉ幇顒婅含闁哄本娲樼换娑㈠垂椤旂厧袘婵犵妲呴崹鎵偓姘煎幘閹广垹鈽夊锝呬壕闁汇垺顔栭悞鍓ф偖閵娾晜鈷戠紒瀣皡閺�鑽ょ磼鐠囪尙澧︾�殿噮鍋婇獮妯肩磼濡櫣妾┑鐘灱閸╂牞鎽柛鐔告倐濮婃椽鎳￠妶鍛咃綁鏌涢弮鈧〃濠傜暦濡も偓椤繘宕�?闂傚倸鍊搁崐鐑芥倿閿曗偓椤啴宕稿Δ浣镐簵婵犮垼鍩栭崝鏇犵不椤栫偞鐓�?
        reg_sidh=Mcp2515_TXB1SIDH;
        reg_sidl=Mcp2515_TXB1SIDL;
        reg_eidh=Mcp2515_TXB1EID8;
        reg_eidl=Mcp2515_TXB1EID0;
        reg_dlc=Mcp2515_TXB1DLC;
    }
    else if((MCP2515_ReadByte(Mcp2515_TXB2CTRL)&Mcp2515_TXREQ)==0)
    {
        tx_ctrl=Mcp2515_TXB2CTRL;
        tx_buf_addr=Mcp2515_TXB2D0;//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂佹寧娲栭崐鎼佸垂閸岀偞鐓曠憸搴ㄣ�冮崱娑樼柧闁归棿鐒﹂悡娆撴倵濞戞顏嗙箔閳哄懏鐓曢煫鍥ㄦ尵閻忚京绱掓潏銊ユ诞妤犵偛顦遍埀顒婄秵閸撴盯寮抽妶澶嬪�甸悷娆忓缁�鍐煥閺囨ê鐏查柣娑卞櫍楠炴鎷犻懠顒夊敽闂備胶顢婇幓顏堟⒔閸曨垼鏁婇柛鎰靛枟閳锋帒霉閿濆牆袚闁靛棗鍟撮弻銈団偓鍦Т閻撴劙鏌￠崨鐗堢【閾绘牠鏌嶈閸撶喖骞冩ィ鍐ㄥ瀭妞ゆ劑鍊楅幊婵嬫⒑鐠恒劌鏋欐俊顐㈠閹儳鐣￠幏鏃傚枔閹即鍩勯崘顏佸亾婵犳碍顥婃い鎰╁灪婢跺嫰鏌熼崫銉劸閺佸牓鏌＄仦璇插姕闁抽攱鍨堕幈銊╂偡閻楀牊鎮欐繝纰樷偓鐐藉仮闁诡喗顨呴～婵嬫偂鎼粹檧鎷梻浣筋嚃閸垶鎮為敃鍌氱畾闁哄啫鐗婇弲鏌ョ叓閸ャ劍鐓ユい蹇氭硾閳规垿鎮欓弶鎴犱桓濡炪倕娴氭禍顏堛�侀弮鍫濈闁靛濡囬埀顒佹そ濮婃椽宕烽鐐插濡炪們鍔岄幊姗�鐛幋锕�閱囬柡鍥╁枔閸樺憡绻濋姀锝嗙【妞ゆ垵鎳橀、姘煥閸涱垳锛滈梺鍦帛鐢晠鎮￠崗鍏煎弿濠电姴鍟妵婵囥亜閵忊剝绀嬪┑顔瑰亾闂佸啿鎼崐鎰板Ψ閳哄倻鍘介梺缁樏崯鎸庢叏婢舵劖鐓曢煫鍥ㄦ閺嗘棿2闂傚倸鍊搁崐鐑芥倿閿曗偓椤啴宕稿Δ浣镐簵婵犮垼鍩栭崝鏇犵不椤栫偞鐓�?
        tx_cmd=Mcp2515_SPI_RTS_TXB2;//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂佹寧娲栭崐鎼佸垂閸岀偞鐓曠憸搴ㄣ�冮崱娑樼柧闁归棿鐒﹂悡娆撴倵濞戞顏嗙箔瑜旈弻娑㈠棘鐠恒剱銏ゆ煃鐟欏嫬鐏存い銏＄懇瀹曨偊宕熼妸銉ゅ濠电娀娼уΛ顓㈠吹閺囩喆浜滈柟鐑樺灥椤忊晠鏌ｉ幇顒婅含闁哄本娲樼换娑㈠垂椤旂厧袘婵犵妲呴崹鎵偓姘煎幘閹广垹鈽夊锝呬壕闁汇垺顔栭悞鍓ф偖閵娾晜鈷戠紒瀣皡閺�鑽ょ磼鐠囪尙澧︾�殿噮鍋婇獮妯肩磼濡櫣妾┑鐘灱閸╂牞鎽柛鐔告倐濮婃椽鎳￠妶鍛咃綁鏌涢弮鈧〃濠傜暦濡も偓椤繘宕�?闂傚倸鍊搁崐鐑芥倿閿曗偓椤啴宕稿Δ浣镐簵婵犮垼鍩栭崝鏇犵不椤栫偞鐓�?
        reg_sidh=Mcp2515_TXB2SIDH;
        reg_sidl=Mcp2515_TXB2SIDL;
        reg_eidh=Mcp2515_TXB2EID8;
        reg_eidl=Mcp2515_TXB2EID0;
        reg_dlc=Mcp2515_TXB2DLC;
    }
    else
    {
        printf("No available tx buffer.\r\n");
//      Mcp2515_gs_u64SndPkgBadCnt++;
        return;
    }


    if(Frame->Type==EN_CAN_BUS_STD)//闂傚倸鍊峰ù鍥х暦閻㈢绐楅柟鎵閸嬶繝鏌曢崼婵愭Ч闁稿﹤娼￠弻銊╁籍閸ヮ灝鎾寸箾閸涱垰校缂佺粯绻冪换婵嬪磼濠婂喚鏆紓鍌欒閸嬫捇鏌涢幇闈涙灍闁稿﹤鐏氱换娑㈠箣閻戝洣绶甸梺缁樼墬闁斤繝姊婚崒姘偓鐑芥嚄閸洏鈧焦绻濋崟顓狀槱婵炴潙鍚嬪娆戝閸ф鐓涢悘鐐额嚙閸旀岸鏌涢幋鐘测枅闁哄本鐩獮鍥礂閸濄儱鍤梻浣告惈濡瑧鍒掓惔銊ョ疅闁告稑锕ょ欢鐐烘煙闁箑骞楁繛鍛灲濮婃椽宕楅梻纾嬪焻闂佺瀛╅悡锟犲箖閳ユ枼妲堥柕蹇ョ磿閸欏棝姊虹紒妯活梿妞ゆ泦鍡╂毐闂傚倷绀佸﹢閬嶅疾椤愶箑绠栨い鈥筹攻缁绘繈鎮介棃娑楃捕濡炪倖娲﹂崢浠嬪礆婵犲嫧鍋撻棃娑欐喐缂佲偓婵犲洦鐓ラ柣鏂垮閻瑩鏌＄仦鐐鐎规洖宕灃闁逞屽墴瀵娊鏁愰崶锝呬壕婵炲牆鐏濋弸娆戠磼椤旂晫鎳冮柣锝囧厴楠炲棝鏌囬敂鍙晜绻濋悽闈涗粶闁瑰啿绻橀幃鐑藉煛閸涱叀鎽曢梺鏂ユ櫅閸燁垱鍒婇幘顔界厱婵犻潧妫楅鎾煛閸♀晛寮柟顔筋殘閹叉挳宕熼鈧惌顕�姊洪悡搴℃毐闁绘牜鍘ч锝夘敃閿旂粯鏅梺閫炲苯澧寸�殿噮鍋婇獮妯肩磼濡粯顏熼梻?
    {
        /*Set the ID of the frame*//*闂傚倸鍊峰ù鍥х暦閸偅鍙忕�规洖娲ㄩ惌鍡椕归敐鍫綈婵炲懐濮撮湁闁绘ê妯婇崕鎰版煕鐎ｅ吀閭柡灞剧洴閸╁嫰宕橀鍛珬闂備礁鎼Λ娆戝垝鎼淬劌绠熸慨婵嗙灱閻も偓闂佸湱铏庨崹閬嶆倶娓氣偓濮婅櫣娑甸崨鏉戞懙濠电姭鍋�?*/
        HSID=(uint8_t)(Frame->ID>>3);//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁嶉崟顐ｇ�抽悗骞垮劚椤︻垶鎯屽Δ鍛叆闁绘棁娅ｉ妶顥� H闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁嶉崟顐㈢亰閻庡厜鍋撻柛鏇炵仛閺呫垽姊�?闂傚倸鍊峰ù鍥敋瑜旈弻濠囨晲閸滀胶鍔烽悷婊冪箻閸┾偓妞ゆ帊绀侀崵顒勬煕閹捐泛鏋涙鐐插暙鐓ゆい蹇撳珋閳哄懏鐓冮弶鐐村缁愭梹淇婇銈呭幋婵﹥妞藉Λ鍐ㄢ槈鏉堚晛濮奸梻浣侯焾闁帮絾绂嶇捄渚殨闁哄被鍎辩粻鐟懊归敐鍛础闁告﹢浜跺Λ鍛搭敃閵忊�冲亶闂佺姘︾亸娆撳焵?1婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ら幁鎺戝姢闁崇粯姊婚埀顒�鍘滈崑鎾绘煛鐏炶鍔滈柍閿嬪灩缁辨帞鈧綆浜滈惃锟犳煕閺冨倸鏋涢柡灞炬礋瀹曞崬螖婵犲倸澹嬫繝纰樷偓鍐茬骇闁告梹娲熼崺銏℃償閵娿儳顔掗悗瑙勬礀濞村倸危閹绢喗鈷掑ù锝堟閵嗗﹪鏌涢幘瀵哥疄闁靛棗鍟村畷銊р偓娑櫭埀顒�鐏濋埞鎴﹀磼濮橆厼鏆堥梺缁樻尰濞茬喖寮婚悢鍏肩劷闁挎洍鍋撴鐐达耿閺岀喖宕橀幓鎺撴闂佸搫鏈粙鎴﹀煝鎼粹檧鏋庨柟閭﹀墻娴�?0:3 2:0婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ｉ敐鍛伇闁活厽鐟╅弻娑㈠即閵娿儱绠哄銈庡亝濞叉鎹㈠┑瀣棃婵炴垵宕崜鎵磽娴ｅ搫袨闁稿海鏁诲濠氬Ω閳哄倸浜滈柣鐘叉处閻ｎ偊骞橀崜浣猴紲闂佺鏈粙鎴澝归灏栨斀闁挎稑瀚崢鎾煃閵夘垳鐣垫鐐差儔閹瑩鎮介棃娑樼畱缂傚倸鍊搁崐鎼佸磹妞嬪海鐭嗗〒姘ｅ亾閽樻繈鏌熼崜浣烘憘闁轰礁锕ら埞鎴︽偐閹绘帩浼�闂佸憡顨嗗畝鎼佸箖濡も偓閳藉鈻庡Ο鐓庡Ш闂備礁纾划顖毼涢崘顔肩畺婵°倕鎳忛弲鏌ユ煕鐏炲墽鈯曢柣婵囩墱缁辨挻鎷呴崜鍙壭ч梺鐟版啞婵炲﹤顕ｆ繝姘╅柕澶堝灪椤秹姊洪幆褎绂嬮柛瀣椤�?
        LSID=(uint8_t)((Frame->ID<<5)&0xE0);//闂傚倷娴囬褎顨ラ崫銉х濠电姴鍋嗛悞鐣岀磽娴ｅ鑲╂崲閸℃稒鐓曢柕澶樺灠椤╊剟鏌￠崟顐⑩偓鎼佸煘閹达附鍊烽柤纰卞墯閹茶偐绱撴笟鍥ф灈缂佸鎳撻锝夊及韫囷絾鞋缂傚倷娴囨禍顒勫磻閵堝懐鏆﹂柕濞р偓閸嬫挸鈽夊▍铏灥閳诲秹寮介鐔哄幗闂婎偄娲﹀ú鏍ㄧ閳哄倷绻嗘い鎰╁灩椤忣參鏌涢埡鍌滄创鐎殿喖鈧噥妲峰┑鈩冨絻閻楁捇寮婚悢鍏煎�锋い鎺嗗亾濠⒀屽灦閺屾稒鎯旈埄鍐╁闯缂備浇椴哥敮鎺椻�旈崘顔肩鐟滃秵淇婃禒瀣拺闁荤喐婢樺Σ濠氭煙閸愭煡鍙勬い銏∩戠缓鐣岀矙閸喚鐛╂俊鐐�栧濠氬磻閹炬椿鏁囧┑鐘崇閳锋帒銆掑锝呬壕濠电偠澹堝畷鐢稿箯鐎ｎ喗鏅插璺猴功椤斿棝姊�?婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ｉ敐鍛伇闁活厽鎸鹃幉鎼佹偋閸繄鐟ㄩ梻鍌氬亞閸ㄥ爼寮婚敐澶婄闁挎繂鎲涢幘缁樼厱閹艰揪绱曟晥闂佸搫鏈惄顖氼嚕閹绢喖惟闁靛／鍌氬闂佽崵鍠愮划鎾诲磻婵犲洤鍨傞柛顐ｆ礀缁犳牗淇婇妶鍌氫壕闂佸疇妫勯ˇ顖炲煝鎼粹垾鐔兼嚒閵堝棙鐦滃┑鐘垫暩婵兘銆傞挊澹╋綁宕熼姘鳖唵?
        MCP2515_WriteReg(reg_sidh,HSID);
        MCP2515_WriteReg(reg_sidl,LSID);
        /*Set the DLC and the type of the frame*//*闂傚倸鍊峰ù鍥х暦閸偅鍙忕�规洖娲ㄩ惌鍡椕归敐鍫綈婵炲懐濮撮湁闁绘ê妯婇崕鎰版煕鐎ｅ吀閭柡灞剧☉椤劑宕ㄩ鍓ь��C闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁嶉崟顐㈢亰閻庡厜鍋撻柛鏇ㄥ墮濞堬絽顪冮妶鍡欏⒈闁稿绋撶划濠氼敊閼恒儱寮垮┑鈽嗗灠閻忔繈鎮￠幇鐗堢厱閹艰揪绱曟晥闂佸搫鏈惄顖氼嚕閹绢喖惟闁靛鍎抽崫妤佷繆閻愵亜鈧倝宕戦幘鍓佷笉闁规崘顕ч拑鐔哥箾閹存梹鍣伴柍褜鍓ㄧ粻鎾荤嵁閹烘绠婚柟棰佹缁�?/
        MCP2515_WriteReg(reg_dlc,Frame->DLC|EN_CAN_BUS_STD);//闂傚倸鍊峰ù鍥х暦閸偅鍙忕�规洖娲ㄩ惌鍡椕归敐鍫綈婵炲懐濮撮湁闁绘ê妯婇崕鎰版煕鐎ｅ吀閭柡灞剧洴閸╁嫰宕橀浣诡潔闂備礁鎼鍕濮樿泛钃熼柨婵嗘啒閺冨牆鐒垫い鎺戝閸嬪鏌涢埄鍐噮闁活厼鐗撻弻銊╁即閻愭祴鍋撹ぐ鎺戠厱闁圭儤顨嗛悡銉╂煟閺傚灝顣抽柣顓熺懅閳ь剝顫夊ú鏍礊婵犲洢鈧礁鈻庨幋婵囩�抽梺鍛婎殘閸嬬偤寮抽鐐粹拻闁稿本鐟ч崝宥夋倵缁楁稑鎳愰惌娆撴煙鏉堥箖妾柛搴㈩殔閵嗘帒顫濋敐鍛婵＄偑鍊戦崹娲嚌妤ｅ喛缍栨繝闈涱儏缁犵喖鎮楅敐搴′簻妞ゅ繐鐖煎濠氬磼濮樺崬顤�缂備礁顑嗛崹鍧椼�侀弮鍫濈厸闁告侗鍠氶崢浠嬫煙閻戞ê鈻曠�规洘绻堥獮瀣攽閸喐顔曢梻浣筋潐閸庣厧螞閸曨剙鍔旈梻鍌欑閻ゅ洤顩奸妸鈺傚�块柨鏇炲亞閺佸倿鏌ｉ幇顔煎妺闁绘挻绋戦…璺ㄦ崉閻戞﹩妫″┑鐐叉噹濡繈骞忛幋鐐寸秶闁靛ě鍛闂備浇娉曢崰鏇熸叏閵堝绠柛娑欐綑閹硅埖銇勯幘瀵糕姇闁诲繐鍟村缁樻媴閼恒儳銆婇梺鍝ュУ濞叉﹢骞堥妸鈺佄ч柛銉㈡櫇閻撴挻绻濋姀锝呯厫闁告梹鐗犲畷鎴﹀冀椤儱閰ｅ畷鎯邦槼闁硅闄勭换婵嬫偨闂堟稐鍝楅梺瑙勬た娴滅偟妲愰悙鍝勭倞妞ゆ巻鍋撶紒鐙�鍨堕弻?
        /*Write the data into the TXB0 data registers */
        for(tempdata=0;tempdata<Frame->DLC;tempdata++)
        {
            MCP2515_WriteReg(tx_buf_addr+tempdata,CAN_TX_Buf[tempdata]);
        }
    }
    else if(Frame->Type==EN_CAN_BUS_RTR) /*if(CAN_FrameType==CAN_RTR)*///RTR
    {
        /*Set the ID of the frame*/
        HSID=(uint8_t)(Frame->ID>>3);
        LSID=(uint8_t)((Frame->ID<<5)&0xE0);
        MCP2515_WriteReg(Mcp2515_TXB0SIDH,HSID);
        MCP2515_WriteReg(Mcp2515_TXB0SIDL,LSID);
        /*Set the type of the frame*/
        MCP2515_WriteReg(Mcp2515_TXB0DLC,EN_CAN_BUS_RTR);
    }
    else if(Frame->Type==EN_CAN_BUS_EXD)//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂佹寧娲栭崐鎼佸垂閸岀偞鐓曠憸搴ㄣ�冮崱娑樼柧闁归棿鐒﹂悡娆撴倵濞戞顏嗙箔瑜旈弻娑㈠棘鐠恒剱銏°亜椤撯�冲姷妞わ箒鍩栫换娑欏緞鐎ｎ偆顦ㄧ紓浣稿�圭敮锟犲极閸愵喖纾兼慨姗嗗墮缁侇噣姊绘担铏瑰笡闁告梹鐗曢…鍥р枎閹垮嫮绋�?
    {
        SID=Frame->ID>>18;//闂傚倸鍊搁崐椋庣矆娴ｉ潻鑰块梺顒�绉查埀顒�鍊圭粋鎺斺偓锝庝簽閺屟冣攽閻愭潙鐏熼柛銊︽そ瀹曟洟骞橀崹娑樹壕妤犵偛鐏濋崝姘箾鐠囇呯暤鐎殿喖鍟块…銊╁川椤斿吋鐎鹃柣搴″帨閸嬫捇鏌涢弴銊ュ婵炲牊锕㈠铏规兜閸涱喖娑х紓浣哄У閸ㄥ灝顕ｆ导鏉懳ㄩ柍鍝勫�婚崢浠嬫⒑閻熼偊鍤熼柛濠冪墵楠炲鏁冮埀顒傜不椤栫偞鐓熼柍鍝勫�婚悰鏇炩攽閻樺灚鏆╅柛瀣洴椤㈡岸顢橀悢宄扮亖闁诲酣娼ч幗婊呯矆婵犲洦鐓ラ柣鏂垮閻瑩鏌＄仦鐐鐎规洖宕灃闁逞屽墴瀵娊鎮欓悽鐢碉紲闂佺鏈銊︽櫏闂備浇妗ㄩ悞锕傚箲閸ヮ剙鏋侀柟鍓х帛閺�?9婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ｉ敐鍛伇闁活厽鎹囬弻锝夊閻樺啿鏆堥梺绋款儏椤︾敻寮婚妸銉㈡斀闁糕剝锚椤︹晠鏌ｆ惔銏㈩暡鐎光偓閹间礁钃熸繛鎴欏灩閻掓椽鏌涢幇鍏哥凹闁革絼绮欏铏圭矙閸ф鈧鏌ㄩ弴銊ら偗鐎殿喖顭烽弫鎰緞婵炩懇鏅犻弻鏇熷緞閸繂濮舵繛瀵稿帶閸熸潙顫忛搹鍦＜婵☆垵鍋愰鍥⒑?1婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁�濠囨煕閵夘喖澧紒鐙�鍨堕弻?
        SID&=0x7ff;
        HSID=(uint8_t)(SID>>3);//闂傚倸鍊搁崐鐑芥嚄閸洍鈧箓宕奸姀鈥冲簥闂佽澹嗘晶妤呭磻鐎ｎ喗鐓曢柍鈺佸暙閹肩霉濠婂啰绉洪柡灞剧☉閳规垿宕熼銏犘戦梻浣规た閸樹粙骞戦崶顒�钃熼柕濞炬櫆閸嬪棝鏌涚仦鍓р槈妞�?8婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ｉ敐鍛伇闁活厽鎹囬幃瑙勩偊鐟併倐鍋撻埀顒勬煛鐎ｎ偅顥堥柡宀�鍠愬蹇涘礈瑜忛弳鐘电磼閻愵剙鍔ょ紓宥咃躬瀵鏁愭径濠勵啋闂佸憡鍔曞Ο濠囧礉婢舵劖鈷戞慨鐟版搐婵′粙鏌涢妸銉﹀仴鐎殿喖顭烽弫鎾绘偐閼碱剦妲归梻鍌氬�搁悧濠勭矙閹惧顩烽柟闂寸劍閳锋垹绱撴担璇＄劷缂佺姳鍗抽弻?1婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁�濠囨煕閵夘喖澧紒鐙�鍨堕弻?
        LSID=(uint8_t)((SID<<5)&0xE0);

        EID=Frame->ID &0x3FFFF;//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鑼唶闂佸湱铏庨崰鏍偪閻愵剛绠鹃柛鈩兠悘鈺冪磼閻樿櫕顥堥柡灞剧洴瀵粙濡搁敂鐣岀獨D婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犲綊鏌嶉崫鍕櫣闁稿被鍔戦弻鐔碱敍閸″繐浜鹃梺鍝勵儐濡啴寮婚妸鈺傚亞闁稿本绋戦?8婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁�濠囨煕閵夘喖澧紒鐙�鍨堕弻?
        SIDLEID=(uint8_t)(EID>>16);//SIDL婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犲綊鏌嶉崫鍕櫣闁稿被鍔戦弻鐔碱敍閸″繐浜鹃梺鍝勵儐濡啴寮婚妸鈺傚亞闁稿本绋戦?婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁�濠囨煕閵夘喖澧紒鐙�鍨堕弻?
        HEID=(uint8_t)(EID>>8);//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧锛忛崘鐐棥婵＄偑鍊栭幐鑽ゆ崲閸曨垰鍙�?婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ｉ敐鍛伇闁活厽鎸鹃埀顒冾潐濞叉牕煤閵婏妇鈻旂�广儱顦伴悡銉︾節闂堟稒锛嶆俊鍙夋倐閹嘲鈻庡▎鎴犳殼濡ょ姷鍋為悧婊堝礆閹烘鍎岄柛娑橈工椤忓爼鎮楃憴鍕婵炲眰鍔戦幃楣冨箮閼恒儮鎷绘繛杈剧到閹诧繝宕悙鐑樺仺妞ゆ牗渚楀▓婊呪偓瑙勬礃濞茬喖骞冮敓鐘靛祦闁绘棃顥撶粔铏光偓瑙勬礀瀹曨剟鍩ユ径濞㈢喓鍠婇崡鐐存毉闂傚倸鍊风欢姘焽瑜忛幑銏ゅ箳閹炬潙寮挎俊鐐差儏缁ㄥ爼宕戦幘缁樺仭闂侇叏闄勯埢鍫ユ⒑鐠団�虫灈缂傚秴锕ら悾鐑藉醇閺囩倣銊╂煏婢跺牆鍔氭い顐ｆ崌閺岋綁鎮㈤崫銉х厑濠电姰鍨洪敋妞ゆ洩缍佸畷婊勬媴閾忓湱鍔归梻浣告贡閸庛倝銆冮崨顓熸殰闂傚倷绶氬褔鏁嶈箛娑樺窛妞ゆ牗绮嶅▓娲⒒閸屾艾鈧绮堟笟鈧獮澶愭晬閸曨剚娈板銈呯箰閻楀棛绮婚鐐寸叆?5:8婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁�濠囨煕閵夘喖澧紒鐙�鍨堕弻?
        LEID=(uint8_t)EID;//闂傚倸鍊搁崐鐑芥嚄閸洖纾块柣銏㈩焾閻ょ偓绻涢幋娆忕仾闁稿鍊濋弻鏇熺箾瑜嶇�氼厼鈻撴导瀛樷拺闁告繂瀚峰Σ褰掓煕閳轰胶澧︾�规洜鏁诲鎾閿涘嫬骞堟繝鐢靛█濞佳兾涘Δ鍜佹晜闁冲搫鎳忛悡鐔兼煙閻愵剚缍戦柣蹇擃嚟閳ь剚顔栭崰鏍偉婵傜绠栨繝濠傜墕楠炪垺淇婇妶鍌氫壕濡炪値鍋掓禍顏堝箖濡ゅ啯鍠嗛柛鏇ㄥ墰椤︺劑姊虹紒妯诲皑闁逞屽墮绾绢參寮抽敃鍌涚厪闊洤顑呴悘顔剧棯閹冩倯濞ｅ洤锕、娑樷攽閸ユ湹鍝楁俊鐐�曠换妤併仈閸涘﹦鈹嶅┑鐘叉搐鍥撮梺鍛婁緱閸樻悂宕戦幘璇叉嵍妞ゆ挾鍠撻悾宕囩磽閸屾艾鈧悂宕愰崫銉х煋闁圭虎鍠栫粻鐘虫叏濡炶浜鹃悗娈垮櫘閸嬪嫰顢樻總绋跨倞闁挎棁妫勬刊浼存⒒娴ｈ棄袚闁挎碍銇勯敂璇蹭喊妤犵偞鍔欏畷銊╊敊閸撗屽晭闂備胶鎳撻顓㈠磻閻愬搫绠氶柛顐犲劜閻撴瑩鏌涢幋娆忊偓鏍偓?婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ｉ敐鍛伇闁活厽鎹囬弻鈩冨緞鐎ｎ亞鍔稿┑鐐茬毞閺呯娀寮婚弴鐔虹闁绘劦鍓氶悵鏃堟⒑閸涘﹦鎳冮柨鏇樺劦婵＄敻宕熼姘敤闂侀潧臎閸曨偅鐝紓鍌氬�风粈渚�篓閳ь剟鏌�?婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁�濠囨煕閵夘喖澧紒鐙�鍨堕弻?

        MCP2515_WriteReg(reg_sidh,HSID);
        MCP2515_WriteReg(reg_sidl,LSID | Mcp2515_EXIDE_SET | SIDLEID);//闂傚倸鍊搁崐椋庣矆娴ｉ潻鑰块梺顒�绉查埀顒�鍊圭粋鎺斺偓锝庝簽閺屟冣攽閻愭潙鐏熼柛銊︽そ瀹曟洟骞橀崹娑樹壕妤犵偛鐏濋崝姘繆椤愶絿鎳勯柛鎺戯躬楠炴﹢顢欓悾灞藉箻闂備礁缍婇。锔剧矆娓氣偓閹﹢鎮╃紒妯煎幈濠碘槅鍨崇划顖滅礊閹达附顥嗗鑸靛姈閻撶喐鎱ㄥΔ鈧Λ妤呭几濞戙垺鐓曢柡鍐ｅ亾婵ǜ鍔戦崺鈧い鎺嶇贰閸熷繘鏌涢悩鍏呬孩闁哥姵鏉疍婵犵數濮撮惀澶愬级鎼存挸浜鹃柡鍥ュ灩绾惧綊鏌涢敂璇插箺缂佺姵甯″娲嚒閵堝懍娌繛锝呮川閸庛倝濡甸弮鍫濈濞达絽鎽滈鍡涙⒑閸涘﹦鈽夐柣掳鍔戝鏌ュ箹娴ｅ湱鍙嗛梺缁樻礀閸婂湱鈧�?

        MCP2515_WriteReg(reg_eidh,HEID);
        MCP2515_WriteReg(reg_eidl,LEID);

        MCP2515_WriteReg(reg_dlc,Frame->DLC);//闂傚倸鍊峰ù鍥х暦閸偅鍙忕�规洖娲ㄩ惌鍡椕归敐鍫綈婵炲懐濮撮湁闁绘ê妯婇崕鎰版煕鐎ｅ吀閭柡灞剧洴閸╁嫰宕橀浣诡潔闂備礁鎼鍕濮樿泛钃熼柨婵嗘啒閺冨牆鐒垫い鎺戝閸嬪鏌涢埄鍐噮闁活厼鐗撻弻銊╁即閻愭祴鍋撹ぐ鎺戠厱闁圭儤顨嗛悡銉╂煟閺傚灝顣抽柣顓熺懅閳ь剝顫夊ú鏍礊婵犲洢鈧礁鈻庨幋婵囩�抽梺鍛婎殘閸嬬偤寮抽鐐粹拻闁稿本鐟ч崝宥夋倵缁楁稑鎳愰惌娆撴煙鏉堥箖妾柛搴㈩殔閵嗘帒顫濋敐鍛婵＄偑鍊戦崹娲嚌妤ｅ喛缍栨繝闈涱儏缁犵喖鎮楅敐搴′簻妞ゅ繐鐖煎濠氬磼濮樺崬顤�缂備礁顑嗛崹鍧椼�侀弮鍫濈厸闁告侗鍠氶崢浠嬫煙閻戞ê鈻曠�规洘绻堥獮瀣攽閸喐顔曢梻浣筋潐閸庣厧螞閸曨剙鍔旈梻鍌欑閻ゅ洤顩奸妸鈺傚�块柨鏇炲亞閺佸倿鏌ｉ幇顔煎妺闁绘挻绋戦…璺ㄦ崉閻戞﹩妫″┑鐐叉噹濡繈骞忛幋鐐寸秶闁靛ě鍛闂備浇娉曢崰鏇熸叏閵堝绠柛娑欐綑閹硅埖銇勯幘瀵糕姇闁诲繐鍟村缁樻媴閼恒儳銆婇梺鍝ュУ濞叉﹢骞堥妸鈺佄ч柛銉㈡櫇閻撴挻绻濋姀锝呯厫闁告梹鐗犲畷鎴﹀冀椤儱閰ｅ畷鎯邦槼闁硅闄勭换婵嬫偨闂堟稐鍝楅梺瑙勬た娴滅偟妲愰悙鍝勭倞妞ゆ巻鍋撶紒鐙�鍨堕弻?

        for(tempdata=0;tempdata<Frame->DLC;tempdata++)
        {
            MCP2515_WriteReg(tx_buf_addr+tempdata,CAN_TX_Buf[tempdata]);
        }
    }
    else
    {
        printf("No available type.\r\n");
        return;
    }

    /*Send the SPI_RTS_TXB0 request command to MCP2515 to send the data loaded in the data register*/
    MCP2515_CsActive();
    SPI_Send(tx_cmd);
    MCP2515_CsInActive();

    Djy_EventDelay(5*mS);
    tempdata=SPI_CMD_MCP2515(Mcp2515_SPI_READ_STATUS);
    if(0==(tempdata & 0x54))
    {
//      Mcp2515_gs_u64HardSndCnt++;
    }
    else
    {
//      Mcp2515_gs_u64SndPkgBadCnt++;
        //闂傚倸鍊搁崐椋庣矆娴ｈ櫣绀婂┑鐘插亞閻掔晫鎲搁弮鍫涒偓渚�寮介鐐茬獩濡炪倖妫佸Λ鍕嚕閸ф鈷戦悗鍦У閵嗗啴姊婚崟顐ばч柡浣规崌閹崇偤濡烽妷锕佺檨闁诲氦顫夊ú蹇涘礉閹达负鈧礁顫滈埀顒勫箖濞嗘挻顥堟繛鎴炴皑閸樻娊姊婚崒姘偓鎼佸磹妞嬪孩顐介柨鐔哄Т绾惧鏌涘畝鈧崑鐐哄吹閸曨垱鐓犵紒瀣硶娴犳盯鏌涘▎蹇曠闁哄瞼鍠栧鑽も偓闈涘濡差喚绱撴担鍝勑ｉ柛銊ф暬濠�渚�姊洪幐搴ｇ畵闁瑰啿绻掗幏褰掓晸閻樺磭鍘遍梺闈涱焾閸庮垶宕戦姀銈嗙厽闁瑰灝鍟禍鎵偓瑙勬礀閻栧吋淇婇幖浣规櫜闁告洦鍓欐刊鎵磽閸屾艾鈧悂宕愰崫銉х煓闁告洦鍨扮粻?
        MCP2515_BitModify(tx_ctrl,Mcp2515_TXREQ,0x00);
    }
}

/**
  * @brief  Receive n bytes from MCP2515 RXB0
  * @param  none
  * @retval Data:return the effectively data from RXB0
  */
//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鎳忛崳娲煟閹惧鎳囬柡宀�鍠栭、姗�鎮㈡搴ｆ噯闂備礁鎲″鍦垝閹捐钃熼柍鈺佸暞婵挳鏌涘┑鍕姢濡ゆ棃鏌ｆ惔銏╁晱闁革綆鍣ｅ畷鎴炵節閸パ呯暫閻熸粍鏌ㄩ悾鐑芥偂鎼存ɑ鏂�闂佸壊鍋呯粙鎴炵?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挻宀搁獮鍫ュΩ閵夘喗寤洪梺绯曞墲椤ㄥ懘锝為锔解拺闁革富鍘藉▍鏇炩攽閻愨晛浜鹃梻浣告惈閻鎹㈠┑瀣瀬闁规儳顕々鐑芥倵閿濆簼绨介柣鎾村灴濮婃椽妫冨☉宕囩闂佸憡渚楅崹浼寸嵁濮椻偓濮婄粯鎷呯粵瀣闂備礁搴滅徊浠嬧�﹂崶顏嶆Ь闂侀�炲苯澧柛鎴濈秺瀹曟粓鎮㈤悡搴ｇ暫濠电偛妯婃禍婊勫劔闂備礁鐤囧銊ф濮橆儵娑㈡倻閼恒儮鎷洪梻鍌氱墛閸楁洟宕奸妷銉ф煣濠电偞鍨惰彜闁哄绉归弻銊╂偄閸濆嫅锝夋煟閹惧瓨绀冪紒缁樼洴瀹曞崬螣閸濆嫷娼曞┑鐘媰鐏炲ジ鍋楅梺鍝勬湰閻╊垱淇婇懜鍨劅闁炽儱纾惈鍕⒒娴ｇ瓔鍤冮柛銊ゅ嵆瀹曨垶寮堕幋鐘虫闂佺粯姊婚埛鍫ュ极閸℃褰掓晲閸偄娈愰梺鍝ュ暱閸嬫捇姊婚崒姘偓鐑芥嚄閸洏鈧焦绻濋崶鑸垫櫔闂佸搫绋侀崢鑲╃玻濡や焦鍙忔慨妤�妫楅崢鎾煛鐎ｎ偅顥堥柡宀�鍠愬蹇涘礈瑜忛弳鐘绘⒑閸︻厽鍤�闁绘牕銈稿濠氬焺閸愩劎绐為柣搴秵娴滃爼宕电�ｎ剛纾藉ù锝囨嚀缁茬粯銇勯鐘插幋鐎殿喖顭锋俊鎼佸Ψ閵忊槅娼旀繝纰樻閸ㄥ磭鍒掗鐐茬閺夊牄鍔庣弧鈧┑鐐茬墕閻忔繈寮搁弮鍫熺厱濠电姴鍟扮粻鎾淬亜閺囶亞绉い銏☆殜瀹曠喖顢曢妶鍛亾閻愮儤鍋℃繝濠傚暙椤掋垽鏌熸笟鍨闁�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愭祴鏀介悗锝庝簽閻も偓濠电偠鎻徊浠嬪箟閿熺媭鏁婇柟杈鹃檮閳锋帒霉閿濆牊顏犻悽顖涚♁閵囧嫰顢橀悙闈涒叺閻庤娲樺钘夘嚕娴犲鏁囬柣鏂挎啞椤忕喖姊绘担鐑樺殌闁宦板妿閺侇噣鍨鹃幇浣衡偓鍫曟煟閹达絽袚闁绘挶鍎甸弻锝夊籍閸屻倗鍔搁梺璇茬箰閿曘儳鎹㈠☉銏犵骇闁瑰鍋涢弸鐘差渻閵堝啫鐏痪鏉跨Ф閳ь剟娼ч妶绋款嚕閸洖绠ｉ柨娑氬濞茬喎顫忓ú顏勫窛濠电姴鍟ˇ鈺呮⒑閸涘﹦鎳冨Δ鐘虫倐閳ワ箓宕惰濞尖晠鏌ら崫銉︽毄闁告ê鎲＄换娑欐綇閸撗冨煂闂佸湱鈷堥崑濠囧Υ閸岀偞鍤冮柍瑙勫劤娴滈箖鎮峰▎蹇擃仾闁诡垰鐗撻弻?闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁稿绻濋弻宥夊传閸曨剙娅ｉ梻鍌氬亞閸ㄥ爼寮婚敐澶婄闁挎繂妫Λ鍕⒑濞茶骞楁い銊ユ婵＄敻宕熼鍓ф澑闂佽鍎抽顓㈠Χ閳哄懏鈷戦柛婵勫劚閺嬪酣姊虹敮顔剧М妤犵偛鍟伴幉鎾礋椤掆偓椤庢捇鏌ｉ悩鍙夊巶闁告洦鍋掓导鎾绘⒒娴ｈ棄浜归柍宄扮墦瀹曟粌鈻庨幘宕囨煣闂佸啿鎼幊蹇涘煕閹达附鐓曢柨鏃囶嚙瀵箖鏌￠崱鈺佺仸闁哄矉绻濆畷銊╊敊閻愵剙鍨遍梻浣筋嚃閸ㄤ即鎮ч崱娑辨晣濠靛倻顭堥悙濠囨煏婵犲繘妾い鏂挎喘閺岋綁鎮㈤崫銉х厐闁诲孩绋堥弲鐘荤嵁閸儱惟闁宠桨绲艰椤法鎹勯悮瀛樻暰濡炪們鍎茬换鍫濐潖濞差亜绠归柣鎰絻婵姊洪崫鍕櫤缂侇喗鎹囬獮鍐┿偅閸愨晝鍔堕悗骞垮劚濡绂掗鐐╂斀闁绘劕寮堕ˉ鐐烘煟閻旀繂鎳愰惌娆忊攽閻樺磭顣查柣鎾跺枛楠炴牠骞栭鐐典画闁�?
//=====================================================================
void MCP2515_ReceiveData(void)
{
    uint8_t tempdata,i;
    uint8_t buf[13];
    u32 CAN_ID;
    u8 HSID,LSID,SIDLEID,HEID,LEID,DLC;
    u32 SID,EID;
    uint8_t CAN_RX_Buf[8];
    Frame_TypeDef Frame;

    tempdata=SPI_CMD_MCP2515(Mcp2515_SPI_RX_STATUS);//RX闂傚倸鍊搁崐鐑芥嚄閸撲礁鍨濇い鏍亹閳ь剨绠撳畷濂稿Ψ閵夛附袣闂備礁鎼粙渚�宕㈡禒瀣柧闁归棿鐒﹂悡娆撴倵濞戞顏嗙箔瑜旈弻娑㈠棘鐠恒剱褔鏌熼绛嬫疁鐎规洖缍婇、鏇㈠Χ鎼淬垺顔愮紓鍌氬�风粈渚�宕愰崷顓熸殰闁斥晛鍟╃换鍡涙煕椤愶絾绀�闁绘劕锕弻鏇熺箾瑜嶉幊蹇撔掑畝鍕拻闁稿本鐟︾粊鐗堛亜椤愩埄妲圭紒鍌氱У缁傛帞鈧綆浜為敍鐔兼⒑閸濆嫯顫﹂柛搴ㄤ憾瀵憡鎷呴悜妯烘瀾闂佺粯顨呴悧鍡欑箔閹烘梻纾奸柍褜鍓熷畷鍗炩槈濞嗘垵骞嶆繝鐢靛仜閻楀棝鎮樺┑瀣嚑闁绘柨鍚嬮悡鐔兼煥濠靛棭妲烽柟鏌ョ畺閺屸�崇暆閳ь剟宕伴弽顓熷亗妞ゆ帒瀚粻鐢告煙閻戞ê鐏ユい顐ｅ哺濮婄粯鎷呴崨濠冨創濡炪倖鍨甸幊妯虹暦椤栫偛绠绘い鏃囧亹閻ｉ箖姊洪崨濠傚Е闁哥姵鐗滅划鍫⑩偓锝庡亖娴滄粓鏌熼幑鎰【鐎涙繂顪冮妶蹇氬悅闁哄懐濮撮～蹇撁洪鍕獩婵犵數濮撮崐鎼侊綖瀹ュ鍋℃繝濠傚缁舵煡鏌涢悤浣镐喊闁糕斂鍨归鍏煎緞婵犲嫷鍞烘繝寰锋澘鈧劙宕戦幘瀛樹氦婵犻潧娲ㄧ粻楣冨级閸繂鈷旂紒澶樺枤缁辨捇宕掑☉妯烘懙闂佹寧绻勯崑銈夊极閸愵喖纾兼繛鎴炶壘楠炲牓姊绘笟鈧褔鈥﹂崼銉ョ？婵炲樊浜滅壕璺ㄢ偓骞垮劚椤︿即鎮￠妷鈺傜厽闁哄啫鍋嗛悞楣冩煟韫囨搫韬柡宀嬬秮楠炴帡鎮欓悽鍨婵°倗濮烽崑娑㈡煀閿濆棔绻嗛柛顐ｆ礀瀹告繃銇勮箛鎾村櫧濞存粍鐟╁缁樼瑹閳ь剙顭囪閹广垽骞掗幘鏉戝伎闂佹眹鍨归幉锟犲磻閻斿吋鐓�?
                                                    //闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢妶鍌氫壕婵ê宕崢瀵糕偓瑙勬礉椤鈧潧銈稿鍫曞箣閻樺磭鍔搁梻鍌欐祰椤鐣峰鈧、娆撳箛閺夎法顔嗛梺缁樺灱婵倝宕戦敓鐘崇厽婵°倐鍋撻柣妤�锕獮蹇涙焼瀹ュ棛鍘介柟鑹版彧缁辨洘绂掑☉姘辨／闁哄娉曡倴缂備緡鍠栭澶愮嵁閹烘嚦鏃堝焵椤掆偓濞插潡姊绘担鍛婂暈濞撴碍顨婂畷銏ゆ寠婢跺棙鐎洪梺鍛婂姦閸犳鎮￠悢鍏肩厽婵☆垰鎼痪褏绱掔仦鎯ь嚋闁靛洤瀚板鎾幢濡や焦鎮欑紓浣哄Х閸犳牠寮婚悢铏圭煓闁割煈鍣崝澶嬬箾鐎涙ê娈犻柛濠冪墬缁岃鲸绻濋崶鑸垫櫖濠电姴锕ら幊搴ｇ箔閿涘嫮纾兼俊銈勭閻忓瓨鎱ㄦ繝鍐┿仢鐎规洏鍔嶇换婵嬪磼濮樺吋缍岄梻鍌欐祰瀹曠敻宕伴崱娑樼９婵°倕鍟崹婵嬫煃閸濆嫬鏆婇柛瀣尭閳藉鈻庡Ο鐓庡Ш闂備礁纾划顖氼潖瑜版帒桅闁告洦鍠氶悿鈧梺瑙勫劤椤曨參濡堕埡鍛拺闁硅偐鍋涢埀顒佸灴瀹曠銇愰幒鎴犲弨婵犮垼鍩栭崝鏇犵不婵傚憡鐓曢柡鍥ュ妼婢ь喗銇勮箛姘【闁宠鍨块幃娆撳级閹寸姳妗撻梻浣烘嚀閻ㄧ兘寮插鍛焿鐎广儱妫Σ褰掑箹濞ｎ剙鐒烘繛鑲╁枛濮婅櫣鎹勯妸銉︾彚闂�?
    if(tempdata&0x40)//RXB0婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犲綊鏌嶉崫鍕櫣闁稿被鍔岄湁闁绘ê妯婇崕蹇涙煛鐎ｂ晞鍏岄柟鍙夋倐閹囧醇濠靛牏鎳嗙紓鍌欒閸嬫捇鏌涢埄鍐姇闁绘挾鍠愭穱濠囧Χ閸屾矮澹曢梻浣虹帛椤ㄥ懎螞濠婂牄鈧倿宕稿Δ浣叉嫽婵炶揪绲介幉锟犲箚閸儲鐓曞┑鐘插閻掗箖妫佹径鎰厱闁哄洢鍔岄獮妤併亜椤愶絾绀冪紒缁樼箞濡啫鈽夐崡鐐插闂備礁鎲￠崝蹇涘磻閹剧粯鈷掑ù锝堫潐閸嬬娀鏌涙惔銏㈢煉鐎规洏鍔戦、娑㈡晲閸涱喗鐝掓繝鐢靛Х閺佹悂宕戦悩璇茬妞ゅ繐妫楃欢銈夋煟閿濆懐鐏遍柣顓熸尵閳ь剝顫夊ú鏍洪敂閿亾濮橆剦鐓奸柡灞诲姂閹倝宕掑☉姗嗕紦1
    {
        HSID=MCP2515_ReadByte(Mcp2515_RXB0SIDH);//闂傚倸鍊搁崐鐑芥嚄閸洏鈧焦绻濋崶鑸垫櫓闂佸湱澧楀妯肩不椤栫偞鐓�?9婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ｉ敐鍛伇闁活厽鎹囬弻锝夊閻樺啿鏆堥梺绋款儏椤︾敻寮婚妸銉㈡斀闁糕剝锚椤︹晠鏌ｆ惔銏㈩暡鐎光偓閹间礁钃熸繛鎴欏灩閻掓椽鏌涢幇鍏哥凹闁革絼绮欏铏圭矙閸ф鈧鏌ㄩ弴銊ょ盎妞ゎ偄绻愮叅妞ゅ繐绉甸弲鈺冪磼缂併垹寮柡鈧潏鈹惧亾濮橆剛绉洪柡宀嬬秮瀵潙顫濇鏍ㄐ滄繝鐢靛仜閻楀﹤顪冮挊澶樻綎婵炲樊浜滃婵嗏攽閻樻彃鈧粯绂掓總鍛娾拺缂佸娉曢弰鍌炴煕婵犲啯绀嬮柍銉畵瀹曞爼顢楁担瑙勵仧闂�?
        LSID=MCP2515_ReadByte(Mcp2515_RXB0SIDL);//婵犵數濮烽弫鎼佸磻濞戙埄鏁嬫い鎾跺枑閸欏繘鏌℃径瀣劸婵炲皷鏅犻弻銊╁籍閸屾矮澹曢悗瑙勬礃閻擄繝寮婚垾鎰佸悑閹肩补鈧磭顔愰梻浣虹帛閸旀洟鏁冮妷褎宕叉繛鎴欏灩缁狅綁鏌ｉ幋婵囶棡闁汇倓绶氬娲箹閻愭祴鍋撻弴銏╂晞濠㈣埖鍔曠粻鏍ㄤ繆閵堝懏鍣烘い銉ョ墛缁绘盯骞嬮悜鍥︾返婵炲濮撮妶绋款潖閾忓厜鍋撻惂鎼佹婵犮垺蓱閹便劑宕掑┃鎯т壕閻熸瑥瀚粈鍐ㄢ攽閻愯鏀诲ǎ鍥э躬楠炴牗鎷呴崫銉ュ箰濠电偠鎻紞鈧い鏇熺墬缁傛帡鏁冮崒娑掓嫼闂佺厧顫曢崐鏇炵摥婵犵數鍋炲娆戔偓姘嵆閻涱喛绠涘☉娆愭?
        HEID=MCP2515_ReadByte(Mcp2515_RXB0EID8);
        LEID=MCP2515_ReadByte(Mcp2515_RXB0EID0);

        if(LSID |Mcp2515_EXIDE_SET)//闂傚倸鍊峰ù鍥х暦閸偅鍙忛柡澶嬪殮濞差亜围濠㈣泛顑呮禒閬嶆⒑闂堟侗鐒鹃柛搴㈢懇閺佹劖寰勬繝鍕靛悈闂備焦瀵уú宥夊磻閹剧粯鐓曟繛鍡楅獜閺�濠氭煏閸パ冾伃鐎殿喕绮欐俊姝岊槷婵℃彃鐗撳娲箮閼恒儲鏆犻梺缁橆殘婵炩偓妤犵偛鍟～婊堝焵椤掑嫬绠栨繛鍡樺灍閸嬫挸鈽夊▎妯煎姺濡炪倧璐熼崕闈涱潖閾忚鍏滈柛娑卞幘閸橆偊鎮楅崗澶婁壕闂佸綊妫跨粈渚�寮告担琛″亾楠炲灝鍔氶柟铏姍瀵娊宕卞☉娆戝幈闂佽婢橀崥鈧紒銊ㄥГ閵囧嫰寮埀顒勫礉閺嶎偅宕叉繛鎴欏灩缁狅綁鏌ｉ幇顒傛憼闁稿骸瀛╃换娑氣偓娑欘焽閻绱掗鑺ュ磳妤犵偛妫欓幏鍛喆閸曨偄濡抽梻浣瑰缁诲倻鎹㈤幋鐘亾濮樻剚娼愮紒缁樼洴楠炲鎮滈崱鏇犳／婵＄偑鍊曠换鎰偓姘�鍥у嚑鐎广儱顦伴悡娆撴煟閹寸儑渚涙繛鍫熸礋閺岋綁骞橀崘娴嬪亾閸ф绠栨慨妞诲亾闁诡喗鐟╁Λ鍐ㄢ槈濡も偓椤ユ氨绱撻崒娆掑厡濠殿喚鏁搁弫顕�骞掑Δ鈧悡鈥愁熆閼搁潧濮囩紒鐘层偢閺屾盯骞囩仦鑺ュ櫣闁搞値鍓欓埞鎴︽偐椤愶絽顎忛梺绯曞墲椤洭濡存繝鍐閻庣數顭堥鎾剁磼閻樿櫕灏い鏇秮楠炴﹢顢欓挊澶夌盎闂備礁鎲＄换鍌溾偓姘煎枟鐎靛ジ宕堕浣叉嫼闂佺厧顫曢崐鏇炵摥婵犵數鍋涢惇浼村磹閺囷紕浜辨繝鐢靛仦閸垶宕洪崟顖氭瀬闁告洦鍋侀埀顒佸笒椤繈鎮欓鈧鍫曟煟鎼淬埄鍟忛柛鐘虫礈閸掓帒鈻庤箛鏇熸闂佽鍨堕崑濠偽ｉ崜褏纾藉ù锝呮惈闉嬪┑鐐差槹閻╊垰锕㈡笟鈧娲箰鎼达絿鐣电紓浣虹帛閸ㄥ綊鍩�?
        {
            Frame.Type=EN_CAN_BUS_EXD;

            //闂傚倸鍊搁崐鐑芥嚄閸洏鈧焦绻濋崒妤佺亙濠电偞鍨崹娲疾濠靛鐓忓┑鐐戝啫顏╅幖鏉戯躬濮婃椽宕崟顓涙瀱闂佸憡锚閵堟悂骞冨▎鎰瘈闁告劦浜為鏇㈡⒑閻熼偊鍤熼柛搴㈠姇閳绘挸顭ㄩ崼鐔哄幈闂侀潧鐗嗛幏瀣磿閺冨牊鐓欐い鏃傜摂濞堟粍淇婇銏犳殭闁宠棄顦～婊堝幢閺囩喎浜濋梻鍌氬�风粈渚�顢樻禒瀣骇闁割煈鍣搴ㄦ煟鎼淬値娼愭繛鍙壣戠换娑欑節閸愌呯畾闂佸綊妫跨粈渚�鎮″☉妯忓綊鏁愰崼顐㈡異婵炲濯寸粻鎾愁潖缂佹ɑ濯撮柛锔诲幗閼垮洭姊洪崨濠冪叆闁活剙銈搁崺鈧い鎺嶇閸ゎ剟鏌涘▎蹇撴殭妞ゆ洩缍侀獮搴ㄦ嚍閵夈儰绨婚梻浣虹帛閹哥霉閻戠瓔鏁婂璺侯煬濞撳鏌曢崼婵囶棡闁抽攱甯￠弻宥呯暋閹殿喖顣洪柛妤呬憾濮婃椽顢楅埀顒傜矓閻㈠憡鍋傞柣鏂垮悑閻撶喖鏌熼柇锕�澧紒鐙欏嫨浜滈柕澶涘閹冲懐绱掓潏銊ユ诞鐎殿噮鍓涢幑鍕Ω閿旇棄鏋涚紓鍌氬�风粈渚�顢栭崨姝ゅ洭鏌嗗鍡樻闂佸搫鍊堕崐妤呭礆閺夋鐔嗙憸宥吤规搴″灊闁割偆鍠庣欢鐐碘偓鍏夊亾闁逞屽墰婢规洟鎮℃惔顔惧數闁荤姴鎼幖顐︽儊閵娾晜鐓曢柣鎰摠閵囨繃鎱ㄦ繝鍐┿仢鐎规洩绲惧鍕暆閳ь剟鎮℃笟鈧娲偡閺夋寧些闂佺懓鍟块柊锝夈�佸鈧幊婵嬪箥椤旂偓婢戦梻浣告惈濞层劍鍒婇鐐嶏綁鎮滈懞銉у幗闁硅壈鎻徊楣冨汲閳轰緡鐔嗙憸搴ㄣ�冩繝鍥ラ柛鎰靛枛瀹告繈鏌℃径瀣仸婵″樊鍓熼弻锝堢疀閺囩偘鎴烽梺鐑╁墲閺屻劑鈥﹂崶銊ヮ嚤閻庢稒顭囬崣鍡椻攽閻樼粯娑ф俊顐ｇ懅缁牆鐣濋崟顒傚弳闂佺粯妫侀褑顣块梻浣瑰濞插繘宕规禒瀣祦闁糕剝绋戠粈鍐┿亜閺冨洤袚婵炲懌鍨藉铏规崉閵娿儲鐝㈤梺?9婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ら幁鎺戝姢闁崇粯姊婚埀顒�鍘滈崑?
            SID=(LSID>>5);//SID2:0缂傚倸鍊搁崐鎼佸磹妞嬪海鐭嗗〒姘ｅ亾閽樻繈鏌℃径搴殾闁挎繂顦粻铏繆閵堝倸浜鹃梺鍛婅壘缂嶅﹪寮婚妸鈺佸嵆闁绘劖绁撮崑鎾诲传閵夈垹浜炬慨姗嗗墻濡偓闂佸搫琚崝鎴﹀箖閵忋倕绀堝ù锝堟閸橆垶鏌ｆ惔銈庢綈婵炴祴鏅濈槐鐐寸瑹閳ь剙顕ｉ锕�绠荤紓浣股戝▍銏ゆ⒑?
            SID|=(HSID<<3);//SID10:3闂傚倷娴囬褎顨ラ崫銉х濠电姴鍋嗛悞鐣岀磽娴ｅ鑲╂崲閸℃稒鐓曢柕澶樺灠椤╊剟鏌￠崟顐⑩偓鎼佸煘閹达附鍊烽柡澶嬪灩娴犳悂姊洪悷鐗堝暈闁诡喖鍊藉Λ鐔奉渻閵堝棙鐓ュ褏鏅划鍫熺節閸ャ劎鍘卞┑鐐村灥瀹曨剟寮搁妶澶嬬厓缂備焦蓱閳锋帡鏌嶈閸撴瑧绮诲澶婄？闁硅泛顫曢埀顒�鍊荤划?2:0闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐叉疄婵°倧绲介崯顖炲磻鐎ｎ喗鐓曢柍鈺佸暟閳洟鏌涢妶鍡楀闁哄被鍔戦幃銈夊磼濞戞﹩浼�
            SIDLEID=LSID & 0x03;
            EID=LEID;//EID婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁�濠囨煕閵夘喖澧紒鐙�鍨堕弻?婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁�濠囨煕閵夘喖澧紒鐙�鍨堕弻?
            EID|=(HEID<<8);//婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犱即鏌涘☉妯忊�澄旈埀顒勵敇婵傚憡鍋戦柨婵嗘噳閺�浠嬪箳閹惰棄纾归柡鍥ュ灩绾捐鈹戦悩鍙夋悙缂佺媭鍨堕弻?婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ｉ敐鍛伇闁活厽鎹囬弻鐔虹磼閵忕姵鐏堢紓浣哄У閻楃娀鐛弽顬ュ酣顢楅埀顒佷繆鐠恒劉鍋撶憴鍕矮缂佽埖宀稿濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?
            EID|=(SIDLEID<<16);//婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犱即鏌涘☉妯忊�澄旈埀顒勵敇婵傚憡鍋�?7:16婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ｉ敐鍛伇闁活厽鎹囬弻鐔虹磼閵忕姵鐏堢紓浣哄У閻楃娀鐛弽顬ュ酣顢楅埀顒佷繆鐠恒劉鍋撶憴鍕矮缂佽埖宀稿濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?

            CAN_ID=EID|(SID<<18);//闂傚倷娴囬褍霉閻戣棄鏋侀柛娑橈攻濞呯姵淇婇妶鍛櫡闁逞屽墮閸熸潙鐣烽妸鈺佺骇闁瑰鍋炶ⅲ闂佽楠搁崢婊堝磻閹剧粯鐓曢柡鍥ュ妼娴滄粓鏌ｅ┑鍥疯�挎慨濠呮閹瑰嫰濡搁妷锔锯偓铏圭磽娓氬洤鏋熼柣鐔村劦閹箖鎮滈挊澹┿劑鏌曟径妯烘灈闁诡喗鍨垮铏圭磼濡吋鍤傞梺?

        }
        else//闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢妶鍥╃厠闂佸搫顦伴崵姘洪鍕幯冾熆鐠虹尨韬俊顐㈠槻椤啴濡堕崱娆忣潷缂備緡鍠栫粔鐟邦嚕閸愬樊鐓ラ柛娑卞枛閺嬫垵鈹戦悩缁樻锭闁绘锕敐鐐哄即閻旇櫣鐦堥梻鍌氱墛娓氭宕曡箛鏇犵＜闁逞屽墴瀹曟帡鎮欑�电骞堟俊鐐�栭崝褏寰婇崸妤佸剹鐎光偓閸曨剛鍘介梺缁樻煥閹芥粎绮诲Ο鑲╃＜閺夊牄鍔屽ù顕�鏌熼鍛偗鐎规洏鍔戦、娆戝枈閸欐澶�
        {
        }
        Frame.ID=CAN_ID;//闂傚倸鍊搁崐鐑芥嚄閸撲椒鐒婇柕濞炬櫅缁狀垶鏌ｉ幋锝呅撻柛瀣剁秮閺屾稑鈹戦崱妤婁痪闂佽鍨伴悧鎾诲蓟閿濆绠婚柛鎰ゴ閸嬫捇宕稿Δ鈧拑鐔兼煥濠靛棭妲搁幆鐔兼⒑闂堟侗妲堕柛搴㈢叀椤㈡瑩宕撴担铏圭＝闁稿本鑹鹃埀顒佹倐瀹曟劙鎮滈懞銉モ偓鍧楁煥閺囩偛鈧綊宕戦敍鍕枑闊洦绋戠粈鍡涙煙閻戞﹩娈旈幆鐔兼⒑鐎圭姵銆冪紒鈧笟鈧畷鐢稿箣閿旇В鎷洪梺鍛婄☉閿曘儲寰勯崟顐�鐟邦煥閸涱厺鎴风紓渚囧枟濡啴寮�?
        DLC=MCP2515_ReadByte(Mcp2515_RXB0DLC);//闂傚倸鍊峰ù鍥х暦閸偅鍙忛柡澶嬪殮濞差亜鐓涢柛婊�鐒﹂弲鈺傜節閻㈤潧孝閻庢凹鍣ｅ畷鈥愁潩閼搁潧鈧灚绻涢幋鐐垫噽闁绘帊绮欓弻宥囩磼濡椿妫冮梺璇″枟椤ㄥ﹪寮幇顓熷劅闁炽儴灏欓崙鍦磽閸屾瑨鍏屽┑顔炬暩閺侇噣鏁撻悩鑼舵憰濠电偞鍨崹鍦不閿濆鐓熸俊顖濆吹閺嗘瑩鏌ㄩ悢鍝勑ｉ柍閿嬪灴閺屾稑鈻庤箛锝喰ㄩ梺娲诲幗鐢偤鍩�椤掍緡鍟忛柛锝庡櫍瀹曟垶绻濋崶褏鐣洪悷婊勬煥閻ｇ兘鎮℃惔妯绘杸闂佸壊鍋呯粙鎴炵娴煎瓨鈷掗柛灞剧懅閸斿秹鎮楃粭娑樻噽閻瑩鏌熸潏楣冩闁搞倖鍔栭妵鍕冀椤愵澀绮堕梻鍌氬亞閸ㄩ亶濡甸崟顖氬唨闁靛ě鈧Σ鍫㈢磽娴ｇ顣抽柛瀣ㄥ�濆璇测槈閵忕姈銊╂煙鐎涙绠栨繝鈧幍顔藉仏闁冲搫鎳忛埛鎺懨归敐鍫燁棄闁告艾缍婇弻娑氣偓锝庡亞閳藉鎽堕悙缈犵箚闁靛牆鎳忛崳鍦磼閻樺磭澧甸柡灞诲姂閹倝宕掑☉姗嗕紦8闂傚倸鍊峰ù鍥敋瑜忛埀顒佺▓閺呮繄鍒掑▎鎾崇婵＄偛鐨烽崑鎾诲礃閳轰胶绐為柣搴岛閺呮繄绮诲顒夋富闁靛牆妫欑亸顏堟煕閵娿儳绉虹�殿喖鎲＄粭鐔煎焵椤掑嫬钃熼柨婵嗘啒閺冨牆鐒垫い鎺戝閸嬪鏌涢埄鍐噮闁活厼鐗撻弻?
        DLC=(DLC & 0x0F);
        if(DLC!=8)
        {
            DLC=MCP2515_ReadByte(Mcp2515_RXB0DLC);
            Djy_EventDelay(10*mS);
//          Mcp2515_gs_u64RcvPkgBadCnt++;
            MCP2515_BitModify(Mcp2515_CANINTF,Mcp2515_RX0IF_SET,0x00);
            return;
        }
        Frame.DLC=DLC;
        for(tempdata=0;tempdata<DLC;tempdata++)//闂傚倸鍊搁崐鐑芥嚄閸洏鈧焦绻濋崒妤佺亙濠电偞鍨崹娲疾濠靛鐓忓璺烘濞呭懏鎱ㄧ憴鍕弨闁哄矉缍佸顕�宕掑顑跨帛缂傚倷鑳舵慨鏉戭嚕閸洖桅闁告洦鍨扮猾宥夋煕閵夋垵鍟崕顏嗙磽閸屾瑨鍏屽┑顔肩－閸掓帒鈻庨幘宕囩暫濠德板�愰崑鎾绘煃閽樺妲搁柍璇查铻ｉ柣鎾抽姝囬梻鍌氬�烽悞锕傚箖閸洖纾圭憸搴㈢┍婵犲洤鐐婇柍鍝勫亞濞肩喖姊虹憴鍕妞ゆ泦鍛笉濠电姵纰嶉悡鏇㈡煙闁箑澧紒鐙欏嫭鍙忛柨婵嗘婵秵鎱ㄦ繝鍐┿仢鐎规洏鍔嶇换婵嬪礋椤愵偅顥夐梻鍌欒兌閹虫捇宕甸弽顓炵?
        {
            CAN_RX_Buf[tempdata]=MCP2515_ReadByte(Mcp2515_RXB0D0+tempdata);
        }
        MCP2515_BitModify(Mcp2515_CANINTF,Mcp2515_RX0IF_SET,0x00);//婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犺銇勯幇鍓佺暠缂佺媭鍨堕弻锝夊箣閿濆憛鎾绘煟閹惧娲撮柡灞剧洴楠炲洭顢楅崒娆掓婵＄偑鍊愰弲鈺呭礈濞戞碍顫曢柟鐑橆殔缁犵喖鎮楅敐搴″闁哄棎鍊濋幃妤冩喆閸曨剛顦ㄩ梺鎸庢磸閸ㄤ粙鎮伴鈧獮妯兼嫚閼碱剦鍞洪梻浣筋潐瀹曟ê鈻斿☉姘辩闁哄倸绨遍弨浠嬫煟閹邦厽缍戦柣蹇ョ畵閺岀喓浜搁弽銊︾彋閻庤娲忛崹浠嬬嵁閸℃凹妲烽梺鍝勵儐濡啴寮婚悢鍛婄秶闁告挆鍛缂傚倷鑳舵刊顓㈠闯閿濆钃熼柡鍥╁枎缁剁偞绻涢幋娆忕仾妞ゅ骸绉瑰铏规嫚閹绘帞妲伴梺鍝ュУ閻楃娀鍨鹃敂鐐磯闁靛绠戠壕顖炴⒑閸涘﹦绠撻悗姘舵敱鐎靛ジ鍩�椤掑嫭鈷掑ù锝囩摂閸ゅ啴鏌涢悩宕囧⒌闁轰礁鍟撮弫鍐磼濞戞瑦顏熼梻浣风串缁蹭粙寮甸鍕惞闁逞屽墴濮婃椽宕崟顓炩拡闂佸憡鎸鹃崰鏍嵁閸℃鐟归柍褜鍓熼妴浣糕槈閵忊�斥偓鐑芥倵濞戞鎴︽偟椤愶附鈷戦悹鍥皺缁犳娊鏌涚�ｎ剙鏋涚�殿喗鐓￠、鏇㈠Χ閸ワ妇鐟濋梻浣烘嚀閻°劎鎹㈠鍛偓鎺撶節濮橆厾鍘梺鍓插亝缁诲嫭鏅堕柆宥嗙厱闁靛牆妫涢幊鍥煛瀹�瀣М濠碘剝鎮傞弫鎰板川椤栨瑧纾块梻鍌欑缂嶅﹪藟閹惧绠鹃柍褜鍓欓埞鎴︽晬閸曨偄骞嬫繝纰樷偓宕囧煟鐎规洖鐖奸崺鐐侯敄閹呬患闂佸疇顫夐崹鍧楀箖濞嗘垟鍋撳☉娅亞鍠婂澶嬧拺缁绢厼鎳忛悵顏堟煥濮樿埖顥嗗鑸靛姈閻撴洟鎮橀悙鎻掆挃闁靛棙甯楅妵鍕煛閸愩劌骞嬮梺鍝勬湰濞叉ê顕ラ崟顐熸婵椴稿▓绋库攽閻橆喖鐏辨繛澶嬬〒缁棁銇愰幒鎴ｆ憰闂佽法鍠撴慨鐢稿疾缁嬫５褰掓偐瀹割喖鍓伴柣搴㈣壘椤︾敻寮婚敐澶婎潊闁靛繆鍓濆В鍕⒑閻熺増鈻曢柛鐘愁殘閹广垹鈽夐姀鐘殿吅闂佺粯鍔曢悺銊╁磿閹剧粯鈷戠憸鐗堝俯濡垿鏌涜箛鏃撹�跨�殿喖顭烽崺鍕礃閵娧呯嵁闂備胶纭堕崜婵嬨�冮崨鏉戠厱濠㈣泛顑囩弧鈧┑鐐茬墕閻忔繈寮搁弮鍫熺厱濠电姴鍟扮粻鎾淬亜閺囶亞绉い銏☆殜瀹曠喖顢楁担璇′户闂傚倷娴囧▔鏇㈠闯閿曞倸绠�?

        MCP2515_Read(CAN_RX_Buf,&Frame);
    }
//=============================================================================
    //婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犺銇勯幇鍓佺暠缂佺媭鍨堕弻锝夊箣閿濆憛鎾绘煟閹捐泛鈻堥柡灞剧☉閳规垿宕熼銏狀潥闂備胶顭堥敃锕傛儓閺�?闂傚倸鍊峰ù鍥敋瑜忛幑銏ゅ箛椤旇棄搴婂┑掳鍊曢崯顐﹀垂濠靛柈鏃堟晲閸涱厽娈紓浣插亾闁稿本绋掗崣蹇斾繆閵堝拋鍎愰悗姘秺濮婅櫣娑甸崨顔惧涧濡炪們鍔岄幊姗�鍨鹃敃鍌毼╅柍鍝勫�瑰▍銏＄箾鐎电孝妞ゆ垵鎳愮划濠氬蓟閵夛妇鍘棅顐㈡搐椤戝懘鍩�椤掍胶澧电�殿喗鐓￠、妤呭礋椤掆偓閳ь剙鐖奸弻锝夊箛椤栨稓銆愭繛瀛樼矊缂嶅﹪寮婚敐澶嬪亜闁告縿鍎抽悾鐢告⒒閸パ屾█闁哄本绋栫粻娑㈠箻閾忣偄鈧垶姊哄Ч鍥у闁搞劌娼″濠氬焺閸愨晛顎撻梻鍌氱墛缁嬪牓宕戦幘鏂ユ斀闁糕剝鐟﹀▓鎯р攽椤旂瓔鐒鹃柛鈺傜墵瀵煡骞栨担鍦弳闂佺粯娲栭崐鍦偓?
//=============================================================================
    if(tempdata&0x80)//RXB1婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犲綊鏌嶉崫鍕櫣闁稿被鍔岄湁闁绘ê妯婇崕蹇涙煛鐎ｂ晞鍏岄柟鍙夋倐閹囧醇濠靛牏鎳嗙紓鍌欒閸嬫捇鏌涢埄鍐姇闁绘挾鍠愭穱濠囧Χ閸屾矮澹曢梻浣虹帛椤ㄥ懎螞濠婂牄鈧倿宕稿Δ浣叉嫽婵炶揪绲介幉锟犲箚閸儲鐓曢悗锝庝悍闊剚顨ラ悙鑼闁�?
    {
        HSID=MCP2515_ReadByte(Mcp2515_RXB1SIDH);
        LSID=MCP2515_ReadByte(Mcp2515_RXB1SIDL);
        HEID=MCP2515_ReadByte(Mcp2515_RXB1EID8);
        LEID=MCP2515_ReadByte(Mcp2515_RXB1EID0);

        if(LSID |Mcp2515_EXIDE_SET)//闂傚倸鍊搁崐椋庣矆娴ｉ潻鑰块梺顒�绉查埀顒�鍊圭粋鎺斺偓锝庝簽閺屟冣攽閻愭潙鐏熼柛銊︽そ瀹曟洟骞橀崹娑樹壕妤犵偛鐏濋崝姘箾鐠囇呯暤鐎殿喖鍟块…銊╁醇閻斿搫寮抽梻浣虹帛濞叉牠宕愰崷顓涘亾?
        {
            Frame.Type=EN_CAN_BUS_EXD;

            SID=LSID>>5;//SID2:0缂傚倸鍊搁崐鎼佸磹妞嬪海鐭嗗〒姘ｅ亾閽樻繈鏌℃径搴殾闁挎繂顦粻铏繆閵堝倸浜鹃梺鍛婅壘缂嶅﹪寮婚妸鈺佸嵆闁绘劖绁撮崑鎾诲传閵夈垹浜炬慨姗嗗墻濡偓闂佸搫琚崝鎴﹀箖閵忋倕绀堝ù锝堟閸橆垶鏌ｆ惔銈庢綈婵炴祴鏅濈槐鐐寸瑹閳ь剙顕ｉ锕�绠荤紓浣股戝▍銏ゆ⒑?
            SID|=HSID<<3;//SID10:3闂傚倷娴囬褎顨ラ崫銉х濠电姴鍋嗛悞鐣岀磽娴ｅ鑲╂崲閸℃稒鐓曢柕澶樺灠椤╊剟鏌￠崟顐⑩偓鎼佸煘閹达附鍊烽柡澶嬪灩娴犳悂姊洪悷鐗堝暈闁诡喖鍊藉Λ鐔奉渻閵堝棙鐓ュ褏鏅划鍫熺節閸ャ劎鍘卞┑鐐村灥瀹曨剟寮搁妶澶嬬厓缂備焦蓱閳锋帡鏌嶈閸撴瑧绮诲澶婄？闁硅泛顫曢埀顒�鍊荤划?2:0闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐叉疄婵°倧绲介崯顖炲磻鐎ｎ喗鐓曢柍鈺佸暟閳洟鏌涢妶鍡楀闁哄被鍔戦幃銈夊磼濞戞﹩浼�

            SIDLEID=LSID & 0x03;
            EID=LEID;//EID婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁�濠囨煕閵夘喖澧紒鐙�鍨堕弻?婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁�濠囨煕閵夘喖澧紒鐙�鍨堕弻?
            EID|=(HEID<<8);//婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犱即鏌涘☉妯忊�澄旈埀顒勵敇婵傚憡鍋戦柨婵嗘噳閺�浠嬪箳閹惰棄纾归柡鍥ュ灩绾捐鈹戦悩鍙夋悙缂佺媭鍨堕弻?婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ｉ敐鍛伇闁活厽鎹囬弻鐔虹磼閵忕姵鐏堢紓浣哄У閻楃娀鐛弽顬ュ酣顢楅埀顒佷繆鐠恒劉鍋撶憴鍕矮缂佽埖宀稿濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?
            EID|=(SIDLEID<<16);//婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犱即鏌涘☉妯忊�澄旈埀顒勵敇婵傚憡鍋�?7:16婵犵數濮烽弫鎼佸磻閻樿绠垫い蹇撴缁躲倝鏌ｉ敐鍛伇闁活厽鎹囬弻鐔虹磼閵忕姵鐏堢紓浣哄У閻楃娀鐛弽顬ュ酣顢楅埀顒佷繆鐠恒劉鍋撶憴鍕矮缂佽埖宀稿濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?

            CAN_ID=EID|(SID<<18);//闂傚倷娴囬褍霉閻戣棄鏋侀柛娑橈攻濞呯姵淇婇妶鍛櫡闁逞屽墮閸熸潙鐣烽妸鈺佺骇闁瑰鍋炶ⅲ闂佽楠搁崢婊堝磻閹剧粯鐓曢柡鍥ュ妼娴滄粓鏌ｅ┑鍥疯�挎慨濠呮閹瑰嫰濡搁妷锔锯偓铏圭磽娓氬洤鏋熼柣鐔村劦閹箖鎮滈挊澹┿劑鏌曟径妯烘灈闁诡喗鍨垮铏圭磼濡吋鍤傞梺?

        }
        else//闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢妶鍥╃厠闂佸搫顦伴崵姘洪鍕幯冾熆鐠虹尨韬俊顐㈠槻椤啴濡堕崱娆忣潷缂備緡鍠栫粔鐟邦嚕閸愬樊鐓ラ柛娑卞枛閺嬫垵鈹戦悩缁樻锭闁绘锕敐鐐哄即閻旇櫣鐦堥梻鍌氱墛娓氭宕曡箛鏇犵＜闁逞屽墴瀹曟帡鎮欑�电骞堟俊鐐�栭崝褏寰婇崸妤佸剹鐎光偓閸曨剛鍘介梺缁樻煥閹芥粎绮诲Ο鑲╃＜閺夊牄鍔屽ù顕�鏌熼鍛偗鐎规洏鍔戦、娆戝枈閸欐澶�
        {
        }


        Frame.ID=CAN_ID;//闂傚倸鍊搁崐鐑芥嚄閸撲椒鐒婇柕濞炬櫅缁狀垶鏌ｉ幋锝呅撻柛瀣剁秮閺屾稑鈹戦崱妤婁痪闂佽鍨伴悧鎾诲蓟閿濆绠婚柛鎰ゴ閸嬫捇宕稿Δ鈧拑鐔兼煥濠靛棭妲搁幆鐔兼⒑闂堟侗妲堕柛搴㈢叀椤㈡瑩宕撴担铏圭＝闁稿本鑹鹃埀顒佹倐瀹曟劙鎮滈懞銉モ偓鍧楁煥閺囩偛鈧綊宕戦敍鍕枑闊洦绋戠粈鍡涙煙閻戞﹩娈旈幆鐔兼⒑鐎圭姵銆冪紒鈧笟鈧畷鐢稿箣閿旇В鎷洪梺鍛婄☉閿曘儲寰勯崟顐�鐟邦煥閸涱厺鎴风紓渚囧枟濡啴寮�?
        Djy_EventDelay(1*mS);
        DLC=MCP2515_ReadByte(Mcp2515_RXB1DLC);
        DLC=(DLC & 0x0F);
        if(DLC!=8)
        {
            Djy_EventDelay(10*mS);
//          Mcp2515_gs_u64RcvPkgBadCnt++;
            MCP2515_BitModify(Mcp2515_CANINTF,Mcp2515_RX0IF_SET,0x00);
            return;
        }
        Frame.DLC=DLC;
        for(tempdata=0;tempdata<DLC;tempdata++)
        {
            CAN_RX_Buf[tempdata]=MCP2515_ReadByte(Mcp2515_RXB1D0+tempdata);
        }
        MCP2515_BitModify(Mcp2515_CANINTF,Mcp2515_RX1IF,0x00);//婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犺銇勯幇鍓佺暠缂佺媭鍨堕弻锝夊箣閿濆憛鎾绘煟閹惧娲撮柡灞剧洴楠炲洭顢楅崒娆掓婵＄偑鍊愰弲鈺呭礈濞戞碍顫曢柟鐑橆殔缁犵喖鎮楅敐搴″闁哄棎鍊濋幃妤冩喆閸曨剛顦ㄩ梺鎸庢磸閸ㄤ粙鎮伴鈧獮妯兼嫚閼碱剦鍞洪梻浣筋潐瀹曟ê鈻斿☉姘辩闁哄倸绨遍弨浠嬫煟閹邦厽缍戦柣蹇ョ畵閺岀喓浜搁弽銊︾彋閻庤娲忛崹浠嬬嵁閸℃凹妲烽梺鍝勵儐濡啴寮婚悢鍛婄秶闁告挆鍛缂傚倷鑳舵刊顓㈠闯閿濆钃熼柡鍥╁枎缁剁偞绻涢幋娆忕仾妞ゅ骸绉瑰铏规嫚閹绘帞妲伴梺鍝ュУ閻楃娀鍨鹃敂鐐磯闁靛绠戠壕顖炴⒑閸涘﹦绠撻悗姘舵敱鐎靛ジ鍩�椤掑嫭鈷掑ù锝囩摂閸ゅ啴鏌涢悩宕囧⒌闁轰礁鍟撮弫鍐磼濞戞瑦顏熼梻浣风串缁蹭粙寮甸鍕惞闁逞屽墴濮婃椽宕崟顓炩拡闂佸憡鎸鹃崰鏍嵁閸℃鐟归柍褜鍓熼妴浣糕槈閵忊�斥偓鐑芥倵濞戞鎴︽偟椤愶附鈷戦悹鍥皺缁犳娊鏌涚�ｎ剙鏋涚�殿喗鐓￠、鏇㈠Χ閸ワ妇鐟濋梻浣烘嚀閻°劎鎹㈠鍛偓鎺撶節濮橆厾鍘梺鍓插亝缁诲嫭鏅堕柆宥嗙厱闁靛牆妫涢幊鍥煛瀹�瀣М濠碘剝鎮傞弫鎰板川椤栨瑧纾块梻鍌欑缂嶅﹪藟閹惧绠鹃柍褜鍓欓埞鎴︽晬閸曨偄骞嬫繝纰樷偓宕囧煟鐎规洖鐖奸崺鐐侯敄閹呬患闂佸疇顫夐崹鍧楀箖濞嗘垟鍋撳☉娅亞鍠婂澶嬧拺缁绢厼鎳忛悵顏堟煥濮樿埖顥嗗鑸靛姈閻撴洟鎮橀悙鎻掆挃闁靛棙甯楅妵鍕煛閸愩劌骞嬮梺鍝勬湰濞叉ê顕ラ崟顐熸婵椴稿▓绋库攽閻橆喖鐏辨繛澶嬬〒缁棁銇愰幒鎴ｆ憰闂佽法鍠撴慨鐢稿疾缁嬫５褰掓偐瀹割喖鍓伴柣搴㈣壘椤︾敻寮婚敐澶婎潊闁靛繆鍓濆В鍕⒑閻熺増鈻曢柛鐘愁殘閹广垹鈽夐姀鐘殿吅闂佺粯鍔曢悺銊╁磿閹剧粯鈷戠憸鐗堝俯濡垿鏌涜箛鏃撹�跨�殿喖顭烽崺鍕礃閵娧呯嵁闂備胶纭堕崜婵嬨�冮崨鏉戠厱濠㈣泛顑囩弧鈧┑鐐茬墕閻忔繈寮搁弮鍫熺厱濠电姴鍟扮粻鎾淬亜閺囶亞绉い銏☆殜瀹曠喖顢楁担璇′户闂傚倷娴囧▔鏇㈠闯閿曞倸绠�?

        MCP2515_Read(CAN_RX_Buf,&Frame);
    }
}

//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯诲弿濠电姴鍟板畷鎶ｉ梻鍌氬�风粈浣革耿闁秴鍌ㄧ憸鏃堝箖濞差亜惟闁靛鍠栧▓銊х磽娴ｇ懓濮夋い鎴炪偟闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闁哄鐗冮弲娑氭閵堝悿褰掓偐閼碱剚鍣ラ梺鎼炲劘閸斿海寮ч埀顒�鈹戦鏂や緵闁告﹢绠栧畷婵嬪箹娴ｅ厜鎷洪梻鍌氱墛娓氭鎮炴ィ鍐╃厱濠电姴鍟板ú瀵糕偓瑙勬磸閸ㄤ粙銆佸Δ鍛妞ゆ帒鍊搁獮鎰版⒒娴ｄ警鐒鹃悶姘煎亰瀹曟劙寮撮姀銏犵ウ闂佸搫绉查崝搴ｇ不妤ｅ啯鐓曟繛鍡楁禋濡插搫顭胯娴滃爼寮婚悢鍝ラ檮濠㈣泛锕ｉ崰濠囨倵鐟欏嫭绀冮柨鏇樺灪娣囧﹪骞栨担鑲濄劑鏌ㄩ弮鍌氫壕鐞氱娀姊婚崒姘偓宄懊归崶褜娴栭柕濞у嫷鍋ㄩ梺闈涚墕椤︻垳绮婚鐐寸叆?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挾鍠栧濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愭祴鏀介悗锝呯仛閺呮繈姊洪棃娑辨Ф闁稿氦浜划濠氬箣閿旇В鎷绘繛杈剧到閹诧繝骞嗛崼銉︾厱閻庯綆浜濋ˉ銏⑩偓瑙勬穿缂嶄線寮幘瀵割浄閻庯綆鍋嗛崢浠嬫⒑闂堟丹娑㈠礃閳哄啩閭梻鍌欐祰椤曟牠宕伴弴鐘插灊婵炲棙鎸搁弰銉╂煕閺囥劌鐏犻梺鍗炴川缁辨帡宕崟顑芥瀳GPIO_EXTI_IRQHandler闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐叉疄婵°倧绲介崯顐ょ矆閸曨垱鐓熼柨婵嗘噺濠�鐗堛亜椤愶絾绀冪紒缁樼箞濡啫鈽夊▎妯活棖闂備浇娉曢崰鏇熸叏閵堝洦鏆滈柍銉ョ－閺嗭箓鏌曟繛鐐珦闁轰礁锕弻鐔碱敍閸℃鍣哥紒杈耿濮婂宕掑鑲╁彆闂佺顑呯�氼剛鍙呴梺鎸庢礀閸婂憡顢婇梻浣虹帛閸旀寮崫銉х焼濠电姴娲﹂悡鏇熺箾閹寸儐鐒介柟鐣屽█閺岋繝宕担绋款潾闂侀�炲苯澧版繛鍛灲楠炲繘鎮滈懞銉у弳闂佺粯鏌ㄦ晶搴ㄦ儗濞嗘垟鍋撶憴鍕缂佽妫濊棟闁革富鍘搁崑鎾舵喆閸曨剛锛橀梺绋垮閻擄繝鐛崱娑樼睄闁割偅鎯婅閺屾盯濡烽鎯у弗闂佸摜鍟块崑鎾绘⒒閸屾艾鈧兘鎳楅崼鏇炵？闁汇垻顭堢壕濠氭煙閹规劦鍤欑紒鈧径灞稿亾楠炲灝鍔氶柟閿嬪灴閹虫捇宕归姘秺瀹曟宕楅懖鈺冣枏闂備胶绮崝鏇㈡晝椤忓牆钃熼柨婵嗩槸缁犳稒銇勯幒鍡椾壕濡炪倧缍�濞呮洜鎹㈠☉銏犻唶婵犻潧鐗嗛悡鐔兼⒑閸濆嫭婀伴柣鈺婂灦閻涱喚鈧綆鍠楅弲鏌ユ煕濞戞ɑ鍣洪柟鐟版喘瀵鏁撻悩鎻掕�垮銈嗘尵閸犲酣顢�?
//     闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敂钘変罕濠电姴锕ら悧鍡欑矆閸喓绠鹃柛鈩兩戠亸顓㈡煕濮橆剛绉烘慨濠冩そ椤㈡鍩�椤掑倻鐭撻柟缁㈠枛閸戠姴銆掑锝呬壕闂佸搫鐬奸崰搴ㄦ偩閿熺姴绠ユい鏂垮綖缁辨ɑ绻濋悽闈涗粶闁绘妫濋幃銉︾附缁嬭儻鎽曢梺鎸庣箓椤︻垶鎮￠幋锔界厓闁告繂瀚烽崕鎰版倵濮橆剛绉洪柡宀�鍠撻幏瀣暦閸パ傜玻2_Handle闂傚倸鍊峰ù鍥敋瑜庨〃銉х矙閸柭も偓鍧楁⒑椤掆偓缁夊澹曟繝姘厽闁哄啫娲ゆ禍鍦偓瑙勬尫缁舵岸寮诲☉銏℃櫜闁告侗鍠氱粔绉�2515闂傚倸鍊搁崐宄懊归崶顒婄稏濠㈣泛顑囬々鎻捗归悩宸剰缁炬儳娼￠弻锛勪沪鐠囨彃濮庨梺鍝勵儎閼冲爼骞夐幖浣瑰亱闁割偅绻勯悷銊х磽娴ｅ搫顎岄柛锝忕秮瀵寮撮悢椋庣獮濠电偞鍨崹娲敁瀹ュ鈷戦悹鍥ㄥ絻閻︺劑鏌涢悩鎰佹畼闁瑰箍鍨归埥澶愬閻樼敻鐛撻梻浣筋潐閹矂宕㈡總绋跨闁汇垹鎲￠埛鎴澝归崗鑲╂噯妞ゆ挻妞介弻?
//=====================================================================
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
    u8 flag,eflg,tec,rec;
    u8 dummy=0;
    u32 DR=0;


    switch(GPIO_Pin)
    {
      case GPIO_PIN_3:
          Int_CutLine(MCP2515_EXIT_INT_LINE);           //闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敃鈧壕濠氭煕閳╁啰鈽夐柛灞诲姂閺屻倕霉鐎ｎ偅鐝曞銈庡亝濞茬喖寮婚悢琛″亾閻㈡鐒惧ù鐘欏洦鐓冪紓浣股戦埛鎰版煏閸パ冾伃妤犵偞顭囬幑鍕倻濡皷鍋撴ィ鍐┾拺缂備焦锚闁叉粓鏌�?

//        MCP2515_CsInActive();
          while((MCP2515_SPIX->SR & 0x01) != 0)//SPI闂傚倸鍊搁崐宄懊归崶褜娴栭柕濞炬櫆閸ゅ嫰鏌ょ粙璺ㄤ粵婵炲懐濮垫穱濠囧Χ閸屾矮澹曢梻浣风串缁蹭粙鎮樺璺虹闁告稑鐡ㄩ崑鏍倵濞戞顏堫敂閸洘鈷掗柛灞炬皑婢ф稓绱掔�ｎ偄鐏存い銏℃閸╋繝宕ㄩ鎯у箺闂佸湱鍎ゆ繛濠傜暦濠靛绠ｆ繝闈涚墛濞堥箖姊虹憴鍕姸婵☆偄瀚崕顐︽⒒娴ｇ懓顕滈柡灞诲姀閵囨劙濡搁埡鍌涙珖闂佺鏈粙鎾诲储閸楃偐鏀芥い鏃�鏋婚懓璺ㄧ磼閻樺磭澧い顒�锕、娆撴偩瀹�鈧惁鍫ユ⒑鐠恒劌鏋欏┑顔哄�楃划顓㈡偄閸忓吋娅㈤梺鑺ッˇ浠嬪吹閺囥垺鐓熼柕蹇曞Т椤ュ繘鏌℃担绋库偓鍧楀蓟濞戙垹唯闁靛濡囬妴鎰攽閻愯尙澧涙俊鐐舵椤繘宕崟鎳峰洤鐐婄憸宥夆�栭崼銉︾厽閹兼番鍨归崵顒勬煕濞嗗繐鏆欐い鏇秮楠炲酣鎳為妷銉ょ盎闂備胶绮幐绋棵归悜绛嬫晩濠㈣埖鍔栭埛鎴︽偣閹帒濡兼繛鍛姍閺�?
        {
            DR= *((__IO u8 *)&MCP2515_SPIX->DR) & 0xFFFF;//闂傚倸鍊峰ù鍥х暦閸偅鍙忛柡澶嬪殮濞差亜鐓涢柛婊�鐒﹂弲顏堟偡濠婂嫬鐏村┑锛勬暬楠炲洭寮剁捄銊モ偓鐐差渻閵堝棗鍧婇柛瀣尵缁辨帡鍩�椤掑嫬绀嬫い鏍ㄧ〒閸樹粙姊洪悷閭﹀殶闁稿﹥鐗犻獮瀣晜鐟欙絾瀵栭柣搴＄畭閸庨亶藝娴煎瓨鍋傞柕澶涘缁犻箖鏌熺�甸晲绱虫い蹇撶墑閳ь剙鍟埢搴☆嚗濠靛牊鍤�妞ゎ厹鍔戝畷鐔碱敃閿濆牏妾ㄥ┑鐘愁問閸犳牠鏁冮妶澶娢ч柟闂磋兌瀹撲線鏌熼幑鎰靛殭缂佺姵濞婇弻鐔煎礈瑜滈崝婊堟煙妞嬪骸鍘撮柟顔荤矙瀹曘劍绻涢悙顒�顏洪梻鍌欑婢瑰﹪宕戦崨顖滅煓闁硅揪闄勯崐鍫曞级閸稑濡稿ù婊勭矒閺岋繝宕堕妸銊ヮ棟閻庤鎸稿Λ娑㈠焵椤掑喚娼愭繛娴嬫櫇缁辩偞鎷呴崜鎻掓婵炲濮撮鎰板极閸愵喗鐓ユ繝闈涙婢跺嫭绻涢崼鐔稿�愭慨濠勭帛閹峰懘鎳為妷锝傚亾閸愵喗鐓犻悗鍦Т閻撴劙鏌￠崨鐗堢【閾绘牠鏌嶈閸撶喖骞冩ィ鍐ㄥ瀭妞ゆ劑鍊楅幊婵嬫⒑鐠恒劌鏋嶇紒顔界懃椤曪絾绻濆顑┾晠鏌曟径鍫濈仾闁诲骸顭烽弻鐔兼嚌閻楀牆娑х紓浣瑰絻閻忔繈鎮�?
        }

          flag=MCP2515_ReadByte(Mcp2515_CANINTF); //婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犲綊鏌嶉崫鍕櫣闁稿被鍔岄湁闁绘ê妯婇崕蹇涙煢閸愵亜鏋涢柡灞剧洴婵＄兘顢欓悡搴交闂備礁鎲￠崝蹇涘磻閹剧粯鈷掑ù锝堫潐閸嬬娀鏌涙惔銏㈢煉鐎规洏鍔戦、娑㈡晲閸涱喗鐝掓繝鐢靛Х閺佹悂宕戦悩璇茬妞ゅ繐妫涚粈濠囨煕閵夘喖澧紒鐙�鍨堕弻?
          eflg=MCP2515_ReadByte(Mcp2515_EFLG);    //闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏃堟暜閸嬫挾绮☉妯诲闁稿绻濋弻鏇熺箾閻愵剚鐝﹂梺杞扮椤戝寮婚弴銏犻唶婵犲灚鍔栫瑧闂備礁鎲￠崝蹇涘磻閹剧粯鈷掑ù锝堫潐閸嬬娀鏌涙惔銏㈢煉鐎规洏鍔戦、娑㈡晲閸涱喗鐝掓繝鐢靛Х閺佹悂宕戦悩璇茬妞ゅ繐妫涚粈濠囨煕閵夘喖澧紒鐙�鍨堕弻?
          tec=MCP2515_ReadByte(Mcp2515_TEC);      //闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂佹寧娲栭崐鎼佸垂閸岀偞鐓曠憸搴ㄣ�冮崱娑樼柧闁归棿鐒﹂悡娆撴倵濞戞顏嗙箔瑜忕槐鎺楀箛椤撶噥妫冮梺鍝勫閸撴繈骞忛崨瀛橆棃闁宠桨绀侀～鐘绘⒒娴ｅ摜绉烘い銉︽尰缁绘盯鍩�椤掍降浜滈柕蹇ョ磿閳藉鏌嶇憴鍕伌妤犵偛娲、妤佹媴缁洖浜鹃幖娣妽閳锋帒霉閿濆牆袚闁靛棗鍟撮弻锝夊箳閻愮數鏆犲銈庡幖閻忔繈锝炲鍫濈劦妞ゆ帒瀚粻姘归敐鍫綈闁稿海鍠栭弻銊モ攽閸℃瑧顔夐柣搴亢椤鎹㈠☉銏犵闁绘垵妫旈惀顏勵渻閵堝懐绠伴悗姘�鍥у嚑鐎广儱顦伴悡銉╂煟閺囩偛鈧湱鈧�?
          rec=MCP2515_ReadByte(Mcp2515_REC);      //闂傚倸鍊搁崐宄懊归崶顒婄稏濠㈣泛顑囬々鎻捗归悩宸剰缁炬儳娼￠弻锛勪沪鐠囨彃濮庨梺鍝勵儎閼冲爼骞夐幖浣瑰亱闁割偅绻勯悷鏌ユ⒑缂佹ɑ灏柛搴ゅ皺閹广垹鈽夐姀鐘茶�垮┑鈽嗗灥濡椼劑宕氭繝鍥ㄢ拺闁硅偐鍋涢埀顒佺墵閹囨偐鐠囪尙鐣洪柣鐔哥懃鐎氼厽鍒婇幘顔界厵缂備焦锚缁楁帡鏌嶅畡閭︽█婵﹥妞藉畷顐﹀礋椤掑锟ラ梻浣告憸婵敻骞戦崶顒�鏋侀柟鎯ь嚟椤╃兘鎮楅敐搴′簼闂佹鍙冮弻锝嗘償閵忕姴姣堥梺鍛婃尵閸犳牠鐛崘顭嬫椽顢旈崟搴樻櫊閺屽秵娼幍顔剧崲濠碘槅鍋嗛崗妯侯潖閾忚宕夐柕濞垮劜閻濄垽姊�?

          if(eflg==255 || flag==255)//闂傚倸鍊搁崐椋庣矆娓氣偓瀹曘儳鈧綆鍠楅崕鎴犳喐閻楀牆绗掔痪鎯ф健瀵爼宕奸顫按婵炲瓨绮岀紞濠囧蓟濞戞鏆嗛柍褜鍓熷畷鎴︽倷閸濆嫮锛涢梺闈浥堥弲婊堟偂閻斿吋鐓涢柛鎰剁到娴滄儳鈹戦敍鍕粶婵炲皷鈧磭鏆﹂柣銏㈩焾椤懘鏌曢崼婵囶棤闁告ê宕埞鎴︽倷閸欏妫￠梺鍛婃⒐椤ㄥ棝寮查崼鏇熷仺闁告稑锕﹂崢鍛婄箾鏉堝墽绉繛鐓庮煼瀹曟繈鎮㈤崗鑲╁幍婵＄偛顑呮鎼佸煝閸喆浜滈柕蹇ョ磿濞叉挳鏌熼鐣屾噭婵炵厧绻樺畷婊嗩槼闁靛洦绻冪换婵堝枈濡椿娼戦梺绋款儏濡瑩寮茬捄浣曟棃宕ㄩ鑺ョ彇婵＄偑鍊栭崝鎴﹀磹閺嶎叏缍栭柡鍥╁枔缁♀偓闂傚倸鐗婃笟妤呭磿閹扮増鐓熼柟鎯у暱閳ь剙顭烽崺鈧い鎺嗗亾缂佺姴绉瑰畷鏇㈠础閻愬秵绋戦埢搴ㄥ箻閺夋垳绨甸梻浣芥硶閸犲秶鍒掑▎鎾宠摕闁挎繂顦伴崑鎰版煕濞嗗浚妲洪柍瑙勭☉椤啴濡堕崱妯垮亖闂佺硶鍓濋崝鎺懶уΔ鍛拺閻犳亽鍔屽▍鎰版煙?
          {
              tec=MCP2515_ReadByte(Mcp2515_TEC);
              rec=MCP2515_ReadByte(Mcp2515_REC);
              eflg=MCP2515_ReadByte(Mcp2515_EFLG);    //闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏃堟暜閸嬫挾绮☉妯诲闁稿绻濋弻鏇熺箾閻愵剚鐝﹂梺杞扮椤戝寮婚弴銏犻唶婵犲灚鍔栫瑧闂備礁鎲￠崝蹇涘磻閹剧粯鈷掑ù锝堫潐閸嬬娀鏌涙惔銏㈢煉鐎规洏鍔戦、娑㈡晲閸涱喗鐝掓繝鐢靛Х閺佹悂宕戦悩璇茬妞ゅ繐妫涚粈濠囨煕閵夘喖澧紒鐙�鍨堕弻?
              flag=MCP2515_ReadByte(Mcp2515_CANINTF); //婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犲綊鏌嶉崫鍕櫣闁稿被鍔岄湁闁绘ê妯婇崕蹇涙煢閸愵亜鏋涢柡灞剧洴婵＄兘顢欓悡搴交闂備礁鎲￠崝蹇涘磻閹剧粯鈷掑ù锝堫潐閸嬬娀鏌涙惔銏㈢煉鐎规洏鍔戦、娑㈡晲閸涱喗鐝掓繝鐢靛Х閺佹悂宕戦悩璇茬妞ゅ繐妫涚粈濠囨煕閵夘喖澧紒鐙�鍨堕弻?
          }

          if(eflg & 0x80)                         //闂傚倸鍊搁崐宄懊归崶顒婄稏濠㈣泛顑囬々鎻捗归悩宸剰缁炬儳娼￠弻锛勪沪鐠囨彃濮庨梺鍝勵儎缁舵岸寮诲☉銏℃櫆閻犲洦褰冪粻鑽ょ磼閹冪稏缂侇喗鐟╁濠氭偄閻撳海鐣鹃悷婊冪Ч瀵娊鏌嗗鍡欏幐闂佺硶鍓濈粙鎰板箟妤ｅ啯鐓涢悘鐐插⒔濞插鈧鍠曠划娆忕暦瑜版帩鏁冮柕蹇婃櫃缁�?濠电姷鏁告慨鐑藉极閸涘﹥鍙忕�广儱妫欐刊鎾煕濠靛嫬鍔欓柟顕嗙秮濮婄粯鎷呯憴鍕哗闂佺臎閸パ咁唵?
          {
//            Mcp2515_gs_u64Rx1OverCnt++;
          }
          if(eflg & 0x40)                         //闂傚倸鍊搁崐宄懊归崶顒婄稏濠㈣泛顑囬々鎻捗归悩宸剰缁炬儳娼￠弻锛勪沪鐠囨彃濮庨梺鍝勵儎缁舵岸寮诲☉銏℃櫆閻犲洦褰冪粻鑽ょ磼閹冪稏缂侇喗鐟╁濠氭偄閻撳海鐣鹃悷婊冪Ч瀵娊鏌嗗鍡欏幐闂佺硶鍓濈粙鎰板箟妤ｅ啯鐓涢悘鐐插⒔濞插鈧鍠曠划娆忕暦瑜版帩鏁冮柕蹇婃櫃缁�?濠电姷鏁告慨鐑藉极閸涘﹥鍙忕�广儱妫欐刊鎾煕濠靛嫬鍔欓柟顕嗙秮濮婄粯鎷呯憴鍕哗闂佺臎閸パ咁唵?
          {
//            Mcp2515_gs_u64Rx0OverCnt++;
          }
          if(eflg & 0x20)                         //闂傚倸鍊搁崐宄懊归崶顒夋晪闁哄稁鍘肩粈鍫熺節闂堟稒顥犻柡鍡畵閺岋綁濮�閵忊晝鍔搁梺鍛婅壘缂嶅﹪鐛弽顬ュ酣顢楅埀顒佷繆閼测晝纾奸柍褜鍓熷畷鎺楁倷鐎电骞嶉梻浣筋嚃閸ㄥ崬顭垮Ο娆炬毐闂傚倷鐒︾�笛呯矙閹烘嚦娑㈠礃椤垶缍庡┑鐐叉▕娴滄粎绮绘导鏉戠閺夊牆澧界粙濠氭煕閿濆骸鐏犳い顏勫暣婵″爼宕卞Ο灏栨晬闂�?
          {
//            Mcp2515_gs_u64BusOffCnt++;
//            Mcp2515_s_bBusOffFlag=true;
          }

          if(flag&(Mcp2515_RX1IF | Mcp2515_RX0IF))//闂傚倸鍊搁崐宄懊归崶顒婄稏濠㈣泛顑囬々鎻捗归悩宸剰缁炬儳娼￠弻锛勪沪鐠囨彃濮庨梺鍝勵儎缁舵岸寮诲☉銏℃櫆閻犲洦褰冪粻鑽ょ磼閹冪稏缂侇喗鐟╁濠氭偄閻撳海鐣鹃悷婊冪Ч瀵娊鏌嗗鍡欏幐闂佺硶鍓濈粙鎰板箟妤ｅ啯鐓涢悘鐐插⒔濞插鈧鍠曠划娆撱�侀弴銏狀潊闁绘ê妯婇悗閬嶆⒑鐠囨彃顒㈡い鏃�鐗犲畷鎶筋敍閻愯尙顔�?
          {
//            Mcp2515_gs_u64IntCnt[0]++;
              MCP2515_ReceiveData();
          }

          if(flag & 0x80)
          {
//            Mcp2515_gs_u64IntCnt[1]++;
          }
          if(flag & 0x20)
          {
//            Mcp2515_gs_u64IntCnt[1]++;
          }

          if(eflg<=0x1f && eflg!=0)              //闂傚倸鍊搁崐鎼佸磹閹间礁纾圭紒瀣紩瑜版帒绀嬫い鏍ㄦ皑椤斿棝姊虹紒妯虹伇濠殿喓鍊濆畷鎴︽晲閸氥倕缍婇弫鎰板幢濡ゅ啰銈峰┑鐘媰閸曨厼寮ㄩ梺鍝勭焿缁绘繂鐣烽崡鐐╂瀻闊洦姊绘禍顏堟煟鎼淬値娼愭繛鍙壣戠换娑欑節閸愌呯畾闂佸綊妫跨粈渚�鎮″☉妯忓綊鏁愰崼顐㈡異婵炲濮嶉崨顖滐紳闂佺鏈懝楣冨焵椤掍焦鍊愮�规洘婢橀～婵堟崉閾忓湱宕舵繝娈垮枟閿曗晠宕楀鈧鎼佸籍閸喓鍘甸柡澶婄墦缁犳牕顬婇鈧弻锝夊箻閸楃偛濮曠紓浣虹帛閻╊垰鐣烽崡鐐嶇喐娼弶鍨亖闂傚倷鐒﹂幃鍫曞磹瑜旈獮?
          {
//            Mcp2515_gs_u64IntCnt[1]++;

              MCP2515_WriteReg(Mcp2515_CANCTRL,Mcp2515_REQOP_CONFIG | Mcp2515_CLKOUT_ENABLED);//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌涘櫧闁活厽鐟╅弻鐔告綇閸撗呮殸闂佹椿鍘介〃濠囧蓟濞戙垹鐒洪柛鎰亾椤撶懓鈹戦悙鐑橈紵闁告濞婂濠氬Ω閵夈垺鏂�闂佺硶鍓濋敋婵炲憞鍥ㄢ拺缂侇垱娲樺▍鍡樸亜閵娿儲顥炵紒宀冮哺缁绘繈宕堕懜鍨珫婵犲痉鏉库偓鏇㈩敄閸℃瑢鍋撳顒佽础闁逞屽墲椤煤閺嶎灐娲Ω閳瑰簱鍋�?
              dummy=MCP2515_ReadByte(Mcp2515_CANSTAT);
              MCP2515_WriteReg(Mcp2515_CANCTRL,Mcp2515_REQOP_NORMAL | Mcp2515_CLKOUT_ENABLED);//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌涘櫧闁活厽鐟╅弻鐔告綇閸撗呮殸闂佹椿鍘介〃濠囧蓟濞戙垹鐒洪柛鎰亾椤撶懓鈹戦悙鐑橈紵闁告濞婂濠氬Ω閵夈垺鏂�闂佺硶鍓濋敋婵炲憞鍥ㄢ拺缂侇垱娲樺▍鍡樸亜閵娿儲顥炵紒宀冮哺缁绘繈宕堕懜鍨珫婵犲痉鏉库偓鏇㈩敄閸℃瑢鍋撳顒佽础闁逞屽墲椤煤閺嶎灐娲Ω閳瑰簱鍋�?
              dummy=MCP2515_ReadByte(Mcp2515_CANSTAT);
          }

          MCP2515_WriteReg(Mcp2515_EFLG,0);       //闂傚倸鍊搁崐椋庢濮橆剦鐒介柤濮愬�栫�氬鏌ｉ弮鍌氬付缂佲偓婢跺备鍋撻獮鍨姎闁瑰啿鐭傞崺鈧い鎺嶇濞搭喚鈧娲栭妶绋款嚕閹绢喗鍊风紓鍌氬濞茬喖寮婚悢鐓庣闁兼祴鏅滃▓顒勬⒑閹肩偛濡兼い顓犲厴閵嗕線寮崼婵堫啇婵炶揪绲介崢婊堝箯婵犳碍鈷戦柛娑橈攻绾剧敻鏌￠崨顔炬创闁轰焦鎹囬幊鐐哄Ψ瑜嶉～褔姊洪崫鍕殌婵炲鐩、姗�宕楅悡搴ｇ獮婵犵數濮撮崐鏄忋亹婢跺ň鏀介柣姗嗗枛閻忚鲸绻涙径瀣创妞ゃ垺鐗犲畷鍫曨敆閳ь剟宕归崒姘ｆ斀闁稿本纰嶉幉鎼佹煕濞嗘劖宕岄柡灞剧洴婵＄兘鏁愰崨顓団晜绻涚�电顎撳┑鈥虫川濡叉劙骞橀幇浣告倯闂婎偄娲﹂弻銊╊敂?
          MCP2515_WriteReg(Mcp2515_CANINTF,0);

          Int_ClearLine(MCP2515_EXIT_INT_LINE);       //濠电姷鏁告慨鐑藉极閹间礁纾婚柣鎰惈缁犱即鏌熼梻瀵割槮缂佺姷濮垫穱濠囶敍濠靛嫧鍋撻埀顒勬煛鐎ｎ亞效妤犵偞鐗曡彁妞ゆ巻鍋撻柣蹇ｅ櫍閺屽秶绱掑Ο鐑╂嫻闂侀潧娲ょ�氫即鐛Ο鍏煎磯闁绘垶顭囬埀顒勭畺濮婅櫣绱掑Ο铏诡儌闂佸搫鎷嬮崑鍡椢ｉ幇鏉跨婵°倐鍋撶紒鐘虫皑閹茬顓兼径瀣壄闂佹寧绋戠�氼喚澹曟總绋跨骇闁割偅绋戞俊璺ㄧ磼閻樺磭澧紒缁樼洴閹剝鎯旈鎯ф倯闂備浇顕栭崰妤呮偡閳轰緡鍤曢柛顐ｆ礀缁狅絾绻濋崹顐㈠娴滄稑鈹戦悩鍨毄闁稿鍋ゅ畷褰掑醇閺囩偟顔愰梺鍐叉惈閹冲酣宕掗妸銉冨綊鎮╁顔煎壈闂佽棄鍟伴崰鏍蓟閵娾晜鍋嗛柛灞剧☉椤�?
          Int_ContactLine(MCP2515_EXIT_INT_LINE);
        break;
    }
}

//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鍊告禍楣冩⒑鐎圭姵顥夋い锔炬暬閻涱喖螣閼测晠鈹忛梺鑽ゅ枛椤ｏ妇妲愰敐澶嬧拻濞达綀顫夐妵鐔访瑰鍕畺缂佹梻鍠栧畷鍗炩槈濡⒈鍞垫俊鐐�栭崝褏绮婚幋鐘电焼闁告劏鏂傛禍婊堢叓閸ャ劍灏伴柛锝囧劋缁绘盯宕煎☉妯间紙濠殿喖锕ュ钘夌暦閵婏妇绡�闁告洦鍓欏▍妤呮⒒娴ｈ鍋犻柛鏂胯嫰椤洭鏁撻悩鍙夌�梺瑙勫礃椤曆呯不閿濆鐓欓柣鎴炆戦ˉ鏃�淇婂顔兼珝婵﹥妞介獮鏍倷濞村浜炬繝闈涙川椤╂煡鎮规潪鎷岊劅闁搞倖娲橀妵鍕箛閸洘顎嶉梺鍝勬噺閹倿寮婚妸鈺傚亞闁稿本绋戦?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挾鍠栧濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦紞濠傤嚕椤愶箑绠荤紓浣股戝▍銏ゆ⒑?
//=====================================================================
bool_t MCP2515_Write(struct CANBusCB * CANBus,CanFarmeDef *Frame)
{
    uint8_t *CAN_TX_Buf;
    Frame_TypeDef MCP2515_Frame;

    MCP2515_Frame.ID = Frame->Id;
    MCP2515_Frame.DLC = Frame->DLC;
    MCP2515_Frame.Type = Frame->Type;
    CAN_TX_Buf = Frame->Data;

    MCP2515_SendData(CAN_TX_Buf,&MCP2515_Frame);
    return true;
}

//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鎳忛崳娲煟閹惧鎳囬柟顔肩秺閹煎綊鎮烽幍顔筋吇闂備浇銆�閸嬫挸鈹戦悩宕囶暡闁绘挻鐩弻娑㈠焺閸愵亝鍣ч梺鍝勵儐缁嬫帡銆冮妷鈺傚�烽柡澶嬪灩娴煎苯顪冮妶鍐ㄧ仾闁荤啙鍥х闁告洦鍨版儫閻熸粍绮撳畷顒冦亹閹烘挴鎷绘繛杈剧秬椤宕戦悩缁樼厱閹兼番鍨归埢鏇犫偓瑙勬礃閸ㄤ絻鐏掗梺鍏肩ゴ閺呮繈鎮鹃崼鏇熲拺缂佸瀵у﹢鎵磼椤旇偐澧曢柍璁崇矙椤㈡棃宕奸悢鍝勫箞闂佽绻掗崑娑欐櫠娴犲鍎楅悗锝庡枟閻撶喖鏌ㄥ┑鍡╂Х闁规煡绠栭弻锛勪沪閸撗勫垱濡ょ姷鍋涢澶愬极閹版澘宸濋柛娑卞枟瀹曞矂鏌″畝瀣瘈鐎规洟浜堕、姗�鎮㈡總澶夌处
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挾鍠栧濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦紞濠傤嚕椤愶箑绠荤紓浣股戝▍銏ゆ⒑?
//=====================================================================
bool_t MCP2515_Read(uint8_t *CAN_RX_Buf,Frame_TypeDef *Frame)
{
    CanFarmeDef CAN_Frame;
    u8 i=0;

    CAN_Frame.Id=Frame->ID;
    CAN_Frame.DLC=Frame->DLC;
    CAN_Frame.Type=Frame->Type;

    for(i=0;i<CAN_Frame.DLC;i++)
    {
        CAN_Frame.Data[i]=CAN_RX_Buf[i];
    }
    CAN_BusAddRcvFrame(p_MCP2515_CBHandle,&CAN_Frame);

    return true;
}

//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鍊告禍楣冩⒑鐎圭姵顥夋い锔炬暬閻涱喖螣閼测晠鈹忛梺鑽ゅ枛椤ｏ妇妲愰敐澶嬧拻濞达綀顫夐妵鐔访瑰鍕畺缂佹梻鍠栧畷鍗炩槈濡⒈鍞垫俊鐐�栭崝褏绮婚幋鐘电焼闁告劏鏂傛禍婊堢叓閸ャ劍灏伴柛锝囧劋缁绘盯宕煎☉妯间紙濠殿喖锕ㄥ▍锝呪槈閻㈢宸濇い鏍ㄧ矊婵椽姊绘担鍛婂暈闁告梹鍨垮畷婵囨償閵娿儱鍋嶅銈嗗笒鐎氼參鍩涢幋锔界厱婵炴垶锕銉╂煟韫囨挸鑸归柍瑙勫灴椤㈡瑩宕崟銊ヤ壕婵犻潧妫崵鏇㈡煙閹澘袚闁哄懏鎮傞弻?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挾鍠栧濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦紞濠傤嚕椤愶箑绠荤紓浣股戝▍銏ゆ⒑?
//=====================================================================
bool_t MCP2515_Ctrl(struct CANBusCB * CANBus,uint8_t ctrlcmd,ptu32_t param1,ptu32_t param2)
{

    switch(ctrlcmd)
    {
       case EN_CAN_BUS_RESET:
               MCP2515_Reset();
               break;
       case EN_CAN_BUS_SET_BAUDRATE:
               switch(param1)
               {
                   case EN_CAN_BUS_BAUD_125K:
                       Mcp2515_baudrate=125;
                       break;
                   case EN_CAN_BUS_BAUD_250K:
                       Mcp2515_baudrate=250;
                       break;
                   default:
                       break;
               }
               if(Mcp2515_baudrate!=0)
                   MCP2515_Init();
                   break;
      case EN_CAN_BUS_SET_FILTER:

              break;
      default:
          break;
    }
    return true;
}

//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鍊告禍鎯ь渻閵堝骸骞栨繛纭风節楠炲﹤顭ㄩ崼鐔蜂缓闂傚倸鐗婄粙鍫ュ箯娴煎瓨鈷掑ù锝勮閻掓儳螖閻樿櫕鍊愰柟顔芥そ婵℃瓕顦撮柣顓熺懃椤潡鎳滈棃娑樞曢梺杞扮濞差參寮婚敐澶婃闁圭瀛╅崰鎰版⒑閸涘﹥鈷掗柛蹇斆～蹇撁洪鍕獩婵犵數濮撮崐濠氭偡閼碱剛纾藉ù锝囩摂閸ゆ瑩鏌涙繝鍌涘仴闁轰焦鍔欓幃娆撳传閸曨厾鏉搁梻浣告惈椤﹀啿鈻旈弴鈶哄洭鏌嗗鍡忔嫼闂佸憡绻傜�氼垶鎯傛笟鈧弻娑㈠箛閵婏附鐝栧┑鈥虫▕娴滎亜顫忕紒妯诲闁兼亽鍎埀顒�鍟扮槐鎺楃叕閹绘巻鍋撳┑瀣祦闊洦绋掗弲?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挾鍠栧濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦紞濠傤嚕椤愶箑绠荤紓浣股戝▍銏ゆ⒑?
//=====================================================================
void  MCP2515_IntInit(void)
{
    Int_Register(MCP2515_EXIT_INT_LINE);
    Int_IsrConnect(MCP2515_EXIT_INT_LINE,(void(*))HAL_GPIO_EXTI_IRQHandler);//婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犲綊鏌嶉崫鍕櫣闁稿被鍔岄湁闁绘ê妯婇崕蹇涙煢閸愵亜鏋涢柡灞剧洴婵＄兘濮�閳╁啰褰嗛梻浣告憸婵潙螞濠靛钃熼柕濞炬櫅閸楄櫕銇勮箛鎾村櫣妞ゅ繐鐖奸弻锝夋偄閸濄儳鐓佸┑鐘灪閿曘垹鐣烽幇鏉挎嵍妞ゆ挻绋戞禍楣冩煟閵忋倖娑ч悽顖濆煐閵囧嫰顢曢敐鍥╃暤闂佷紮绲块崗妯虹暦閸洍鈧箓骞嬪┑鍥ㄧ彃闂傚倸鍊搁崐鐑芥嚄閸洖纾块柣銏㈩焾绾惧鏌熼幑鎰靛殭缂佲偓婢舵劗鍙撻柛銉ｅ妺缁堕亶鏌℃担鍓插剱闁逛究鍔岃灒闁圭娴烽妴鎰磽娴ｆ彃浜鹃梺鍛婃处閸ㄩ亶鎮￠悩缁樼厵妞ゆ挾鍠庣粭鎺楁煕閺冣偓缁秶鎹㈠☉銏犻唶婵犻潧鐗嗛悡鐔兼⒑閸濆嫯顫﹂柛鏂跨焸閸┿儲寰勬繛銏㈠枛閹剝鎯旈鑺ョ槕缂傚倸鍊搁崐鎼佸磹閸濄儳鐭撻柟缁㈠枛缁犵娀鐓崶銊︾闁活厼顦遍埀顒�绠嶉崕閬嶅箯鐎ｎ喖鐤柛娑卞幐閺�鑺ャ亜閺嶃劍鐨戠�规洜桅gpio.c闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻搐缁�鍐ㄢ攽閻樺疇澹樼紒鐙�鍨堕弻?
    Int_SetIsrPara(MCP2515_EXIT_INT_LINE,GPIO_PIN_3);//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顕�宕堕妸锝傚亾閸愵喗鐓熼柟鐑樺煀闊剛鈧鍠栭悥鐓庣暦閻撳簶妲堟俊顖欒閻庡绱撴担璇℃畷闁搞劌娼￠獮鍐ㄎ旈埀顒勫煝閹捐鍨傛い鏃傛櫕娴滆埖绻濋悽闈涗粶鐎殿喖澧庨幑銏ゅ醇濠靛牊娈惧┑鐘诧工閻楀﹪寮查幖浣圭叆?闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏楣冩闁稿顑夐弻娑㈠焺閸愵厽宸㈤梺鎼炲劘閸斿海寮ч埀顒�鈹戦鏂や緵闁告﹢绠栧畷婵嬪箹娴ｅ厜鎷洪梻鍌氱墛娓氭鎮炴ィ鍐╃厱濠电姴鍟板ú瀵糕偓瑙勬磸閸ㄤ粙銆佸Δ鍛妞ゆ帒鍊搁獮鎰版⒒娴ｄ警鐒鹃悶姘煎亰瀹曟劙寮撮姀銏犵ウ濠碘槅鍨靛畷鐢电不妤ｅ啯鐓涘璺侯儏閻掔偓淇婇妤�浜鹃梺璇叉唉椤煤韫囨稑纾块柧蹇ｅ亞椤╃兘鏌ㄩ弴鐐测偓褰掑磻閳哄啠鍋撻崗澶婁壕闂侀�炲苯澧撮柛鈺冨仜閳藉濮�閳锯偓閹锋椽姊虹紒妯诲碍婵炲鍏橀獮妤呮偐缂佹鍘鹃柣鐔哥懃鐎氼剛绮堥崘顔界厪闁搞儯鍔屾慨宥団偓瑙勬礈椤牐鐏冩繛杈剧悼椤牊绔熼崟顖涒拻濞达絽鎲￠崯鐐烘偨椤栨娅呴柨鏇樺灮瀵呯紦椤忓牊鈷掗柛灞剧懅椤︼箓鏌熺拠褏绡�闁诡噣鏀卞蹇涘煛娴ｈ櫣鐡樺┑鐐差嚟婵挳顢栭崨瀛樺剹婵°倕鎳忛悡銉╂煟閺傛寧鎯堥弽锟犳⒑缁嬫鍎嶉柛鏃�鍨垮濠氬即閻旇櫣顔曢梺鍓茬厛閸犳帡宕戦幘婢勬棃宕担瑙勬珕闂備礁鎲￠〃鍫ュ磻閹邦儵锝夊醇閵夛妇鍘甸梺鍓茬厛閸犳牠寮抽弴鐘电＜闁靛ě鍐ㄥ箣闂佸搫琚崐婵嗙暦瑜版帩鏁冮柕蹇ｆ線缁辨繈鏌ｆ惔銏╁晱闁革綆鍣ｅ畷婊堟偄缁楄　鍋撴担鍓叉建闁逞屽墯娣囧﹤顫㈠畝濠冃俊?
    Int_SettoAsynSignal(MCP2515_EXIT_INT_LINE);
    Int_ClearLine(MCP2515_EXIT_INT_LINE);
    Int_RestoreAsynLine(MCP2515_EXIT_INT_LINE);
}

//----MCP2515婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犲綊鏌嶉崫鍕櫣闁稿被鍔岄湁闁绘ê妯婇崕蹇涙煢閸愵亜鏋涢柡灞剧洴婵＄兘鏁愰崨顓х�村┑鐘愁問閸ㄩ亶骞愰幎钘夎摕闁靛牆顦粻娑樏归敐鍛喐濞寸姭鏅犲娲川婵炴碍鍨甸…鍥р枎閹惧磭鍙�婵犮垼鍩栭崝鏇犵不婵犳碍鐓欓柛鎾茶兌閹藉倿鏌嶈閸撴岸銆冩繝鍥ц摕闁哄洢鍨归悙濠囨煏婵炲灝鍔ゅù鐓庣焸濮婅櫣娑甸崨顔惧涧濡炪們鍔岄敃顏勵嚕椤愶箑绠荤紓浣股戝▍銏ゆ⒑?--------------------------------------------------------
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼閻愬鍙嗛梺缁樻礀閸婂湱鈧�? 闂傚倸鍊搁崐鐑芥嚄閸洖绠犻柟鍓х帛閸婅埖鎱ㄥΟ鎸庣【缂佺姳鍗抽弻娑樷攽閸曨偄濮曞銈庡亝濞茬喖寮婚悢鍛婄秶闁告挆鍛缂傚倷鑳舵刊瀵哥礊娓氣偓瀵鍨鹃幇浣告倯闂佸憡鍔戦崝宀勨�栫�ｎ亶娓婚柕鍫濇噽缁犳煡鏌熼鐓庘偓鎼侊綖韫囨梻绡�婵﹩鍓涢ˇ浼存⒑閸撹尙鍘涢柛瀣尵濡叉劕鈹戦—鎿∟TE婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犲綊鏌嶉崫鍕櫣闁稿被鍔岄湁闁绘ê妯婇崕蹇涙煢閸愵亜鏋涢柡灞剧洴婵＄兘鏁愰崨顓х�村┑鐘愁問閸ㄩ亶骞愰幎钘夎摕闁靛牆顦粻娑樏归敐鍛喐濞寸姭鏅犲娲川婵炴碍鍨块獮鎰板箮閽樺鐣哄┑掳鍊曢幊蹇浰夐崼鐔虹闁瑰鍎戞笟娑樏归悩灞傚仮婵﹨娅ｉ埀顒傛闂勫嫬顭垮Ο缁樺弿闁稿本澹曢崑鎾舵喆閸曨剛顦ㄦ繝鐢靛仜閿曘儲绌辨繝鍥х濞达綀鍊借閺屾盯濡烽姀鈩冪彆闂佸摜鍠嶉崡鍐差潖缂佹ɑ濯撮柛锔诲幗閼垮洭姊洪崨濠冪叆闁活剙銈搁崺鈧い鎺嶇閸ゎ剙霉濠婂懎浠ф俊鍙夊姍閹瑩鎮滃Ο缁橆仧闂�?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄被鍔戦幃銈夊磼濞戞﹩浼�: 闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敃鈧粣妤佺箾閹存瑥鐏╃紒鐙�鍨堕弻?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄繈寮查幖浣圭叆? 闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敃鈧粣妤佺箾閹存瑥鐏╃紒鐙�鍨堕弻?
//-----------------------------------------------------------------------------

void __MCP2515_CANINT_ENABLE(void)
{
    MCP2515_WriteReg(Mcp2515_CANINTE,Mcp2515_RX0IE|Mcp2515_RX1IE|Mcp2515_ERRIE|Mcp2515_MERRE);
}

void __MCP2515_CANINT_DISABLE(void)
{
    MCP2515_WriteReg(Mcp2515_CANINTE,0);
}

//=====================================================================
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鎻掔�梺绋跨箰閸氬宕ｈ箛娑欑厪闁割偅绻嶅Σ鍛婃叏鐟欏嫮鍙�闁哄矉缍佸顕�宕掑顑跨帛闂佽崵鍠愰悷杈ㄤ繆閸ヮ剙鐒垫い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳哄倸搴婇梺鍦劋濮婂鎮崇紒妯圭箚闁靛牆鎳忛崳娲煟閹惧瓨绀嬮柡宀�鍠栭幃婊兾熺拠鍙夋缂傚倷鑳舵慨鐢稿箰婵犳艾桅闁告洦鍨奸弫鍐煥濠靛棙鍣规い顐ｅ浮閹鎲撮崟顒傤槶婵犵數鍋愰崑鎾绘⒑鏉炴壆鍔嶉柟鐟版喘瀵偊骞樼紒妯绘?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄矉缍佸顒勫垂椤旇棄鈧垶姊洪崫鍕闁告挾鍠栧濠氬Ω閳哄倸浜為梺绋挎湰缁嬫垿顢�?
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栭弫宥呪枎閹寸姷锛滅紓鍌欓檷閸ㄧ懓顕ｉ濮愪簻闁靛闄勭亸鐢电磼椤曞棛绉柡?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼濞戞瑥寮垮┑掳鍊曢鍡欌偓姘秺濮婄儤娼幍顕呮М缂備礁顦伴幐鎶芥晲閻愭祴鏀介悗锝呯仛閺呫垺绻濋姀锝嗙【闁荤啿鏅犻崺锟犲磼濠婂拋鍟庨梺鍝勵槸閻楀棙鏅舵禒瀣闁规鍠氱壕鐓庮熆鐠虹儤婀伴柡鍡忔櫊閺屻劑鎮㈢紒姗嗘闂佽绻戝銊╁窗婵犲偆鍚嬮柛銉㈡櫇閻掑潡姊洪崷顓炲妺妞ゃ劌鎳庡ú鍧楁⒒娴ｅ憡鍟炲〒姘殜瀹曪綁鍩�椤掍降浜滈柡鍌涱儥濡插湱绱掔紒妯笺�掗柍褜鍓涢弫鎼佲�﹂崼锝傚徔闂傚倷鑳堕…鍫澝归悜钘夋瀬閻犲洩灏欓弳锕傛煙閹増顥夌紒鐘垫嚀闇夐柨婵嗘噺閸熺偞銇勯妷锔剧疄婵﹥妞藉畷顐﹀礋閸倣锕傛⒑鐠囪尙绠茬紒璇茬墦楠炲啫顫滈埀顒佷繆閻戣棄唯闁靛繆鍓濋弶鍛婁繆閻愵亜鈧牕顫忔繝姘厱闁割偁鍎辩壕鍧楃叓閸ャ劎鈯曢柛濠勬暬閺岋綁濮�閻樺吀绮电紓浣稿閸ゅ湧2515 闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁逞屽墴閸┾偓妞ゆ帊绀侀崵顒勬煕閹捐泛鏋庨柣锝囧厴椤㈡宕熼銈庡晪婵＄偑鍊栧濠氬疾椤愶箑绀夐柟闂寸劍閳锋垿姊婚崼鐔剁繁闁绘帡绠栭弻娑欐償閳ヨ櫕姣愰柛妤呬憾閺岀喐娼忔ィ鍐╊�嶉梺绋匡工閻忔氨鎹㈠☉銏犵闁绘垵妫旈惀顏勵渻閵堝懐绠伴悗姘�鍥у嚑鐎广儱顦伴悡娆撴煟閹寸儑渚涙繛鍫熸礋閺岋繝宕担绋库拫闂佽鍠楅敃銏ゅ箖濞嗘垶瀚氱憸搴ｂ偓姘秺閺岋綁寮崼顐ｎ棖閻熸粎澧楅悡鈥愁潖濞差亝鍤掗柕鍫濇啗閿涘嫮纾奸柍褜鍓氶幏鍛喆閸曨剛褰垮┑鐐差嚟婵挳顢栭崱娑樼；妞ゅ繐鐗婇悡鏇㈡煃閳轰礁鏆熼柍顖涙礋閺岋綁骞橀姘闂備浇顕ф鍝ョ不瀹ュ纾块柛妤冧紳濞差亜惟闁宠桨绀侀崵鎴︽⒑缁嬫寧婀扮紒瀣姉閹广垽宕卞Ο闀愮盎闂佸搫绋侀悡鍫濃枔閿濆鐓欑�瑰嫭婢樺Σ濠氭煟閿濆洤鍘寸�规洖鐖奸崺鈩冪節閸愨晜娈㈤梻鍌氬�搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熺�电浠ч梻鍕閺岋繝宕橀妸銉㈠亾閼姐倗涓嶉柡鍐ㄧ墛閻撴洜鈧厜鍋撻柍褜鍓熷畷鎴︽倷閸濆嫮锛涢梺闈浥堥弲婊堝煕閹烘鐓曟い鎰╁�曢弸鏃堟煃閽樺妯�闁哄矉缍�缁犳稓鈧綆浜滄慨搴ㄦ⒑鐎圭媭娼愰柛銊ユ健閵嗕礁鈻庨幋婵囩�抽梺鍛婎殘閸嬫稒绔熼崼銉︹拺閻犲洦鐓￠崣鍕箾娴ｅ啿鍠氶崵鏇㈡偣鏉炴媽顒熼柣鎺曟閳规垿鎮╃�圭姴顥濋梺缁樺姇閿曨亪寮诲澶婃嵍妞ゆ挾鍋樻竟鏇㈡⒑缂佹ɑ灏靛┑顔炬暩閹广垹鈽夐姀鐘殿吅闂佺粯鍔曢悺銊╁磿閹剧粯鈷戠憸鐗堝俯濡垿鏌涜箛鏂嗩亪锝炶箛鎾佹椽顢斿鍡樻珦闂備礁鎲＄换鍌溾偓姘煎墴閳ユ牠宕奸妷锔规嫼闂佸憡鎹佺亸娆撳储濠婂牊鐓�?
//=====================================================================
void MCP2515_Init(void)
{
    u8 flag;
    uint8_t dummy=0;
  /*婵犵數濮烽。钘壩ｉ崨鏉戠；闁规崘娉涚欢銈呂旈敐鍛殲闁稿顑夐弻锟犲炊閵夈儳浠奸梺绋胯閸斿秶鎹㈠☉銏犵婵炲棗绻掓禒鑲╃磽娴ｆ彃浜鹃梺绯曞墲椤洨寮ч埀顒勬⒒閸屾氨澧涚紒瀣浮閺佸秴顓奸崱娆戭啎闂佺绻掗埛鍫濃枔濠婂牊鐓涢悘鐐插⒔濞插鈧鍠曠划娆愪繆閹间焦鏅滈柤鎭掑劜濮ｅ侗I闂傚倸鍊搁崐鐑芥嚄閸撲礁鍨濇い鏍ㄧ矋閺嗘粓鏌ｉ弬璺ㄦ闁哄鐗楃换娑㈠箣濞嗗繒浠肩紓浣哄У閻楁绌辨繝鍥ч柛娑卞枛濞咃絿绱撴担鎻掍壕闂佺硶鍓濋…鍥╁姬閳ь剟姊婚崒姘卞缂佸甯￠弫宥咁吋閸℃瑧顔曢梺绋跨箳閳峰牆鈻撳鍫熺厸閻忕偛澧藉ú瀵糕偓娈垮枙缁瑦淇婇幖浣规櫆缂備降鍨归弲鐝籔2515
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?>闂傚倸鍊搁崐鎼佸磹妞嬪孩顐介柨鐔哄Т绾惧鏌涘☉鍗炴灓闁崇懓绉归弻褑绠涘鍏肩秷閻庤娲橀悡锟犲蓟濞戙垹绠涢柕濠忛檮閻濇梻绱撴担绋款暢闁稿鍠栭崺鈧い鎺嗗亾缂佺姴绉瑰畷鏇熸綇閳规儳浜炬慨妯煎帶閺嬨倗绱掗鑺モ拻闁哥姴锕ら…銊╂儘?515闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌涘櫧闁活厽鐟╅弻鐔告綇閸撗呮殸闂佹椿鍘介〃濠囧蓟濞戙垹鐒洪柛鎰典簴婵洭姊虹紒妯诲皑闁稿鎹囬弻锝嗘償閿涘嫮鏆涢梺绋块瀹曨剛鍙呴梺闈浥堥弲娑㈠礄閻樼粯鐓曢悘鐐插⒔閳笺儳绱掔拠鍙夘棡闁靛洤瀚板浠嬧�﹂幋鐑嗗悈闂備胶鎳撻崲鏌ュ床閺屻儲鍋╅柣鎴ｆ閻愬﹪鏌嶉崫鍕舵敾闁轰降鍊濆濠氬磼濞嗘帒鍘￠梺纭呮珪閹瑰洭骞冨ú顏勎╅柍鍝勫�告禍閬嶆⒑閸濆嫭鍌ㄩ柛銊ョ秺閹潡顢氶埀顒勫蓟閻旂厧绠查柟浼存涧濞堫厾绱撴担鎻掍壕闂佺鏈粙蹇旂濠婂懏鍠愮�广儱顦伴崑瀣磼閹绘帒顕RL.REQOP闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁逞屽墴閸┾偓妞ゆ帊绀侀崵顒�霉濠婂懎浠ф俊鍙夊姍閹瑩宕崟顐ょ崺闂備礁鎼ˇ浼村吹閿曞倸唯闁冲搫鍊婚崣鍡涙⒑缂佹ɑ绀�闁稿﹤婀遍埀?
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?>婵犵數濮烽弫鍛婃叏閻戝鈧倹绂掔�ｎ偅娅㈤梺鑺ッˇ顖炲汲闁秵鐓ラ柣鏃傜帛椤ュ绱撳鍜冭含妤犵偛鍟灒闁煎鍊楅悾浠嬫倵楠炲灝鍔存俊?515闂傚倷娴囬褍顫濋敃鍌︾稏濠㈣埖鍔栭崑銈夋煛閸モ晛小闁绘帒锕ョ换娑㈠幢濡櫣浠撮梺鎼炲妽缁诲牓寮诲澶婄厸濞达絽鎲″▓鍙夌箾鐎涙ê娈犻柛濠冪墱閹广垹鈽夐姀鐘殿吅闂佽绻戝鎸庣濠婂牜鏁嬮柨婵嗩槸缁狀噣鏌ら幁鎺戝姉闁归攱妞藉娲传閸曞灚歇濠电偛顦板ú婵嬪磹閹绢喗鈷掑ù锝呮贡濠�浠嬫煕婵犲啯绀�閾荤偞淇婇妶鍛伀濞存粈绮欏缁樻媴閸濆嫪缂撻梺绋挎唉娴滎剚绔熼弴銏╂晣闁绘ê鍟块崢褰掓⒑鐠恒劌鏋嶇紒顔界懃椤繐煤椤忓嫮顔囬柟鑹版彧缁插搫危閸儲鈷戞繛鑼额嚙楠炴帞绱掗懜闈涘摵闁靛棔绀侀～婵囷紣濠靛洦娅岄梻浣告啞濞诧箓宕滃☉銏犵闂傚牊绋堥弨鑺ャ亜閺冨倻鍙撴い蹇撴椤ユ碍銇勯幘璺盒ュ☉鎾崇Ч閺岋繝宕奸悤浣稿壔P2515_ReadByte闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熺�涙绠伴柤鏉挎健閺岀喖宕￠悜鍡樻櫆STAT闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熷▎陇顕уú锔锯偓鐢靛帶椤垽濡堕崪浣光枅閻庤娲忛崝鎴濐嚕閸洖绠ｉ柨婵嗘閸熷搫鈹戦敍鍕杭濞寸厧娲畷姗�顢旈崟鍨棧NSTAT闂傚倸鍊搁崐椋庢濮橆剦鐒界憸宥堢亱闂佸湱铏庨崰鏍不椤栫偞鐓�?
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?>闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇楀亾妞ゎ厼鐏濊灒闁兼祴鏅濋悡瀣⒑閸撴彃浜濇繛鍙夛耿瀹曟垿顢旈崼鐔哄幈闂佹枼鏅涢崯浼村箠閺囥垺鐓欏瀣閸樺瓨淇婇銏犳殭闁宠棄顦～婊堝幢閺囩喎浜濋梻鍌氬�风粈渚�顢樻禒瀣骇闁割煈鍣搴ㄦ煟鎼淬値娼愭繛鍙壣戠换娑欑節閸愌呯畾闂佸綊妫跨拋鏌ュ焵椤掑﹦鐣垫鐐差儏閳规垿宕堕妸褍灏嗙紓鍌氬�搁崐鎼佸磹閹间礁纾归柟闂寸缁愭鎱ㄥΟ鎸庣【缂佹劖顨嗘穱濠囧Χ閸涱厽娈ㄩ梺缁樺笒閿曘儳鎹㈠┑瀣棃婵炴垵宕崜閬嶆⒑缁嬫鍎忔い鎴濐樀瀵鈽夐姀鈩冩珕闁荤姴娲﹁ぐ鍐不瑜版帗鈷戦柤娴嬫櫅閸斿鈹戦悙璇ц含鐎殿喖顭锋俊鎼佸Ψ閵忊槅娼旀繝鐢靛仜濡瑩鏁嬮梺鍛婃尵閻�?闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏楣冩闁稿鍊濋弻?闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏楣冩闁稿鍊濋弻?闂傚倸鍊搁崐椋庢濮橆剦鐒界憸宥堢亱闂佸湱铏庨崰鏍不椤栫偞鐓�?
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?>闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇楀亾妞ゎ厼鐏濊灒闁兼祴鏅濋悡瀣⒑閸撴彃浜濇繛鍙夛耿瀹曟垿顢旈崼鐔哄幈濠电姴鐏氶崝鏍箟閻㈠ィSCTRL闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曚綅閸ヮ剦鏁囬柕蹇曞Х閿涚喖姊洪崷顓℃闁革綆鍣ｅ顐ｇ節閸ャ劎鍘搁梺鎼炲劗閺呮稑鏆╃紓渚�绠栫粻鏍不閺嶎厼钃熼柨婵嗩槸椤懘鏌ｅ▎灞戒壕闂佸憡姊圭粭娣㏕S闂傚倷娴囬褏鈧稈鏅犻、娆撳冀椤撶偟鐛ュ┑掳鍊愰崑鎾绘偂閵堝棛绡�闂傚牊渚楅崕蹇曠磼閳ь剟宕煎┑鍐╂杸闂佺鏈喊宥夊疮閻愮儤鐓曢幖杈剧磿鏁堥梺鍝勬湰閻╊垰顕ｉ幘顔嘉╅柕澶堝�楅惄搴繆閻愵亜鈧倝宕戦崱妯肩闁逞屽墴閺岋紕浠︾拠娴嬪亾濠靛棛鏆︽俊顖欒閸熷懏銇勯弮鍌涙珪缂佸鍔欏缁樻媴閼恒儳銆婇梺鍝ュУ閸旀瑥顕ｉ崨濠勭瘈婵﹩鍓涢鍡涙⒑?
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?>闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇楀亾妞ゎ厼鐏濊灒闁兼祴鏅濋悡瀣⒑閸撴彃浜濇繛鍙夛耿瀹曟垿顢旈崼鐔哄幈濠电姴鐏氶崝鏍箟椤ゆ卡nCTRL闂傚倸鍊峰ù鍥х暦閸偅鍙忕�规洖娲ㄩ惌鍡椕归敐鍫綈婵炲懐濮撮湁闁绘ê妯婇崕鎰版煕鐎ｅ吀閭柡灞剧洴閸╁嫰宕橀浣诡潔闂備焦妞块崢浠嬨�冩繝鍥ц摕闁绘柨鎲＄紞鍥煙鐟欏嫬濮﹂柛姘嚇濮婃椽宕烽鐐插箣闂佽　鍋撻弶鍫氭櫇缁犳棃鏌ｉ弬鍨倯闁哄懐顭堥湁闁绘ê妯婇崕蹇曠棯閹岀吋闁哄备鈧剚鍚嬮幖绮光偓鑼晼濠电偞鍨堕幐鍝ョ矓閻熼偊鍤曢柛顐ｆ礀闁卞洦鎱ㄥ鍡楀箺闁绘繃娲熷鐑樺濞嗘垹袦婵炲瓨绮岄悥鐓庮嚕鐠囨祴妲堥柕蹇曞Х閻嫰姊虹粙鎸庢拱缁炬澘绉归幃姗�宕卞☉娆屾嫼缂備礁顑堝▔鏇犵不閺屻儲鐓ラ柡鍥悘鑼偓娈垮櫘閸嬪嫰顢樻總绋挎そ濞达綀顫夐妴鍐煟鎼达絾鍤�閻庢凹鍓涢崚?闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎯х槣闁轰礁妫濋弻锝夋偐閹惰姤绁�1闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎯х槣闁轰礁妫濋弻锝夋偐閹惰姤绁�2闂傚倸鍊搁崐椋庢濮橆剦鐒界憸宥堢亱闂佸湱铏庨崰鏍不椤栫偞鐓�?
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?>闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇楀亾妞ゎ厼鐏濊灒闁兼祴鏅濋悡瀣⒑閸撴彃浜濇繛鍙夛耿瀹曟垿顢旈崼鐔哄幈濠电姴鐏氶崝鏍箟閻＄珱'SID闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏楣冩闁稿鍊濋弻锟犲醇閻斿嘲宓嗛梻鍌氬�搁崐椋庣矆娓氣偓楠炲鏁嶉崟顐㈢亰閻庡厜鍋撻柛鏇ㄥ墮娴犻亶姊洪崫鍕仼闁搞倕顑夊濠氬磼濞嗘垹鐛㈠┑鐐板尃閸忕偓绋戣灃闁告侗鍘鹃敍娆撴⒑娴兼瑧鍒伴柡鍫墮閻ｇ兘寮婚妷锔惧幐閻庡箍鍎遍崯顐ｄ繆閸ф鐓冪紓浣股戦埛鎰版煏閸パ冾伂缂佺姵鐩獮姗�寮堕幋顓涘亾濞戙垺鈷戦柛娑橈攻閻撱儵鎮楀鐓庡⒉闁诲繐鍟村铏圭磼濮楀牅绶甸梺鍝ュУ閻楃娀寮幘缁樺殟闁靛濡囬ˇ顕�姊洪棃娑欏闁告梹鐟ラ悾鐑芥晲閸℃绐為悗鍏夊亾濠电姴鍟伴妶顐︽⒒閸屾瑧绐旀繛浣冲泚鍥敇閵忕姷锛熼梺鍝勮閸庢娊宕ｉ弴鐔翠簻闁瑰搫绉堕崝宥夋煕濞嗗繒绠茬紒缁樼箞瀹曞綊顢曢敐鍛闂備礁鎲＄敮濠囧础閹惰棄钃熼柨婵嗩槸閸愨偓濡炪倖甯婇懗鍫曞Υ閹扮増鐓ｅù鍏肩懅缁夘噣鏌＄仦鐣屝у┑锛勫厴婵＄柉顧傜紒杈╁仧缁辨帞绱掗姀鐘蹭紟闂佺懓鍢查崲鏌ュ煘閹达附鍊烽柡澶嬪灩娴犳悂姊洪悷鐗堝暈闁诡喖鍊块妴渚�寮介鐐哄敹闂侀潧绻嗛埀顒�鍟跨花銉︾節绾版ɑ顫婇柛銊ゅ嵆瀹曘儳鈧綆鍠栫壕缁樹繆椤栨氨姣為柛瀣崌閹倿宕ㄦ繝鍌や紦闂傚倷绀侀幉鈥趁洪敃鍌氱；闁告洦鍘界亸搴ㄦ倵閿濆骸澧扮痪鍙ョ矙閺屾稓浠﹂幑鎰棟闂佸搫顑冮崐婵嬪蓟濞戙垺鍋愰柧蹇ｅ亜绾炬娊姊烘潪鎵妽闁圭懓娲ら锝夘敆閸曨倠褔鏌涢埄鍐炬濞�?
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?>闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇楀亾妞ゎ厼鐏濊灒闁兼祴鏅濋悡瀣⒑閸撴彃浜濇繛鍙夛耿瀹曟垿顢旈崼鐔哄幈濠电娀娼уú銊╂倿缂嶇劆SIDH闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁嶉崟顐㈢亰閻庡厜鍋撻柛鏇炵仛閺呫垽姊哄畷鍥у妺闁硅姤顒⊿IDL闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曚綅閸ヮ剦鏁囬柕蹇曞Х閿涚喖姊洪崷顓℃闁哥姵鑹鹃悾鍨瑹閳ь剟鎮￠锕�鐐婇柕濞р偓濡插牓姊哄ú璇插箺妞ゃ劌锕濠氬灳閹颁礁鎮戦柟鑲╄ˉ閳ь剝灏欓惄搴繆閻愵亜鈧垿宕曢弻銉ｂ偓鍐╃節閸パ呯暫濠德板�曢崯顖炲窗閸℃稒鐓曢柡鍥ュ妼婢х増绻涢崼娑樷偓鏇㈠煘閹达附鍊烽柤纰卞墮椤も偓闂備礁鎲￠…鍥ь焽閹惰姤鈷掗柛灞剧懅缁愭梹绻涙担鍐插悩濞戙垹绠绘い鏃囧亹椤斿棝姊�?
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?>闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇楀亾妞ゎ厼鐏濊灒闁兼祴鏅濋悡瀣⒑閸撴彃浜濇繛鍙夛耿瀹曟垿顢旈崼鐔哄幈濠电娀娼уú銊╂倿缂嶎湸SIDH闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁嶉崟顐㈢亰閻庡厜鍋撻柛鏇炵仛閺呫垽姊哄畷鍥у妺闁圭瓔妲楽IDL闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曚綅閸ヮ剦鏁囬柕蹇曞Х閿涚喖姊绘笟鍥у缂佸鏁诲畷鏇㈠箻缂佹鍘遍梺鏂ユ櫅閸熶即鍩婇弴銏″�垫慨姗嗗墾閸旂喓绱掓潏銊ユ诞妤犵偞鎹囬獮鎺戔攽閸ャ劍顏nSID闂傚倸鍊搁崐鐑芥倿閿曞倹鍎戠憸鐗堝笒缁�澶屸偓鍏夊亾闁告洦鍋勯幆鐐测攽鎺虫导鍥炊閵娿垺瀚奸梻鍌氬�搁悧濠勭矙閹烘鏅柡鍐ㄧ墛閻撴瑩鏌涢幋娆忊偓鏍偓?
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?>闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇楀亾妞ゎ厼鐏濊灒闁兼祴鏅濋悡瀣⒑閸撴彃浜濇繛鍙夛耿瀹曟垿顢旈崼鐔哄幈濠电姴锕ら幊蹇涱敁瀵ゆNTE闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曚綅閸ヮ剦鏁囬柕蹇曞Х閿涚喖姊绘笟鍥у缂佸顕划璇差潩鐠鸿櫣顔愬┑鐑囩秵閸撴瑦淇婃禒瀣厱閻庯絻鍔屾慨鍌炴煛鐏炵偓绀冪紒缁樼箚缁犳盯寮撮悩铏啅闂傚倷娴囬褏鎹㈤幋锔衡偓鍐醇閵忊槅娼熼梺鍦劋椤ㄥ懐澹曢崗鑲╃闁糕剝锚缁楁帡鏌涘鍫㈢瘈婵﹦鍎ゅ顏呭鐎涙﹩鈧牠姊虹粙鍖℃敾闁绘绮庨崚鎺戔枎閹邦剛绐為梺瑙勬緲閻忔岸寮查敐澶嬧拺缂備焦蓱閻撱儵鏌熼懞銉х煉鐎规洘绻堥幃婊堟嚍閵夈垺瀚奸梻鍌氬�搁悧濠勭矙閹烘鏅柡鍐ㄧ墛閻撴瑩鏌涢幋娆忊偓鏍偓?
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?0>闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄粓宕橀埀顒�顪冮妶鍡樺暗闁稿鍠栬棟妞ゆ劧闄勯埛鎴犵磽娴ｇ櫢渚涙繛鍫熸閺岋絽螖娴ｈ櫣鐓夐悗瑙勬礃缁诲牓寮幘瀵割浄閻庯綆鍋嗛崢浠嬫⒑闂堟稓绠氶柡鍛洴閹﹢鎮╃紒妯煎幍闂佺粯纰嶉崵搴ㄥ磹閺囥垹姹查柣鎰劋閻撶喖骞栧ǎ顒�鐒洪柛鐔风箻閺屾盯鎮╁畷鍥ь潷濡炪們鍔婇崕瀵哥不濞戙垹鍗抽柣鏇氱劍缂嶆绻濋悽闈涒枅婵炰匠鍥舵晞闁告侗鍨抽惌鍡涙煕閹板吀绨撮柛瀣崌閻涱噣宕归鐓庮潛婵犵妲呴崑鎺楀矗閸愩劎鏆﹂柟杈剧秵濡插吋绻涢敐鍛悙闁挎洦浜妴渚�寮撮姀鈺傛櫌婵炶揪绲芥竟濠冨閹剧粯鈷掗柛灞剧懅椤︼箓鏌熺喊鍗炰喊闁诡垰鐭傚畷鐓庘攽閹邦喒鍋撻崼鏇熺厽妞ゆ挻绋戦悘顪橳AT闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢妶鍌氫壕婵ê宕崢瀵糕偓瑙勬礉椤鈧潧銈稿鍫曞箣閻樺灚姣庢繝鐢靛仩閹活亞绱為埀顒併亜椤愩埄妲圭紒鍌氱Ч婵¤埖寰勭�ｎ剙骞愰梻浣侯焾閺堫剛绮欓幋锔绘晪婵犲﹤鎳愮壕濂告煃瑜滈崜鐔煎极閹剧粯瀵犲璺烘閺傗偓婵＄偑鍊栧濠氬疾椤愩倗涓嶉柟娈垮枤绾惧ジ妫呴顐㈠箻闁活厽鐟╅弻鐔碱敊閸濆嫬濮㈤梺鍦嚀鐎氼參骞忛崨鏉戝嵆闁绘ê寮堕悘鍫ユ⒑閹肩偛濡介柛搴㈠▕閹箖鎮滈挊澶屽�為梺鍐叉惈閿曘儵寮妶澶嬧拻闁稿本鐟х粣鏃�绻涙担鍐插悩濞戙垹绠绘い鏃囧亹椤斿棝姊�?
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?/
   */
    extern const Pin CAN_RstPin[];
    PIO_Set(&CAN_RstPin[0]);
    Djy_EventDelay(1*mS);
    PIO_Clear(&CAN_RstPin[0]);
    Djy_EventDelay(1*mS);
    PIO_Set(&CAN_RstPin[0]);
    Djy_EventDelay(1*mS);//缂傚倸鍊搁崐鐑芥嚄閸洘鎯為幖娣妼閻骞栧ǎ顒�濡肩紒鈧崒娑氱闁瑰鍊戝璺哄嚑閹兼番鍔嶉悡蹇涚叓閸ヮ灒鍫ュ磻閹惧磭鏆﹂柛銉㈡櫇瀹撲線姊虹拠鏌ヮ�楃紒鐘茬Ч瀹曟洘娼忛埞鎯т壕婵鍘ч弸銈囩磼椤旇姤顥堥柡?

    //缂傚倸鍊搁崐鎼佸磹閹间礁纾归柟闂寸劍閸嬪鏌熸导鏉戜喊闁轰礁顑囬幉鎼佸棘鐠恒劍娈鹃梺鍛婄箓鐎氼噣寮抽崱娑欑厱闁哄洢鍔屾晶浼存煕濡濮嶉柟顔筋殜閻涱噣宕归鐓庮潛婵犵數鍋涢惇浼村礉閹存繍鍤曢柟闂寸绾惧吋绻涢幋鐑嗘畼缂佺姵鑹鹃—鍐Χ閸℃瑥顫у銈冨妽閸旀瑩鐛箛鎾舵殝闁规鍠楀▓楣冩⒑閹肩偛鍔楅柡鍛櫊瀵�?/
    MCP2515_Reset();//闂傚倸鍊风粈渚�骞栭位鍥焼瀹ュ懐锛熼梺鍦濠㈡﹢宕归崒娑栦簻闁哄秲鍔岄悞褰掓煛鐎ｎ亪鍙勯柡灞炬礉缁犳稒绻涢幆褌澹曢悗瑙勬礀濞层劑鎮伴鈧弻锝嗘償閿涘嫮鏆涢梺绋挎唉娴滎剟鍩�椤掍礁鍤柛鐘虫皑閸掓帡寮崼鐔告?
    Djy_EventDelay(10*mS);
    dummy=MCP2515_ReadByte(Mcp2515_CANSTAT);

    if(4!=(dummy>>5))
    {
        printf("闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢敂钘変罕濠电姴锕ょ�氼噣銆呴弻銉︾叆婵犻潧妫欐径鍕偓瑙勬礀瀵爼骞堥妸銉庢梻鈧綆鍋勯鍫曟煟鎼淬値娼愭繛鍙夛耿閵嗗啯绻濋崘褏绠氶梺缁樺灱濡嫰鎮″☉妯忓綊鏁愰崱娆愭啓缂備椒绀侀顓犳閹捐纾兼慨姗嗗厴閸嬫捇骞栨担鍝ョ崶濠殿喗顭堝▔娑氱玻濡や焦鍙忔慨妤�妫楅獮妤呮煕濞嗗繒绠婚柡宀�鍠栧鑽も偓闈涘濡差喚绱撴担鍝勑ｉ柛銊ユ健瀵濡搁埡鍌氫簽闂佺鏈粙鎴︻敂?\r\n");
        return;
    }
    Djy_EventDelay(1*mS);

    MCP2515__SetBaudRate(Mcp2515_baudrate);
    /*
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?3 婵犵數濮烽弫鎼佸磻閻斿澶愬箛閺夎法锛涢梺褰掑亰閸樹粙宕ｈ箛娑欑厱闁圭偓顨呯�氱兘宕戦妸銉富闁靛牆妫欑亸闈涒攽椤曗偓椤ユ挻绔熼弴鐔侯浄閻庯綆鍋嗛崢鐢告⒑鐠団�崇�婚柛鎰ㄦ櫆閻︼綁姊绘担鍛婃儓婵☆偅绻冪粋宥夊醇閺囩偠鎽曞┑鐐村灟閸ㄥ綊宕橀埀顒�顪冮妶鍡楀闁搞劏顕ч埢鎾诲Χ閸モ晝锛濇繛杈剧稻閸ㄦ繈宕ラ锝囩闁告侗鍙庨弫妗�0闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎯х槣闁轰礁妫濋弻锝夋偐閹惰姤绁�1闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎯х槣闁轰礁妫濋弻锝夋偐閹惰姤绁�2
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?2 闂傚倸鍊搁崐宄懊归崶顒婄稏濠㈣泛顑囬々鎻捗归悩宸剰缁炬儳娼￠弻锛勪沪鐠囨彃濮庨梺鍝勵儎缁舵岸寮诲☉銏℃櫆閻犲洦褰冪粻鑽ょ磼閹冪稏缂侇喗鐟╁濠氭偄閻撳海鐣鹃悷婊冪Ч瀵娊鏌嗗鍡欏幐闂佺硶鍓濈粙鎰板箟妤ｅ啯鐓涢悘鐐插⒔濞插鈧鍠曠划娆撱�侀弴銏狀潊闁靛繆妲呴崥鍥╃磽閸屾艾鈧嘲霉閸ャ劎顩叉い鎺嗗亾闁宠绉瑰畷鐘电矆?闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎯х槣闁轰礁妫濋弻宥夋倻濡粯鍟�1
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?6 ID闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻涢幋鐐╂（婵炲樊浜濋弲婵嬫煕鐏炵偓鐨戞い鏂挎嚇濮婃椽妫冨☉姘暫濡炪倧瀵岄崹璺侯潖婵犳凹鏁嶆繛鎴炵墧缁ㄨ顪冮妶鍡樺暗闁哥姴娴风划顓☆槾缂佽鲸甯￠獮鍥敇濠ф儳浜鹃柡鍫㈡懛0闂傚倸鍊搁崐椋庢濮橆剦鐒界憸宥堢亱濠电偛妫欓幐濠氬磻閻斿吋鐓欐い鎺戜紖?
    闂傚倸鍊烽懗鍫曞储瑜嶉悾鐑筋敆閸曨剚娅㈤梺浼欑到閼活垶寮稿澶婄骇闁宠桨鑳剁粔娲煛鐏炶鈧繂鐣烽敓鐘冲�婚柛銉ｅ妼椤忓爼姊虹紒妯烩拹闁稿骸銈搁獮?2 ID闂傚倸鍊搁崐鐑芥嚄閸洏鈧焦绻濋崶顬儵鏌嶈閸撶喖寮婚敓鐘插窛妞ゆ柨澧介悿鍕⒑鐠団�虫灁闁稿酣浜堕垾锕傚Ω閳轰焦銇濋梺鍛婂姀閺呮盯顢旈崼鏇熲拻闁稿本姘ㄦ晶娑氱磼鐎ｎ偄鐏存い銏℃閸╋繝宕ㄩ鎯у箺闂佸湱鍎ゆ繛濠傜暦濠靛绠ｆ繝闈涚墛濞堥箖姊虹憴鍕姸鐞氭瑩鏌嶈閸撱劎绮婚幘鑽ゅ祦闁圭儤顨呯猾宥夋煕鐏炲墽鐭婇柣鎰殼XM0闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎯х槣闁轰礁妫濋弻宥夋倻濡粯鍣�1
    */
    //闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏇楀亾妞ゎ厼鐏濊灒闁兼祴鏅濋悡瀣⒑閸撴彃浜濇繛鍙夛耿瀹曟垿顢旈崼鐔哄幈濠电娀娼уú銊╂倿缂�?'闂傚倸鍊峰ù鍥敋瑜旈弻濠囨晲閸滀胶鍔烽悷婊冪箻閸┾偓妞ゆ帊绀侀崵顒勬煕閹捐泛鏋涙鐐插暙鐓ゆい蹇撳珋閳哄懏鐓冮弶鐐村缁愭梹淇婇銈呭幋婵﹨娅ｉ幑鍕Ω閵夛妇褰氶梻?
    MCP2515_WriteReg(Mcp2515_RXB0CTRL,0x60);//闂傚倸鍊搁崐宄懊归崶顒婄稏濠㈣泛顑囬々鎻捗归悩宸剰缁炬儳娼￠弻锛勪沪鐠囨彃濮庨梺鍝勵儎閼冲爼骞夐幖浣瑰亱闁割偅绻勯悷銊х磽娴ｅ搫鐝￠柛銉ｅ妿閸橆亝绻濋姀锝嗙【闁绘妫欐穱濠囧礂閼测晝顔曢梺鍓插亖閸ㄦ椽顢撻幈濉忛梻鍌氬�搁崐宄懊归崶顒夋晪闁哄稁鍘肩粈鍫熺節闂堟稒顥犻柡鍡畵閺岋綁濮�閵忊晝鍔搁梺鍛婅壘缂嶅﹪鐛弽顬ュ酣顢楅埀顒佷繆娴犲鐓曢幖杈剧磿鏁堥梺鍝勬湰閻╊垰顕ｉ幘顔嘉╅柕澶堝労濞肩粯淇婇悙顏勨偓褏寰婃ィ鍐╁亗闁跨喓濮撮拑鐔兼煥閻斿搫孝闂佸崬娲︾换婵嬪垂椤愩垹顫嶇紒妤佸灴濮婄粯鎷呮笟顖涙暞濡炪倖姊归崝娆撶嵁?
    MCP2515_WriteReg(Mcp2515_RXB1CTRL,0x60);//闂傚倸鍊搁崐宄懊归崶顒婄稏濠㈣泛顑囬々鎻捗归悩宸剰缁炬儳娼￠弻锛勪沪鐠囨彃濮庨梺鍝勵儎閼冲爼骞夐幖浣瑰亱闁割偅绻勯悷銊х磽娴ｅ搫鐝￠柛銉ｅ妿閸橆亝绻濋姀锝嗙【闁绘妫欐穱濠囧礂閼测晝顔曢梺鍓插亖閸ㄦ椽顢撻幈濉忛梻鍌氬�搁崐宄懊归崶顒夋晪闁哄稁鍘肩粈鍫熺節闂堟稒顥犻柡鍡畵閺岋綁濮�閵忊晝鍔搁梺鍛婅壘缂嶅﹪鐛弽顬ュ酣顢楅埀顒佷繆娴犲鐓曢幖杈剧磿鏁堥梺鍝勬湰閻╊垰顕ｉ幘顔嘉╅柕澶堝労濞肩粯淇婇悙顏勨偓褏寰婃ィ鍐╁亗闁跨喓濮撮拑鐔兼煥閻斿搫孝闂佸崬娲︾换婵嬪垂椤愩垹顫嶇紒妤佸灴濮婄粯鎷呮笟顖涙暞濡炪倖姊归崝娆撶嵁?

    MCP2515_WriteReg(Mcp2515_RXM0SIDH,0x00);//Mask register//闂傚倸鍊峰ù鍥敋瑜忛幑銏ゅ箳濡も偓绾剧粯绻涢幋鐐殿暡鐎规洖寮舵穱濠囧Χ閸涱喖娅ｅ┑鈽嗗亝閿曘垽寮婚妸鈺傚亜闁告挷鑳堕悡鎾绘⒑鐠団�虫灍妞ゃ劌锕よ灋闁告劑鍔夊Σ鍫熸叏濡も偓濡棃骞冮敐澶嬧拻濞达絽澹婇崥鏃堟煛婢跺﹦浠㈡い顐㈡喘閹鎲撮崟顒傤槰婵犵數鍋涢敃顏勵嚕椤愶箑绠荤紓浣股戝▍銏ゆ⒑?
    MCP2515_WriteReg(Mcp2515_RXM0SIDL,0x00);//婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犱即鏌涘┑鍕姢闁活厽鎹囬弻鐔虹磼閵忕姵鐝梺杞扮椤戝棝濡甸崟顖氬嵆妞ゅ繐鎳庨鑸典繆閵堝洤啸闁稿绋撶划鏃囥亹閹烘垶鐎梺瑙勫劤椤曨參銆呴悜鑺ュ�甸柨婵嗙凹缁ㄥ鏌ｅ┑鍤挎垹鎹㈠┑瀣潊闁挎繂妫涢妴鎰渻閵堝繒鐣冲ù婊庡墰閸掓帡寮崒妤�浜鹃梻鍫熺♁閹插摜鐥崣銉х煓闁哄本鐩獮鍥敇閻愭彃袘闂備礁鎼鍥窗閺嶎厼钃熼柣鏃囧亹閸欐洟鏌熺紒妯哄潑闁稿鎹囧鎾閻橀潧骞掗梻浣告惈閸燁偊鎮ф繝鍥х柧闁归棿鐒﹂悡銉╂煟閺囩偛鈧湱鈧�?
    MCP2515_WriteReg(Mcp2515_RXM1SIDH,0x00);//Mask register//闂傚倸鍊峰ù鍥敋瑜忛幑銏ゅ箳濡も偓绾剧粯绻涢幋鐐殿暡鐎规洖寮舵穱濠囧Χ閸涱喖娅ｅ┑鈽嗗亝閿曘垽寮婚妸鈺傚亜闁告挷鑳堕悡鎾绘⒑鐠団�虫灍妞ゃ劌锕よ灋闁告劑鍔夊Σ鍫熸叏濡も偓濡棃骞冮敐澶嬧拻濞达絽澹婇崥鏃堟煛婢跺﹦浠㈡い顐㈡喘閹鎲撮崟顒傤槰婵犵數鍋涢敃顏勵嚕椤愶箑绠荤紓浣股戝▍銏ゆ⒑?
    MCP2515_WriteReg(Mcp2515_RXM1SIDL,0x00);//婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犱即鏌涘┑鍕姢闁活厽鎹囬弻鐔虹磼閵忕姵鐝梺杞扮椤戝棝濡甸崟顖氬嵆妞ゅ繐鎳庨鑸典繆閵堝洤啸闁稿绋撶划鏃囥亹閹烘垶鐎梺瑙勫劤椤曨參銆呴悜鑺ュ�甸柨婵嗙凹缁ㄥ鏌ｅ┑鍤挎垹鎹㈠┑瀣潊闁挎繂妫涢妴鎰渻閵堝繒鐣冲ù婊庡墰閸掓帡寮崒妤�浜鹃梻鍫熺♁閹插摜鐥崣銉х煓闁哄本鐩獮鍥敇閻愭彃袘闂備礁鎼鍥窗閺嶎厼钃熼柣鏃囧亹閸欐洟鏌熺紒妯哄潑闁稿鎹囧鎾閻橀潧骞掗梻浣告惈閸燁偊鎮ф繝鍥х柧闁归棿鐒﹂悡銉╂煟閺囩偛鈧湱鈧�?

     //Set the RXB0 or RXB1 interrupt enableling 闂傚倸鍊峰ù鍥х暦閸偅鍙忕�规洖娲ㄩ惌鍡椕归敐鍫綈婵炲懐濮撮湁闁绘ê妯婇崕鎰版煕鐎ｅ吀閭柡灞剧☉閳规垿宕堕埡鍐ㄥЪB0闂傚倸鍊搁崐鐑芥嚄閸洖绠犻柟鍓х帛閸嬨倝鏌曟繛鍨姷闁肩増瀵ч妵鍕Ψ瑜忛妴?婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犲綊鏌嶉崫鍕櫣闁稿被鍔岄湁闁绘ê妯婇崕蹇涙煢閸愵亜鏋涢柡灞剧洴婵＄兘鏁愰崨顓х�村┑鐘愁問閸ㄩ亶骞愰幎钘夎摕闁靛牆顦粻娑樏归敐鍛喐濞寸姭鏅犲娲川婵犲繐鍙曢梺?/
     //闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鑼槱閻熸粎澧楃敮鎺楀垂閸岀偞鐓欓柟顖滃椤ュ鏌＄�ｂ晝鍔嶉柕鍥у婵＄柉顦寸�殿喚绋�0闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熸潏鎯х槣闁轰礁妫濋弻宥夋倻濡粯鍟�1婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犲綊鏌嶉崫鍕櫣闁稿被鍔岄湁闁绘ê妯婇崕蹇涙煢閸愵亜鏋涢柡灞诲姂閹倝宕掑☉姗嗕紦
     //闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鑼槱閻熸粎澧楃敮鎺楀垂閸岀偞鐓欓柟顖滃椤ュ鏌＄�ｂ晝绐旈柡灞炬礋瀹曠厧鈹戦幇顓壯囨⒑缂佹ɑ灏柛搴ゅ皺閹广垹鈽夐姀鐘茶�垮┑鈽嗗灥濡椼劑宕氭繝鍥ㄢ拺闁硅偐鍋涢埀顒佺墵閹囧即閵忕姷鍙�婵犮垼鍩栭崝鏇犵不婵傚憡鐓曢柟鎵虫櫅婵¤偐绱掗悩铏仢婵﹥妞藉畷顐﹀礋椤旂⒈浼冩繝鐢靛仜濡﹪宕ｉ崘顭戝殨妞ゆ劑鍩勯崥瀣煕閵夘垶妾柛鏇炲暣濮婅櫣鎷犻垾宕囦紘闂佽绻戠换鍫ョ嵁濡偐纾兼俊顖滃帶楠炴劙姊绘担渚劸闁哄牜鍓涢崰濠傤吋婢跺﹦鐛ュ┑顔姐仜閸嬫捇鏌＄仦绋垮⒉闁瑰嘲鎳樺Λ鍐煛娴ｅ壊娼梻鍌欑缂嶅﹪藟閹惧绠鹃柍褜鍓氶妵鍕閿涘嫧妲堥梺瀹狀嚙闁帮綁鐛幒妤�绠ｆ繝闈涚墢閺嗙娀姊婚崒姘偓椋庣矆娓氣偓楠炴牠顢曢敃鈧壕璇测攽閻樺弶鎼愮紒鐙�鍨堕弻?
//     MCP2515_WriteReg(Mcp2515_CANINTE,Mcp2515_RX0IE|Mcp2515_RX1IE|Mcp2515_ERRIE|Mcp2515_MERRE);
    __MCP2515_CANINT_ENABLE();

     MCP2515_BitModify(Mcp2515_CANINTF,Mcp2515_RX0IF,0x00);//闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢妶鍥╃厠闂佸搫顦伴崵姘洪鍕幯囨煕閵夛絽濡奸幖鏉戯躬濮婃椽宕崟顐ｇ仌闂佸綊顥撻崗姗�寮婚悢椋庢殝闁绘鐗嗗▍锝咁渻閵堝棙灏柕鍫㈩焾閻ｇ兘宕￠悙鈺傜�诲┑鈽嗗灠濠�杈╃矚閸ф鈷掗柛灞捐壘閳ь剚鎮傚畷鎰矙鐠囩偓鐩獮姗�顢欓懖鈺婂數闂�?
     MCP2515_BitModify(Mcp2515_CANINTF,Mcp2515_RX1IF,0x00);
     MCP2515_BitModify(Mcp2515_CANINTF,Mcp2515_ERRIF,0x00);//闂傚倸鍊搁崐椋庣矆娓氣偓楠炴牠顢曢妶鍥╃厠闂佸搫顦伴崵姘洪鍕幯囨煕閵夛絽濡奸幖鏉戯躬濮婃椽宕崟顐ｇ仌闂佸綊顥撻崗姗�寮婚悢椋庢殝闁绘鐗嗗▍锝咁渻閵堝棙灏柕鍫㈩焾閻ｇ兘宕￠悙鈺傜�诲┑鈽嗗灠濠�杈╃矚閸ф鈷掗柛灞捐壘閳ь剚鎮傚畷鎰矙鐠囩偓鐩獮姗�顢欓懖鈺婂數闂�?
     MCP2515_BitModify(Mcp2515_CANINTF,Mcp2515_MERRF,0x00);

     MCP2515_WriteReg(Mcp2515_CANCTRL,Mcp2515_REQOP_NORMAL | Mcp2515_CLKOUT_ENABLED);//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌涘櫧闁活厽鐟╅弻鐔告綇閸撗呮殸闂佹椿鍘介〃濠囧蓟濞戙垹鐒洪柛鎰亾椤撶懓鈹戦悙鐑橈紵闁告濞婂濠氬Ω閵夈垺鏂�闂佺硶鍓濋敋婵炲憞鍥ㄢ拺缂侇垱娲樺▍鍡樸亜閵娿儲顥炵紒宀冮哺缁绘繈宕堕懜鍨珫婵犲痉鏉库偓鏇㈩敄閸℃瑢鍋撳顒佽础闁逞屽墲椤煤閺嶎灐娲Ω閳瑰簱鍋�?
     dummy=MCP2515_ReadByte(Mcp2515_CANSTAT);
        if (Mcp2515_OPMODE_NORMAL != (dummy & 0xE0))
          MCP2515_WriteReg(Mcp2515_CANCTRL,Mcp2515_REQOP_NORMAL | Mcp2515_CLKOUT_ENABLED);//If normal ok

        if(0==dummy>>5)
        {
            printf("mode normal.\r\n");
        }
}

//----闂傚倸鍊峰ù鍥敋瑜忛幑銏ゅ箛椤旇棄搴婇梺鍦濠㈡绮昏ぐ鎺撶厽闁挎稑瀚幖?515闂傚倸鍊峰ù鍥х暦閸偅鍙忛柟鎯板Г閸婂潡鏌ㄩ弴鐐测偓鍝ュ閸ф鐓欓悹鍝勬惈椤ョ偤鏌涢妷顔煎⒒闁轰礁妫濋弻娑㈠即閵娿儰绨藉銈嗘煥濞差厼顫忛搹鍦煓闁圭瀛╅幏杈╃磽娴ｅ壊鍎愰柛銊ㄦ硾椤曘儵宕熼顐㈡倯婵犮垼娉涢鍥储闁秵鈷戦柛锔诲幖閸斿鎱ㄦ繝鍌滅Ш闁诡喚鏁诲鐢告偆閻戞拷S婵犵數濮烽弫鎼佸磻閻愬搫鍨傞柛顐ｆ礀缁犺銇勯幇鍓佺暠缂佺媭鍨堕弻?--------------------------------------------------------
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鍨鹃幇浣圭稁婵犵數濮甸懝鍓х玻濡ゅ懏鐓涢柛銉ｅ劚閻忊晝绱掗埀顒勫磼閻愬鍙嗛梺缁樻礀閸婂湱鈧�?
//闂傚倸鍊搁崐椋庣矆娓氣偓楠炲鏁撻悩鍐蹭画闂侀潧顦弲娑氬閸︻厽鍠愰柣妤�鐗嗙粭鎺撴叏鐟欏嫮鍙�闁哄被鍔戦幃銈夊磼濞戞﹩浼�: BusName闂傚倸鍊搁崐鐑芥倿閿旈敮鍋撶粭娑樻噽閻瑩鏌熼悜妯荤叆闁哄鐗忛埀顒�绠嶉崕閬嵥囨导鏉戠柧闁归棿鐒﹂悡鏇炩攽閻樻彃顏╅柡瀣叄閺屾稑顫濋鍌溞ㄩ梺鍝勬湰閻╊垱淇婇崼鏇炲窛闁哄鍨甸崣濠囨煟鎼淬値娼愭繛鎻掔箻瀹曟洟鏌嗗搴㈡櫍婵犻潧鍊婚…鍫ユ倷婵犲洦鐓曢柍钘夋楠炴鎮�?
//
//闂傚倸鍊风粈渚�骞栭位鍥敃閿曗偓閻ょ偓绻濇繝鍌滃闁藉啰鍠栭弻鏇熺箾閸喖澹勫┑鐐叉▕娴滄繈寮查幖浣圭叆? 闂傚倸鍊搁崐鐑芥嚄閸洖绠犻柟鍓х帛閸嬨倝鏌曟繛鐐珔缂佲偓婢舵劖鐓涢柛銉㈡櫅閺嬫垿鏌涘▎蹇曠缂佺粯鐩獮瀣枎韫囨洑鎮ｇ紓鍌欒閸嬫捇鏌涢埄鍐剧劷缂佲檧鍋撻梻鍌氬�搁悧濠勭矙閹烘鏅�广儱妫涚粻楣冩煕韫囨洍鎷℃繛鍫熺矒閺岋紕浠﹂崜褎鍒涢悗娈垮枙缁瑦淇婂宀婃Щ闂佹剚浜滅紞濠傤潖濞差亜绀堥柤纰卞墮鐢儵姊洪幖鐐插鐎规洦鍓熼垾锕傚炊閵娧呯槇濠殿喗锕╅崜姘端夊┑瀣拺闁革富鍙庨悞鐐箾鐎电鍘撮挊婵囥亜瑜忛惃顩沞,婵犵數濮烽弫鍛婃叏娴兼潙鍨傛繛宸簻绾惧潡鏌ゅù瀣珔闁搞劍绻堥弻娑㈠箻濡も偓鐎氼剟寮搁崒鐐粹拺闁圭瀛╃粈鈧梺绋匡工閹芥粎鍒掗崼銉ュ耿婵☆垵鍋愰鏇㈡⒑缁洖澧查柨姘辩磼濡烇箑鎳愮壕濂告煟濡櫣锛嶉柛娆屽亾闂備礁鎼張顒勬儎椤栨稐绻嗛柣銈庡灱濡绢亪姊洪悷鏉挎Щ闁搞垺鐓￠、娆掔疀濞戞锛濋梺娲讳簼椤�?
//-----------------------------------------------------------------------------
bool_t ModuleInstall_MCP2515(char *BusName,u32  baudrate)
{
    uint16_t evtt_id,event_id;
    struct CanDev Dev;
    struct CANBusCB * NewCANBus;

    if(NULL == Lock_SempCreate_s(&s_MCP2515_Semp,1,1,CN_BLOCK_FIFO,"MCP2515_semp"))
            return false;
        /* setup baud rate */
    s_MCP2515_Dev.AutoCs = false;
    s_MCP2515_Dev.CharLen = 8;
    s_MCP2515_Dev.Cs = 0;
    s_MCP2515_Dev.Freq = MCP2515_SPI_SPEED;
    s_MCP2515_Dev.Mode = SPI_MODE_0;
    s_MCP2515_Dev.ShiftDir = SPI_SHIFT_MSB;

    //if(NULL != SPI_DevAdd_s(&s_MCP2515_Dev,BusName,"MCP2515"))
    if(NULL != SPI_DevAdd(BusName,"MCP2515",0,8,SPI_MODE_0,SPI_SHIFT_MSB,MCP2515_SPI_SPEED,false))
    {
        SPI_BusCtrl(&s_MCP2515_Dev,CN_SPI_SET_POLL,0,0);
        sMCP2515Inited=true;
    }

    Mcp2515_baudrate=baudrate;

    Dev.CanCtrl=MCP2515_Ctrl;
    Dev.CanWrite=MCP2515_Write;
    Dev.ChipName="MCP2515";
    Dev.BaudRate=baudrate;
    Dev.PrivateTag=0;

    NewCANBus=CAN_BusAdd(&Dev);
    if(NewCANBus==NULL)
    {
        printf("CANBUS:MCAN1 Add failed.\r\n");
        return false;
    }
    p_MCP2515_CBHandle=NewCANBus;

    printf("CAN install OK.\r\n");
    return sMCP2515Inited;
}
